<template>
  <div class="mind-painting-container">
    <!-- ç»˜ç”»æ¨¡å¼é€‰æ‹©ç•Œé¢ -->
    <div v-if="showModeSelection" class="mode-selection-container">
      <div class="page-header">
        <button class="back-button" @click="goBack">
          <span class="back-icon">â†</span>
          è¿”å›ä¸»ç•Œé¢
        </button>
        <h1>å¿ƒçµç”»è¯­</h1>
      </div>

      <h2 class="mode-selection-title">é€‰æ‹©ç»˜ç”»æ¨¡å¼</h2>

      <div class="mode-options">
        <!-- ä¸»é¢˜ç»˜ç”»æ¨¡å¼ -->
        <div class="mode-card" @click="selectPaintingMode('themed')">
          <div class="mode-icon">ğŸ¨</div>
          <h3>ä¸»é¢˜ç»˜ç”»</h3>
          <p class="mode-description">æä¾›ä¸å¤§å­¦ç”Ÿæ´»ç´§å¯†ç›¸å…³çš„ä¸»é¢˜ï¼Œå¸®åŠ©æ‚¨èšç„¦è¡¨è¾¾ç‰¹å®šæƒ…ç»ªå’Œæƒ³æ³•ã€‚</p>
          <div class="mode-examples">
            <p>æ¨èä¸»é¢˜ç¤ºä¾‹ï¼š</p>
            <ul>
              <li>â€¢ ç”»ä¸‹ä½ æœ€è¿‘çš„å‹åŠ›æº</li>
              <li>â€¢ æç»˜ä½ å¿ƒä¸­çš„ç†æƒ³å®¿èˆå…³ç³»</li>
              <li>â€¢ ä¸ºä½ çš„æœªæ¥æ¶‚ä¸Šé¢œè‰²</li>
              <li>â€¢ ç”»ä¸€å¹…ä»£è¡¨ä½ æœŸæœ«è€ƒè¯•å¿ƒæƒ…çš„ç”»</li>
              <li>â€¢ ç”»å‡ºä½ æœ€å–œæ¬¢çš„å­¦ä¹ è§’è½</li>
              <li>â€¢ ç”¨è‰²å½©è¡¨è¾¾ä½ å’Œæœ‹å‹çš„å…³ç³»</li>
            </ul>
          </div>
        </div>

        <!-- è‡ªç”±ç»˜ç”»æ¨¡å¼ -->
        <div class="mode-card" @click="selectPaintingMode('free')">
          <div class="mode-icon">ğŸŒˆ</div>
          <h3>è‡ªç”±ç»˜ç”»</h3>
          <p class="mode-description">å®Œå…¨è‡ªç”±åˆ›ä½œï¼Œä¸å—ä»»ä½•ä¸»é¢˜é™åˆ¶ï¼Œè®©æ‚¨çš„çµæ„Ÿè‡ªç„¶æµéœ²ï¼Œè¡¨è¾¾å½“ä¸‹å¿ƒå¢ƒã€‚</p>
          <div class="mode-examples">
            <p>é€‚åˆåœºæ™¯ï¼š</p>
            <ul>
              <li>â€¢ é‡Šæ”¾å†…å¿ƒæƒ…ç»ª</li>
              <li>â€¢ è‡ªç”±å‘æŒ¥åˆ›é€ åŠ›</li>
              <li>â€¢ å†¥æƒ³åçš„å¿ƒçµè¡¨è¾¾</li>
              <li>â€¢ éšæ„æ¶‚é¸¦æ”¾æ¾å¿ƒæƒ…</li>
            </ul>
          </div>
        </div>

        <!-- æˆ¿æ ‘äººæµ‹è¯•æ¨¡å¼ -->
        <div class="mode-card" @click="selectPaintingMode('htp')">
          <div class="mode-icon">ğŸ </div>
          <h3>æˆ¿æ ‘äººæµ‹è¯• (HTP)</h3>
          <p class="mode-description">å°†ç»å…¸ç»˜ç”»å¿ƒç†æµ‹éªŒæ•°å­—åŒ–ï¼Œé€šè¿‡ç»˜åˆ¶æˆ¿å±‹ã€æ ‘æœ¨å’Œäººç‰©ï¼Œç”±AIè¿›è¡Œæ ‡å‡†åŒ–åˆ†æã€‚</p>
          <div class="mode-examples">
            <p>æµ‹è¯•è¯´æ˜ï¼š</p>
            <ul>
              <li>â€¢ è¯·åœ¨åŒä¸€å¼ ç”»å¸ƒä¸Šç»˜åˆ¶æˆ¿å­ã€æ ‘å’Œäºº</li>
              <li>â€¢ æŒ‰ç…§æ‚¨å†…å¿ƒçš„æƒ³æ³•è‡ªç”±ç»˜åˆ¶</li>
              <li>â€¢ AIå°†åˆ†æå›¾åƒä¸­çš„è±¡å¾å…ƒç´ </li>
              <li>â€¢ æä¾›æ›´ä¸“ä¸šçš„å¿ƒç†å‚è€ƒè¯„ä¼°</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- ä¸»é¢˜é€‰æ‹©ç•Œé¢ -->
    <div v-else-if="showThemeSelection" class="theme-selection-container">
      <div class="page-header">
        <button class="back-button" @click="showThemeSelection = false; showModeSelection = true">
          <span class="back-icon">â†</span>
          è¿”å›æ¨¡å¼é€‰æ‹©
        </button>
        <h1>å¿ƒçµç”»è¯­</h1>
      </div>

      <h2 class="theme-selection-title">é€‰æ‹©ç»˜ç”»ä¸»é¢˜</h2>
      <p class="theme-selection-subtitle">è¯·é€‰æ‹©ä¸€ä¸ªä¸»é¢˜ï¼Œå¸®åŠ©æ‚¨èšç„¦è¡¨è¾¾ç‰¹å®šçš„æƒ…ç»ªå’Œæƒ³æ³•ï¼š</p>

      <div class="theme-options">
        <div
          v-for="theme in themeOptions"
          :key="theme.text"
          class="theme-card"
          @click="selectTheme(theme.text)"
        >
          <div class="theme-icon">{{ theme.emoji }}</div>
          <p class="theme-text">{{ theme.text }}</p>
        </div>
      </div>
    </div>

    <!-- ç”»å¸ƒåˆ—è¡¨ç•Œé¢ -->
    <div v-else-if="showCanvasList" class="canvas-list-container">
      <div class="page-header">
        <button class="back-button" @click="showCanvasList = false; showModeSelection = true">
          <span class="back-icon">â†</span>
          è¿”å›æ¨¡å¼é€‰æ‹©
        </button>
        <h1>å¿ƒçµç”»è¯­</h1>
      </div>

      <div class="canvas-list-header">
        <h2>æˆ‘çš„ç”»å¸ƒ</h2>
        <button class="new-canvas-button" @click="createNewCanvas">åˆ›å»ºæ–°ç”»å¸ƒ</button>
      </div>

      <div class="canvas-grid" v-if="filteredCanvases.length > 0">
        <div v-for="canvas in filteredCanvases" :key="canvas.id" class="canvas-item">
          <div class="canvas-thumbnail" @click="loadCanvas(canvas.id)">
            <img :src="canvas.thumbnail" alt="ç”»å¸ƒç¼©ç•¥å›¾" />
            <div class="canvas-name">{{ canvas.name }}</div>
          </div>
          <div class="canvas-actions">
            <button class="rename-button" @click.stop="showRenameDialog(canvas)">é‡å‘½å</button>
            <button class="delete-button" @click.stop="deleteCanvas(canvas.id)">åˆ é™¤</button>
          </div>
        </div>
      </div>

      <div v-else class="no-canvases">
        <p>æ‚¨è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•{{ currentPaintingMode === 'themed' ? 'ä¸»é¢˜ç”»' : currentPaintingMode === 'htp' ? 'æˆ¿æ ‘äººæµ‹è¯•' : 'è‡ªç”±åˆ›ä½œ' }}</p>
        <button class="new-canvas-button" @click="createNewCanvas">åˆ›å»ºç¬¬ä¸€ä¸ªç”»å¸ƒ</button>
      </div>
    </div>

    <!-- ç»˜ç”»ç•Œé¢ -->
    <div v-else class="painting-container">
      <div class="page-header">
        <button class="back-button" @click="showCanvasList = true; stopGuidanceSpeech()">
          <span class="back-icon">â†</span>
          è¿”å›ç”»å¸ƒåˆ—è¡¨
        </button>
        <h1>å¿ƒçµç”»è¯­</h1>
        <div class="canvas-info">
          <span class="canvas-name-display">{{ currentCanvasName }}</span>
          <button class="rename-button-small" @click="showRenameDialog({id: currentCanvasId, name: currentCanvasName})">
            {{ isDefaultName ? 'å‘½å' : 'é‡å‘½å' }}
          </button>
        </div>
      </div>

      <p>é€šè¿‡ç»˜ç”»è¡¨è¾¾æ‚¨çš„æƒ…ç»ªï¼ŒAI å°†ä¸ºæ‚¨åˆ†æã€‚</p>

      <div class="canvas-area">
        <!-- ç”»ç¬”å·¥å…·æ ç§»åˆ°ç”»å¸ƒä¸Šæ–¹ -->
        <div class="tool-bar">
          <!-- ç”»ç¬”ç±»å‹é€‰æ‹© -->
          <div class="tool-section">
            <label>ç”»ç¬”ç±»å‹:</label>
            <div class="brush-type-buttons">
              <button :class="['brush-button', { active: currentTool === 'brush' && brushType === 'normal' }]" @click="selectTool('brush', 'normal')">æ™®é€šç¬”</button>
              <button :class="['brush-button', { active: currentTool === 'brush' && brushType === 'pen' }]" @click="selectTool('brush', 'pen')">é’¢ç¬”</button>
              <button :class="['brush-button', { active: currentTool === 'brush' && brushType === 'watercolor' }]" @click="selectTool('brush', 'watercolor')">æ°´å½©ç¬”</button>
              <button :class="['brush-button', { active: currentTool === 'brush' && brushType === 'pencil' }]" @click="selectTool('brush', 'pencil')">é“…ç¬”</button>
            </div>
          </div>

          <!-- æ©¡çš®æ“¦å·¥å…· -->
          <div class="tool-section">
            <label>æ©¡çš®æ“¦:</label>
            <div class="eraser-buttons">
              <button :class="['eraser-button', { active: currentTool === 'eraser' }]" @click="selectTool('eraser')">æ©¡çš®æ“¦</button>
              <select v-model="eraserType" class="eraser-type-select">
                <option value="pixel">æ“¦é™¤åƒç´ </option>
                <option value="stroke">æ“¦é™¤æ•´ç¬”</option>
              </select>
            </div>
          </div>

          <!-- é¢œè‰²å’Œå¤§å°æ§åˆ¶ -->
          <div class="tool-section">
            <label>é¢œè‰²:</label>
            <input type="color" v-model="currentColor" />
          </div>

          <div class="tool-section">
            <label>ç²—ç»†: {{ brushSize }}</label>
            <input type="range" min="1" max="30" v-model="brushSize" />
          </div>

          <!-- æ“ä½œæŒ‰é’® -->
          <div class="tool-section">
            <button class="action-button" @click="undo" :disabled="history.length === 0">æ’¤å›</button>
            <button class="action-button" @click="clearCanvas">æ¸…ç©ºç”»å¸ƒ</button>
            <button class="action-button" @click="saveCanvas">ä¿å­˜ç”»å¸ƒ</button>
            <button class="action-button" @click="analyzeDrawing">åˆ†æç»˜ç”»</button>
          </div>
        </div>

        <!-- ç”»å¸ƒæ”¾åœ¨å·¥å…·æ ä¸‹æ–¹ -->
        <canvas ref="drawingCanvas" @mousedown="startDrawing" @mousemove="draw" @mouseup="stopDrawing" @mouseleave="stopDrawing"></canvas>
      </div>
      
      <!-- ç»˜ç”»æç¤ºåŒºåŸŸ -->
      <div v-if="showPaintingPrompt && paintingPrompt" class="painting-prompt">
        {{ paintingPrompt }}
      </div>

      <!-- æ“ä½œæŒ‰é’® - ç§»åŠ¨åˆ°ç”»å¸ƒä¸‹æ–¹ï¼Œåˆ†ææŠ¥å‘Šä¸Šæ–¹ -->
      <!-- æŒ‰é’®å·²ç§»åˆ°è‰ºæœ¯ç–—æ„ˆå°æ•…äº‹ä¹‹å‰ -->

      <div v-if="analysisResult" class="analysis-result">
        <h2>ç ”å¿ƒåˆä¸€ - å¿ƒçµç”»è¯­åˆ†ææŠ¥å‘Š</h2>
        
        <!-- æ¦‚è§ˆéƒ¨åˆ† -->
        <div class="analysis-overview">
          <div class="stress-meter">
            <h3>å‹åŠ›æ°´å¹³è¯„ä¼°</h3>
            <div class="stress-index-container">
              <div class="stress-index-value" :class="getStressLevelClass(analysisResult.stressLevel)">
                {{ Number(analysisResult.stressIndex).toFixed(1) }}/10.0
              </div>
              <div class="stress-level-label">{{ analysisResult.stressLevel }}</div>
            </div>
          </div>
          
          <div class="painting-info">
            <h3>ç»˜ç”»ä¿¡æ¯</h3>
            <p><strong>ç»˜ç”»æ¨¡å¼:</strong> {{ currentPaintingMode === 'htp' ? 'æˆ¿æ ‘äººæµ‹è¯•' : currentPaintingMode === 'themed' ? 'ä¸»é¢˜ç»˜ç”»' : 'è‡ªç”±ç»˜ç”»' }}</p>
            <p><strong>ç»˜ç”»æ—¶é•¿:</strong> {{ analysisResult.detailedAnalysis?.paintingTime?.toFixed(1) || 0 }}ç§’</p>
            <p><strong>æäº¤æ—¶é—´:</strong> {{ getTimeCategoryText(analysisResult.detailedAnalysis?.timeAnalysis?.category) }}</p>
          </div>
        </div>
        
        <!-- å¿ƒç†ç”»åƒ -->
        <div class="personality-portrait">
          <h3>ä¸ªæ€§åŒ–å¿ƒç†ç”»åƒ</h3>
          <div class="portrait-content">
            <!-- åªæ˜¾ç¤ºå†…å®¹æè¿°ï¼Œç§»é™¤æ ‡é¢˜ -->
            <div v-if="analysisResult.moodDescription">
              <p>{{ analysisResult.moodDescription }}</p>
            </div>
          </div>
        </div>
        
        <!-- æƒ…ç»ªé›·è¾¾å›¾ -->
        <div class="mood-radar-section">
          <h3>æƒ…ç»ªç»´åº¦é›·è¾¾å›¾</h3>
          <div class="mood-radar-chart">
            <div class="radar-container">
              <canvas id="moodRadarChart"></canvas>
            </div>
          </div>
        </div>
        
        <!-- å¤šç»´åº¦åˆ†ææ¨¡å— - ä¼˜åŒ–å±•ç¤º -->
        <div class="detailed-analysis">
          <h3>å¤šç»´åº¦åˆ†æè¯¦æƒ…</h3>
          
          <div class="analysis-grid">
            <!-- è‰²å½©æƒ…æ„Ÿåˆ†æ -->
            <div class="analysis-card card-color">
              <div class="card-header">
                <div class="card-icon">ğŸ¨</div>
                <h4>è‰²å½©æƒ…æ„Ÿåˆ†æ</h4>
              </div>
              <div class="analysis-content-improved" v-html="formatMarkdownAnalysis(analysisResult.aiAnalysis?.colorAnalysis || generateColorAnalysis(analysisResult.detailedAnalysis?.colorAnalysis))">
              </div>
            </div>
            
            <!-- ç¬”è§¦åŠ¨åŠ›å­¦åˆ†æ -->
            <div class="analysis-card card-brush">
              <div class="card-header">
                <div class="card-icon">âœï¸</div>
                <h4>ç¬”è§¦åŠ¨åŠ›å­¦åˆ†æ</h4>
              </div>
              <div class="analysis-content-improved" v-html="formatMarkdownAnalysis(analysisResult.aiAnalysis?.strokeAnalysis || generateBrushAnalysis(analysisResult.detailedAnalysis?.strokeAnalysis))">
              </div>
            </div>
            
            <!-- æ„å›¾ä¸ç©ºé—´åˆ†æ -->
            <div class="analysis-card card-composition">
              <div class="card-header">
                <div class="card-icon">ğŸ–¼ï¸</div>
                <h4>æ„å›¾ä¸ç©ºé—´åˆ†æ</h4>
              </div>
              <div class="analysis-content-improved" v-html="formatMarkdownAnalysis(analysisResult.aiAnalysis?.compositionAnalysis || generateCompositionAnalysis(analysisResult.detailedAnalysis?.compositionAnalysis))">
              </div>
            </div>
          </div>
          
          <!-- é’ˆå¯¹æ€§å»ºè®®éƒ¨åˆ† -->
          <div v-if="analysisResult.aiAnalysis?.suggestions" class="suggestions-section">
            <h4>ğŸ’¡ é’ˆå¯¹æ€§å»ºè®®</h4>
            <div class="suggestions-content">
              {{ analysisResult.aiAnalysis.suggestions }}
            </div>
          </div>
        </div>
        
        <!-- æ“ä½œæŒ‰é’®ç§»åˆ°è‰ºæœ¯ç–—æ„ˆå°æ•…äº‹ä¹‹å‰ - æ·»åŠ æ˜æ˜¾è¾¹æ¡† -->
        <div v-if="analysisResult" class="analysis-actions highlighted-section">
          <button class="action-button" @click="generateIntervention" :disabled="isGeneratingMindMirror">
          ç”Ÿæˆå¿ƒçµé•œåƒ
          <span v-if="isGeneratingMindMirror">â³</span>
        </button>
          <button class="action-button" @click="generateAndPlayMindfulnessGuidance" :disabled="isGeneratingGuidance">
            {{ isPlayingGuidance ? 'æš‚åœè¯­éŸ³å¼•å¯¼' : 'è¯­éŸ³ç»˜ç”»å¼•å¯¼' }}
            <span v-if="isPlayingGuidance">â¸ï¸</span>
            <span v-else-if="isGeneratingGuidance">â³</span>
          </button>
          <button class="action-button" @click="generateHealingStory" :disabled="isGeneratingStory">
            ç”Ÿæˆç–—æ„ˆå°æ•…äº‹
            <span v-if="isGeneratingStory">â³</span>
          </button>
          <button class="action-button" @click="goBack">è¿”å›ä¸»é¡µ</button>
        </div>
        
        <!-- å¿ƒçµé•œåƒå¯¹è¯æ¡† -->
        <div v-if="showMindMirrorDialog" class="modal-overlay" @click="closeMindMirrorDialog">
          <div class="mind-mirror-modal" @click.stop>
            <div class="modal-header">
              <h3>ğŸŒŸ å¿ƒçµé•œåƒ</h3>
              <button class="close-button" @click="closeMindMirrorDialog">Ã—</button>
            </div>
            
            <div class="modal-content">
              <div class="mind-mirror-container">
                <!-- åŸå§‹ç”»ä½œé¢„è§ˆ -->
                <div class="painting-comparison">
                  <div class="painting-item">
                    <h4>åŸå§‹ç”»ä½œ</h4>
                    <div class="painting-preview">
                      <canvas v-if="drawingCanvas.value" ref="originalPaintingPreview" width="300" height="250"></canvas>
                    </div>
                  </div>
                  
                  <div class="arrow-icon">â†’</div>
                  
                  <!-- ç§¯æç‰ˆæœ¬ -->
                  <div class="painting-item">
                    <h4>ç§¯æç‰ˆæœ¬</h4>
                    <div class="painting-preview">
                      <canvas v-if="drawingCanvas.value" ref="positivePaintingPreview" width="300" height="250"></canvas>
                    </div>
                  </div>
                </div>
                
                <!-- å¼•å¯¼è¯­ -->
                <div class="guidance-text">
                  <div class="guidance-icon">ğŸ’¡</div>
                  <p>{{ mindMirrorResult?.guidance_text || 'æ­£åœ¨ç”Ÿæˆå¼•å¯¼è¯­...' }}</p>
                </div>
                
                <!-- ç§¯æç‰ˆæœ¬æè¿° -->
                <div class="positive-image-description">
                  {{ mindMirrorResult?.positive_image_description || 'æ­£åœ¨ç”Ÿæˆç§¯æç‰ˆæœ¬æè¿°...' }}
                </div>
                
                <!-- åæ€é—®é¢˜ -->
                <div class="reflection-section">
                  <h4>ğŸ” æ€è€ƒä¸€ä¸‹</h4>
                  <p>è§‚å¯Ÿè¿™ä¸¤ç§ç‰ˆæœ¬çš„ç”»é¢ï¼Œä½ è§‰å¾—æƒ…ç»ªä¸Šæœ‰ä»€ä¹ˆä¸åŒçš„æ„Ÿå—ï¼Ÿ</p>
                  <p>åœ¨ç”Ÿæ´»ä¸­ï¼Œä½ å¯ä»¥å¦‚ä½•å¼•å…¥è¿™æ ·çš„"ç§¯æè§†è§’"æ¥çœ‹å¾…æŒ‘æˆ˜ï¼Ÿ</p>
                </div>
              </div>
            </div>
            
            <div class="modal-footer">
              <button class="action-button" @click="closeMindMirrorDialog">æˆ‘æ˜ç™½äº†</button>
            </div>
          </div>
        </div>
        
        <!-- ç–—æ„ˆå°æ•…äº‹æ˜¾ç¤ºåŒºåŸŸ -->
        <div v-if="healingStory" class="healing-story-section">
          <h3>ğŸ“– è‰ºæœ¯ç–—æ„ˆå°æ•…äº‹</h3>
          <div class="healing-story-content">
            {{ healingStory }}
          </div>
        </div>
      </div>
    </div>

    <!-- é‡å‘½åå¯¹è¯æ¡† -->
    <div v-if="showRenameModal" class="modal-overlay" @click="closeRenameDialog">
      <div class="rename-modal" @click.stop>
        <h3>é‡å‘½åç”»å¸ƒ</h3>
        <input type="text" v-model="newCanvasName" @keyup.enter="confirmRename" />
        <div class="modal-buttons">
          <button @click="closeRenameDialog">å–æ¶ˆ</button>
          <button @click="confirmRename">ç¡®å®š</button>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import { ref, onMounted, onUnmounted } from 'vue'
import { useRouter } from 'vue-router'
import { useAuthStore } from '../store/auth'
import axios from 'axios'

export default {
  name: 'MindPaintingView',
  setup() {
    const router = useRouter()
    const authStore = useAuthStore()
    const drawingCanvas = ref(null)
    let ctx = null
    let isDrawing = false

    // ç»˜ç”»å·¥å…·ç›¸å…³çŠ¶æ€
    const currentColor = ref('#000000')
    const brushSize = ref(5)
    const brushType = ref('normal') // æ™®é€šç¬”ã€é’¢ç¬”ã€æ°´å½©ç¬”ã€é“…ç¬”
    const currentTool = ref('brush') // brush æˆ– eraser
    const eraserType = ref('pixel') // pixel æˆ– stroke
    const analysisResult = ref(null)

    // å†å²è®°å½•ç›¸å…³
    const history = ref([])
    const MAX_HISTORY = 50

    // ç»˜ç”»æ¨¡å¼ç›¸å…³
    const showModeSelection = ref(true) // é»˜è®¤æ˜¾ç¤ºæ¨¡å¼é€‰æ‹©é¡µé¢
    const showThemeSelection = ref(false) // ä¸»é¢˜é€‰æ‹©é¡µé¢
    const currentPaintingMode = ref('') // å½“å‰é€‰æ‹©çš„ç»˜ç”»æ¨¡å¼
    const themeOptions = ref([
      { text: 'ç”»ä¸‹ä½ æœ€è¿‘çš„å‹åŠ›æº', emoji: 'âš¡' },
      { text: 'æç»˜ä½ å¿ƒä¸­çš„ç†æƒ³å®¿èˆå…³ç³»', emoji: 'ğŸ ' },
      { text: 'ä¸ºä½ çš„æœªæ¥æ¶‚ä¸Šé¢œè‰²', emoji: 'ğŸŒˆ' },
      { text: 'ç”»ä¸€å¹…ä»£è¡¨ä½ æœŸæœ«è€ƒè¯•å¿ƒæƒ…çš„ç”»', emoji: 'ğŸ“' },
      { text: 'ç”»å‡ºä½ æœ€å–œæ¬¢çš„å­¦ä¹ è§’è½', emoji: 'ğŸ“š' },
      { text: 'ç”¨è‰²å½©è¡¨è¾¾ä½ å’Œæœ‹å‹çš„å…³ç³»', emoji: 'ğŸ¤' },
      { text: 'æç»˜ä½ é¢å¯¹æŒ‘æˆ˜æ—¶çš„å†…å¿ƒä¸–ç•Œ', emoji: 'â›°ï¸' },
      { text: 'ç”»å‡ºä½ æƒ³è±¡ä¸­æ¯•ä¸šåçš„ç”Ÿæ´»', emoji: 'ğŸŒŸ' }
    ])
    const selectedTheme = ref('') // é€‰æ‹©çš„ä¸»é¢˜

    // ç”»å¸ƒç®¡ç†ç›¸å…³
    const showCanvasList = ref(false) // é»˜è®¤ä¸æ˜¾ç¤ºç”»å¸ƒåˆ—è¡¨
    const savedCanvases = ref([]) // æ‰€æœ‰ä¿å­˜çš„ç”»å¸ƒ
    const filteredCanvases = ref([]) // å½“å‰æ¨¡å¼ä¸‹çš„ç”»å¸ƒ
    const currentCanvasId = ref(null)
    const currentCanvasName = ref('')
    const isDefaultName = ref(false)
    const showPaintingPrompt = ref(true) // æ˜¯å¦æ˜¾ç¤ºç»˜ç”»æç¤º
    const paintingPrompt = ref('') // ç»˜ç”»æç¤ºå†…å®¹

    // é‡å‘½åå¯¹è¯æ¡†ç›¸å…³
    const showRenameModal = ref(false)
    const canvasToRename = ref(null)
    const newCanvasName = ref('')

    // é€‰æ‹©ç»˜ç”»æ¨¡å¼
    const selectPaintingMode = (mode) => {
      currentPaintingMode.value = mode
      showModeSelection.value = false

      // æ ¹æ®æ¨¡å¼è®¾ç½®åˆå§‹çŠ¶æ€
      if (mode === 'themed') {
        // ä¸»é¢˜æ¨¡å¼ä¸‹æ˜¾ç¤ºä¸»é¢˜é€‰æ‹©ç•Œé¢
        showThemeSelection.value = true
        selectedTheme.value = ''
      } else {
        // å…¶ä»–æ¨¡å¼ç›´æ¥æ˜¾ç¤ºç”»å¸ƒåˆ—è¡¨
        showThemeSelection.value = false
        showCanvasList.value = true
        filterCanvasesByMode()
      }
    }

    // é€‰æ‹©ç»˜ç”»ä¸»é¢˜
    const selectTheme = (theme) => {
      selectedTheme.value = theme
      showThemeSelection.value = false
      showCanvasList.value = true
      filterCanvasesByMode()
    }

    // æ ¹æ®å½“å‰æ¨¡å¼è¿‡æ»¤ç”»å¸ƒåˆ—è¡¨
    const filterCanvasesByMode = () => {
      if (currentPaintingMode.value === 'themed') {
        // ä¸»é¢˜æ¨¡å¼ä¸‹ï¼Œå¯ä»¥é€‰æ‹©æ˜¯å¦æŒ‰ç‰¹å®šä¸»é¢˜è¿‡æ»¤
        // è¿™é‡Œæˆ‘ä»¬åªæŒ‰æ¨¡å¼è¿‡æ»¤
        filteredCanvases.value = savedCanvases.value.filter(c =>
            c.mode === 'themed'
        )
      } else {
        // å…¶ä»–æ¨¡å¼æŒ‰æ¨¡å¼ç±»å‹è¿‡æ»¤
        filteredCanvases.value = savedCanvases.value.filter(c =>
            c.mode === currentPaintingMode.value
        )
      }
    }

    onMounted(() => {
      // åŠ è½½ä¿å­˜çš„ç”»å¸ƒåˆ—è¡¨
      loadSavedCanvases()

      if (drawingCanvas.value) {
        ctx = drawingCanvas.value.getContext('2d')
        resizeCanvas()
        window.addEventListener('resize', resizeCanvas)
      }
    })

    onUnmounted(() => {
      window.removeEventListener('resize', resizeCanvas)
      // é¡µé¢ç¦»å¼€æ—¶è‡ªåŠ¨ä¿å­˜å½“å‰ç”»å¸ƒ
      if (!showCanvasList.value && currentCanvasId.value) {
        autoSaveCanvas()
      }
      // é¡µé¢ç¦»å¼€æ—¶åœæ­¢è¯­éŸ³æ’­æ”¾
      stopGuidanceSpeech()
    })

    // åˆå§‹åŒ–ç”»å¸ƒä¸Šä¸‹æ–‡
    const initCanvasContext = () => {
      if (drawingCanvas.value) {
        // æ€»æ˜¯é‡æ–°è·å–ctxï¼Œç¡®ä¿å®ƒæ˜¯æœ‰æ•ˆçš„
        ctx = drawingCanvas.value.getContext('2d')
        // è®¾ç½®é»˜è®¤çº¿æ¡æ ·å¼
        ctx.lineCap = 'round'
        ctx.lineJoin = 'round'
        resizeCanvas()
      }
    }

    const resizeCanvas = () => {
      if (!drawingCanvas.value || !ctx) return

      const width = drawingCanvas.value.offsetWidth
      const height = 600 // å¢å¤§ç”»å¸ƒé«˜åº¦

      // ä¿å­˜å½“å‰ç”»å¸ƒå†…å®¹
      const imageData = ctx.getImageData(0, 0, drawingCanvas.value.width, drawingCanvas.value.height)

      // è°ƒæ•´ç”»å¸ƒå¤§å°
      drawingCanvas.value.width = width
      drawingCanvas.value.height = height

      // æ¢å¤ç”»å¸ƒå†…å®¹
      ctx.putImageData(imageData, 0, 0)

      // è®¾ç½®é»˜è®¤çº¿æ¡æ ·å¼
      ctx.lineCap = 'round'
      ctx.lineJoin = 'round'
    }

    // é€‰æ‹©å·¥å…·
    const selectTool = (tool, type = null) => {
      currentTool.value = tool
      if (type) {
        brushType.value = type

        // ä¼˜åŒ–1ï¼šé€‰æ‹©é“…ç¬”æ—¶ï¼Œé”å®šé¢œè‰²ä¸ºé“…ç¬”çš„æµ…ç°è‰²
        if (type === 'pencil') {
          currentColor.value = '#AAAAAA' // é“…ç¬”æµ…ç°è‰²
        }
      }

      // æ ¹æ®å·¥å…·ç±»å‹æ›´æ”¹é¼ æ ‡æ ·å¼
      if (drawingCanvas.value) {
        if (tool === 'eraser') {
          drawingCanvas.value.style.cursor = `url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='${brushSize.value + 10}' height='${brushSize.value + 10}' viewBox='0 0 24 24' fill='none' stroke='%23000' stroke-width='1' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='3' y='3' width='18' height='18' rx='2' ry='2'%3E%3C/rect%3E%3C/svg%3E") ${brushSize.value / 2 + 5} ${brushSize.value / 2 + 5}, crosshair`
        } else {
          // æ ¹æ®ä¸åŒç”»ç¬”ç±»å‹è®¾ç½®ä¸åŒçš„é¼ æ ‡å…‰æ ‡é¢œè‰²
          let cursorColor = '%23000000'
          if (brushType.value === 'pencil') {
            cursorColor = '%23AAAAAA' // é“…ç¬”å…‰æ ‡ä½¿ç”¨æµ…ç°è‰²
          }
          drawingCanvas.value.style.cursor = `url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='${brushSize.value + 2}' height='${brushSize.value + 2}' viewBox='0 0 24 24' fill='${cursorColor}' stroke='none'%3E%3Ccircle cx='12' cy='12' r='${brushSize.value / 2}'%3E%3C/circle%3E%3C/svg%3E") ${brushSize.value / 2 + 1} ${brushSize.value / 2 + 1}, crosshair`
        }
      }
    }

    // ä¿å­˜å½“å‰ç”»å¸ƒçŠ¶æ€åˆ°å†å²è®°å½•
    const saveState = () => {
      if (!ctx || !drawingCanvas.value) return

      try {
        const imageData = ctx.getImageData(0, 0, drawingCanvas.value.width, drawingCanvas.value.height)
        history.value.push(imageData)

        // é™åˆ¶å†å²è®°å½•æ•°é‡
        if (history.value.length > MAX_HISTORY) {
          history.value.shift() // åˆ é™¤æœ€æ—§çš„è®°å½•
        }
      } catch (error) {
        console.error('ä¿å­˜å†å²è®°å½•å¤±è´¥:', error)
      }
    }

    // æ’¤å›æ“ä½œ
    const undo = () => {
      if (history.value.length === 0 || !ctx || !drawingCanvas.value) return

      const lastState = history.value.pop()
      try {
        ctx.putImageData(lastState, 0, 0)
      } catch (error) {
        console.error('æ¢å¤å†å²è®°å½•å¤±è´¥:', error)
      }
    }

    // å½“å‰æ­£åœ¨ç»˜åˆ¶çš„è·¯å¾„
    const currentPath = ref([])
    
    // ç»˜ç”»æ—¶é—´ç›¸å…³
    const drawingStartTime = ref(null)
    const totalDrawingTime = ref(0)
    const lastDrawTime = ref(null)
    const pathCount = ref(0)
    const strokeStats = ref({
      totalLength: 0,
      averageLength: 0,
      jitterCount: 0,
      overlapCount: 0,
      discontinuityCount: 0
    })

    // è®¡ç®—ä¸¤ç‚¹ä¹‹é—´çš„è·ç¦»
    const calculateDistance = (point1, point2) => {
      const dx = point2.x - point1.x
      const dy = point2.y - point1.y
      return Math.sqrt(dx * dx + dy * dy)
    }
    
    // è®¡ç®—ä¸‰ç‚¹ä¹‹é—´çš„è§’åº¦å˜åŒ–ï¼ˆç”¨äºæ£€æµ‹æŠ–åŠ¨ï¼‰
    const calculateJitter = (point1, point2, point3) => {
      const dx1 = point2.x - point1.x
      const dy1 = point2.y - point1.y
      const dx2 = point3.x - point2.x
      const dy2 = point3.y - point2.y
      
      const angle1 = Math.atan2(dy1, dx1)
      const angle2 = Math.atan2(dy2, dx2)
      
      const angleDiff = Math.abs(angle1 - angle2)
      return angleDiff > Math.PI / 3 // å¦‚æœè§’åº¦å˜åŒ–è¶…è¿‡60åº¦ï¼Œè®¤ä¸ºæ˜¯æŠ–åŠ¨
    }

    const startDrawing = (e) => {
      // ç¡®ä¿ctxå­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆå§‹åŒ–
      if (!ctx) {
        initCanvasContext()
        // å¦‚æœä»ç„¶æ²¡æœ‰ctxï¼Œè¯´æ˜åˆå§‹åŒ–å¤±è´¥ï¼Œä¸ç»§ç»­æ‰§è¡Œ
        if (!ctx) return
      }

      isDrawing = true

      // è®°å½•ç»˜ç”»å¼€å§‹æ—¶é—´ï¼ˆå¦‚æœæ˜¯é¦–æ¬¡å¼€å§‹ï¼‰
      if (!drawingStartTime.value) {
        drawingStartTime.value = Date.now()
      }
      lastDrawTime.value = Date.now()

      // å¼€å§‹æ–°ç¬”ç”»å‰ä¿å­˜å½“å‰çŠ¶æ€
      saveState()

      // åˆå§‹åŒ–å½“å‰ç¬”ç”»çš„ç‚¹é›†åˆ
      currentPath.value = []

      // ç¡®ä¿ctxæœ‰æ•ˆåå†æ‰§è¡Œç»˜åˆ¶
      if (ctx) {
        draw(e)
      }
    }

    const draw = (e) => {
      if (!isDrawing || !ctx || !drawingCanvas.value) return

      const rect = drawingCanvas.value.getBoundingClientRect()
      const x = e.clientX - rect.left
      const y = e.clientY - rect.top

      // è®°å½•å½“å‰ç‚¹
      currentPath.value.push({x, y, time: Date.now()})

      ctx.lineWidth = brushSize.value

      if (currentTool.value === 'eraser') {
        // æ©¡çš®æ“¦æ¨¡å¼
        ctx.globalCompositeOperation = 'destination-out'
        ctx.strokeStyle = 'rgba(0,0,0,1)'

        // è®¾ç½®æ©¡çš®æ“¦çš„æ ·å¼
        ctx.lineCap = 'round'
        ctx.lineJoin = 'round'
      } else {
        // ç”»ç¬”æ¨¡å¼ï¼Œæ ¹æ®ä¸åŒç”»ç¬”ç±»å‹è®¾ç½®ä¸åŒæ ·å¼
        ctx.globalCompositeOperation = 'source-over'
        ctx.strokeStyle = currentColor.value

        // æ ¹æ®ç”»ç¬”ç±»å‹è®¾ç½®ä¸åŒçš„æ ·å¼
        switch (brushType.value) {
          case 'normal':
            ctx.lineCap = 'round'
            ctx.lineJoin = 'round'
            ctx.globalAlpha = 1
            break
          case 'pen':
            // ä¼˜åŒ–é’¢ç¬”ç¬”è§¦ï¼Œä½¿å…¶æ›´æ¥è¿‘çœŸå®å†™å­—æ•ˆæœ
            ctx.lineCap = 'round'
            ctx.lineJoin = 'round'
            ctx.globalAlpha = 0.9
            // æ¨¡æ‹Ÿé’¢ç¬”çš„å‹æ„Ÿæ•ˆæœï¼Œæ ¹æ®é€Ÿåº¦è°ƒæ•´çº¿æ¡ç²—ç»†
            if (currentPath.value.length > 1) {
              const prevPoint = currentPath.value[currentPath.value.length - 2]
              const distance = Math.sqrt(
                  Math.pow(x - prevPoint.x, 2) + Math.pow(y - prevPoint.y, 2)
              )
              // æ ¹æ®ç§»åŠ¨é€Ÿåº¦è°ƒæ•´çº¿æ¡ç²—ç»†ï¼Œé€Ÿåº¦è¶Šå¿«çº¿æ¡è¶Šç»†
              const dynamicWidth = Math.max(0.5, brushSize.value * (1 - Math.min(distance / 20, 0.7)))
              ctx.lineWidth = dynamicWidth
            }
            break
          case 'watercolor':
            // é™ä½æ°´å½©ç¬”é€æ˜åº¦ï¼Œä½¿å…¶æ›´åŠ é€æ˜
            ctx.lineCap = 'round'
            ctx.lineJoin = 'round'
            ctx.globalAlpha = 0.2 // è¿›ä¸€æ­¥é™ä½é€æ˜åº¦
            ctx.shadowBlur = 8 // å¢åŠ æ¨¡ç³Šæ•ˆæœä½¿é¢œè‰²è¿‡æ¸¡æ›´è‡ªç„¶
            ctx.shadowColor = currentColor.value
            // æ¨¡æ‹Ÿæ°´å½©çš„æ‰©æ•£æ•ˆæœ
            ctx.shadowOffsetX = 0
            ctx.shadowOffsetY = 0
            break
          case 'pencil':
            ctx.lineCap = 'round' // æ”¹ä¸ºroundä»¥é¿å…æ–¹å—æ•ˆæœ
            ctx.lineJoin = 'round' // æ”¹ä¸ºroundä»¥é¿å…æ–¹å—æ•ˆæœ
            ctx.globalAlpha = 0.8
            // é“…ç¬”æ•ˆæœæ·»åŠ ä¸è§„åˆ™æ€§ï¼Œæ¨¡æ‹ŸçœŸå®é“…ç¬”æ•ˆæœ
            if (currentPath.value.length > 1) {
              // æ·»åŠ ä¸€äº›éšæœºçš„ä¸è§„å¾‹æ€§
              ctx.lineWidth = brushSize.value * (0.9 + Math.random() * 0.2)
            }
            break
        }
      }

      // æ”¹è¿›çš„ç»˜ç”»é€»è¾‘ï¼Œè§£å†³å¿«é€Ÿç»˜åˆ¶æ—¶å‡ºç°åœ†ç‚¹æˆ–æ–¹å—çš„é—®é¢˜
      if (currentPath.value.length === 1) {
        ctx.beginPath()
        ctx.moveTo(x, y)
        // å¯¹äºç¬¬ä¸€ä¸ªç‚¹ï¼Œä¹Ÿç»˜åˆ¶ä¸€ä¸ªå°åœ†ç‚¹ï¼Œé¿å…å¿«é€Ÿç‚¹å‡»æ—¶çœ‹ä¸åˆ°
        ctx.arc(x, y, ctx.lineWidth / 2, 0, Math.PI * 2)
        ctx.fillStyle = ctx.strokeStyle
        ctx.fill()
      } else {
        const prevPoint = currentPath.value[currentPath.value.length - 2]
        const distance = Math.sqrt(
            Math.pow(x - prevPoint.x, 2) + Math.pow(y - prevPoint.y, 2)
        )

        // å¦‚æœä¸¤ç‚¹ä¹‹é—´è·ç¦»è¿‡å¤§ï¼Œä½¿ç”¨è´å¡å°”æ›²çº¿å¹³æ»‘è¿æ¥ï¼Œé¿å…è·³ç‚¹å½¢æˆæ–¹å—
        if (distance > ctx.lineWidth * 2) {
          const controlX = (prevPoint.x + x) / 2
          const controlY = (prevPoint.y + y) / 2
          ctx.beginPath()
          ctx.moveTo(prevPoint.x, prevPoint.y)
          ctx.quadraticCurveTo(controlX, controlY, x, y)
          ctx.stroke()
        } else {
          ctx.beginPath()
          ctx.moveTo(prevPoint.x, prevPoint.y)
          ctx.lineTo(x, y)
          ctx.stroke()
        }
      }

      // é‡ç½®æ°´å½©æ•ˆæœçš„é˜´å½±ï¼Œé¿å…å½±å“åç»­ç»˜åˆ¶
      if (brushType.value === 'watercolor') {
        ctx.shadowBlur = 0
      }
    }

    const stopDrawing = () => {
      isDrawing = false
      if (ctx) {
        ctx.beginPath()
      }

      // æ›´æ–°æ€»ç»˜ç”»æ—¶é—´
      if (lastDrawTime.value) {
        totalDrawingTime.value += Date.now() - lastDrawTime.value
      }

      // å¦‚æœæ˜¯æ“¦é™¤æ•´ç¬”æ¨¡å¼ï¼Œå¯ä»¥åœ¨è¿™é‡Œå¤„ç†
      if (currentTool.value === 'eraser' && eraserType.value === 'stroke' && currentPath.value.length > 0) {
        // è¿™é‡Œå¯ä»¥å®ç°æ•´ç¬”ç”»æ“¦é™¤çš„é€»è¾‘
        // ç®€å•åšæ³•æ˜¯é‡æ–°ç»˜åˆ¶æ•´ä¸ªç”»å¸ƒï¼Œè·³è¿‡å½“å‰è·¯å¾„
        return
      }

      if (currentPath.value.length > 0) {
        // åˆ†æå½“å‰è·¯å¾„çš„ç‰¹å¾
        const pathLength = currentPath.value.length
        let totalSegmentLength = 0
        let jitterDetected = 0
        let discontinuityCount = 0
        
        for (let i = 1; i < pathLength; i++) {
          const distance = calculateDistance(currentPath.value[i-1], currentPath.value[i])
          totalSegmentLength += distance
          
          // æ£€æµ‹ä¸è¿ç»­æ€§ï¼ˆè¿‡å¤§çš„è·ç¦»ï¼‰
          if (distance > 20) {
            discontinuityCount++
          }
          
          // æ£€æµ‹æŠ–åŠ¨ï¼ˆè§’åº¦å˜åŒ–å¤§çš„ç‚¹ï¼‰
          if (i > 1 && calculateJitter(currentPath.value[i-2], currentPath.value[i-1], currentPath.value[i])) {
            jitterDetected++
          }
        }
        
        // æ›´æ–°ç¬”è§¦ç»Ÿè®¡
        strokeStats.value.totalLength += totalSegmentLength
        strokeStats.value.jitterCount += jitterDetected
        strokeStats.value.discontinuityCount += discontinuityCount
        strokeStats.value.averageLength = strokeStats.value.totalLength / (pathCount.value + 1)
        
        // æ£€æµ‹æ˜¯å¦æœ‰æ¶‚æ”¹ç—•è¿¹ï¼ˆé€šè¿‡é€Ÿåº¦å˜åŒ–åˆ¤æ–­ï¼‰
        let hasOverlap = false
        if (pathLength > 5) {
          // ç®€åŒ–çš„é‡å æ£€æµ‹
          for (let i = 5; i < pathLength; i++) {
            for (let j = 0; j < i - 5; j++) {
              if (calculateDistance(currentPath.value[i], currentPath.value[j]) < 10) {
                hasOverlap = true
                strokeStats.value.overlapCount++
                break
              }
            }
            if (hasOverlap) break
          }
        }
        
        pathCount.value++
      }
    }

    const clearCanvas = () => {
      if (!ctx || !drawingCanvas.value) {
        initCanvasContext()
        if (!ctx) return
      }

      if (confirm('ç¡®å®šè¦æ¸…ç©ºç”»å¸ƒå—ï¼Ÿ')) {
        // æ¸…ç©ºå‰ä¿å­˜çŠ¶æ€ä»¥ä¾¿å¯ä»¥æ’¤é”€
        saveState()
        ctx.clearRect(0, 0, drawingCanvas.value.width, drawingCanvas.value.height)
        analysisResult.value = null
      }
    }

    // ç”Ÿæˆé»˜è®¤ç”»å¸ƒåç§°
    const generateDefaultCanvasName = () => {
      const now = new Date()
      const dateStr = `${now.getFullYear()}/${String(now.getMonth() + 1).padStart(2, '0')}/${String(now.getDate()).padStart(2, '0')}`

      // è®¡ç®—ä»Šå¤©çš„æµæ°´å·
      const todayCanvases = savedCanvases.value.filter(c => c.name.startsWith(dateStr))
      const serialNumber = todayCanvases.length + 1

      return `${dateStr}-${serialNumber}`
    }

    // åˆ›å»ºæ–°ç”»å¸ƒ
    const createNewCanvas = () => {
      // è‡ªåŠ¨ä¿å­˜å½“å‰ç”»å¸ƒ
      if (!showCanvasList.value && currentCanvasId.value && ctx && drawingCanvas.value) {
        autoSaveCanvas()
      }

      // ç”Ÿæˆæ–°çš„ç”»å¸ƒIDå’Œåç§°
      currentCanvasId.value = Date.now().toString()
      let defaultName = generateDefaultCanvasName()

      // æ ¹æ®å½“å‰æ¨¡å¼å®šåˆ¶ç”»å¸ƒåç§°
      if (currentPaintingMode.value === 'themed' && selectedTheme.value) {
        defaultName = `ä¸»é¢˜ç”» - ${selectedTheme.value.substring(0, 10)}...`
      } else if (currentPaintingMode.value === 'htp') {
        defaultName = `æˆ¿æ ‘äººæµ‹è¯• - ${new Date().toLocaleDateString()}`
      } else if (currentPaintingMode.value === 'free') {
        defaultName = `è‡ªç”±åˆ›ä½œ - ${new Date().toLocaleTimeString()}`
      }

      currentCanvasName.value = defaultName
      isDefaultName.value = true

      // æ˜¾ç¤ºç»˜ç”»ç•Œé¢
      showCanvasList.value = false
      
      // è®¾ç½®ç»˜ç”»æç¤º
      showPaintingPrompt.value = true
      if (currentPaintingMode.value === 'themed' && selectedTheme.value) {
        paintingPrompt.value = `æ‚¨å·²é€‰æ‹©ä¸»é¢˜ç»˜ç”»ï¼Œè¯·æ‚¨æ ¹æ®ã€${selectedTheme.value}ã€‘ä¸»é¢˜è¿›è¡Œç»˜ç”»ï¼šè¯·è‡ªç”±åœ°è¡¨è¾¾æ‚¨å¯¹è¿™ä¸ªä¸»é¢˜çš„æ„Ÿå—å’Œæƒ³æ³•ï¼Œä¸è¦æ‹…å¿ƒç»˜ç”»æŠ€å·§ï¼Œé‡è¦çš„æ˜¯è¡¨è¾¾å†…å¿ƒçš„çœŸå®æƒ…æ„Ÿã€‚`
      } else if (currentPaintingMode.value === 'free') {
        paintingPrompt.value = `æ‚¨å·²é€‰æ‹©è‡ªç”±ç»˜ç”»ï¼Œè¯·éšæ„å‘æŒ¥ï¼Œæ”¾æ¾å¿ƒæƒ…ï¼šè¿™é‡Œæ²¡æœ‰ä»»ä½•é™åˆ¶ï¼Œæ‚¨å¯ä»¥ç”»ä»»ä½•æƒ³ç”»çš„å†…å®¹ï¼Œè®©æ‚¨çš„æ€ç»ªè‡ªç”±æµåŠ¨ï¼Œç”¨è‰²å½©å’Œçº¿æ¡è¡¨è¾¾æ­¤åˆ»çš„å¿ƒæƒ…ã€‚`
      } else if (currentPaintingMode.value === 'htp') {
        paintingPrompt.value = `æ‚¨å·²é€‰æ‹©æˆ¿æ ‘äººæµ‹è¯•ï¼šè¯·åœ¨åŒä¸€å¼ ç”»å¸ƒä¸Šç»˜åˆ¶æˆ¿å­ã€æ ‘æœ¨å’Œäººç‰©ã€‚è¿™ä¸ªç»å…¸çš„å¿ƒç†æµ‹éªŒå¯ä»¥å¸®åŠ©æˆ‘ä»¬äº†è§£æ‚¨çš„å†…å¿ƒä¸–ç•Œã€‚è¯·æŒ‰ç…§æ‚¨å†…å¿ƒçš„æƒ³æ³•è‡ªç”±ç»˜åˆ¶ï¼Œä¸éœ€è¦ç‰¹åˆ«æŠ€å·§ã€‚`
      }

      // ç¡®ä¿canvaså’Œctxå·²åˆå§‹åŒ–åå†æ¸…ç©ºç”»å¸ƒ
      setTimeout(() => {
        // åˆå§‹åŒ–ç”»å¸ƒä¸Šä¸‹æ–‡
        initCanvasContext()

        if (ctx && drawingCanvas.value) {
          ctx.clearRect(0, 0, drawingCanvas.value.width, drawingCanvas.value.height)
        }

        // é‡ç½®çŠ¶æ€
        history.value = []
        analysisResult.value = null

        // é‡ç½®é»˜è®¤å·¥å…·é…ç½®
        currentColor.value = '#000000' // é»˜è®¤é¢œè‰²ï¼šé»‘è‰²
        brushSize.value = 5 // é»˜è®¤ç²—ç»†ï¼š5
        brushType.value = 'normal' // é»˜è®¤ç”»ç¬”ç±»å‹ï¼šæ™®é€šç¬”
        currentTool.value = 'brush' // é»˜è®¤å·¥å…·ï¼šç”»ç¬”
        selectTool('brush', 'normal')
      }, 200) // å¢åŠ å»¶è¿Ÿæ—¶é—´ï¼Œç¡®ä¿DOMå®Œå…¨æ¸²æŸ“
    }

    // ä¿å­˜ç”»å¸ƒ
    const saveCanvas = () => {
      if (!currentCanvasId.value) return

      // è·å–ç”»å¸ƒæ•°æ®URL
      const imageData = drawingCanvas.value.toDataURL('image/png')

      // åˆ›å»ºç¼©ç•¥å›¾ï¼ˆè¿™é‡Œç®€åŒ–å¤„ç†ï¼Œç›´æ¥ä½¿ç”¨åŸå›¾ä½œä¸ºç¼©ç•¥å›¾ï¼‰
      const thumbnail = imageData

      // æŸ¥æ‰¾æ˜¯å¦å·²å­˜åœ¨è¯¥ç”»å¸ƒ
      const existingIndex = savedCanvases.value.findIndex(c => c.id === currentCanvasId.value)

      const canvasData = {
        id: currentCanvasId.value,
        name: currentCanvasName.value,
        data: imageData,
        thumbnail: thumbnail,
        lastModified: new Date().toISOString(),
        mode: currentPaintingMode.value, // ä¿å­˜å½“å‰ç»˜ç”»æ¨¡å¼
        theme: selectedTheme.value // ä¿å­˜é€‰æ‹©çš„ä¸»é¢˜ï¼ˆå¦‚æœæœ‰ï¼‰
      }

      if (existingIndex >= 0) {
        // æ›´æ–°ç°æœ‰ç”»å¸ƒ
        savedCanvases.value[existingIndex] = canvasData
      } else {
        // æ·»åŠ æ–°ç”»å¸ƒ
        savedCanvases.value.push(canvasData)
        // å¦‚æœå½“å‰æ˜¾ç¤ºç”»å¸ƒåˆ—è¡¨ï¼Œæ›´æ–°è¿‡æ»¤åçš„åˆ—è¡¨
        if (showCanvasList.value) {
          filterCanvasesByMode()
        }
      }

      // ä¿å­˜åˆ°localStorage
      localStorage.setItem('mindPaintingCanvases', JSON.stringify(savedCanvases.value))

      alert('ç”»å¸ƒä¿å­˜æˆåŠŸï¼')
    }

    // è‡ªåŠ¨ä¿å­˜ç”»å¸ƒ
    const autoSaveCanvas = () => {
      if (!currentCanvasId.value || !drawingCanvas.value) return

      // è·å–ç”»å¸ƒæ•°æ®URL
      const imageData = drawingCanvas.value.toDataURL('image/png')

      // åˆ›å»ºç¼©ç•¥å›¾
      const thumbnail = imageData

      // æŸ¥æ‰¾æ˜¯å¦å·²å­˜åœ¨è¯¥ç”»å¸ƒ
      const existingIndex = savedCanvases.value.findIndex(c => c.id === currentCanvasId.value)

      const canvasData = {
        id: currentCanvasId.value,
        name: currentCanvasName.value,
        data: imageData,
        thumbnail: thumbnail,
        lastModified: new Date().toISOString(),
        mode: currentPaintingMode.value, // ä¿å­˜å½“å‰ç»˜ç”»æ¨¡å¼
        theme: selectedTheme.value // ä¿å­˜é€‰æ‹©çš„ä¸»é¢˜ï¼ˆå¦‚æœæœ‰ï¼‰
      }

      if (existingIndex >= 0) {
        // æ›´æ–°ç°æœ‰ç”»å¸ƒ
        savedCanvases.value[existingIndex] = canvasData
      } else {
        // æ·»åŠ æ–°ç”»å¸ƒ
        savedCanvases.value.push(canvasData)
        // å¦‚æœå½“å‰æ˜¾ç¤ºç”»å¸ƒåˆ—è¡¨ï¼Œæ›´æ–°è¿‡æ»¤åçš„åˆ—è¡¨
        if (showCanvasList.value) {
          filterCanvasesByMode()
        }
      }

      // ä¿å­˜åˆ°localStorage
      localStorage.setItem('mindPaintingCanvases', JSON.stringify(savedCanvases.value))
    }

    // åŠ è½½ä¿å­˜çš„ç”»å¸ƒåˆ—è¡¨
    const loadSavedCanvases = () => {
      const saved = localStorage.getItem('mindPaintingCanvases')
      if (saved) {
        try {
          const allCanvases = JSON.parse(saved)
          // ä¸ºæ—§ç‰ˆæœ¬ç”»å¸ƒæ·»åŠ modeå­—æ®µï¼ˆå¦‚æœæ²¡æœ‰ï¼‰
          savedCanvases.value = allCanvases.map(canvas => ({
            ...canvas,
            mode: canvas.mode || 'free' // é»˜è®¤ä¸ºè‡ªç”±æ¨¡å¼
          }))

          // å¦‚æœå½“å‰æ˜¾ç¤ºç”»å¸ƒåˆ—è¡¨ï¼Œåˆ™åº”ç”¨è¿‡æ»¤
          if (showCanvasList.value) {
            filterCanvasesByMode()
          }
        } catch (e) {
          console.error('åŠ è½½ä¿å­˜çš„ç”»å¸ƒå¤±è´¥:', e)
          savedCanvases.value = []
          filteredCanvases.value = []
        }
      }
    }

    // åŠ è½½æŒ‡å®šç”»å¸ƒ
    const loadCanvas = (canvasId) => {
      // è‡ªåŠ¨ä¿å­˜å½“å‰ç”»å¸ƒ
      if (!showCanvasList.value && currentCanvasId.value && currentCanvasId.value !== canvasId) {
        autoSaveCanvas()
      }

      // æŸ¥æ‰¾è¦åŠ è½½çš„ç”»å¸ƒ
      const canvasToLoad = savedCanvases.value.find(c => c.id === canvasId)
      if (!canvasToLoad) return

      // è®¾ç½®å½“å‰ç”»å¸ƒä¿¡æ¯
      currentCanvasId.value = canvasToLoad.id
      currentCanvasName.value = canvasToLoad.name
      isDefaultName.value = currentCanvasName.value.startsWith(`${new Date().getFullYear()}/`)

      // æ˜¾ç¤ºç»˜ç”»ç•Œé¢
      showCanvasList.value = false
      
      // è®¾ç½®ç»˜ç”»æç¤º
      showPaintingPrompt.value = true
      if (canvasToLoad.mode === 'themed' && canvasToLoad.theme) {
        paintingPrompt.value = `æ‚¨å·²é€‰æ‹©ä¸»é¢˜ç»˜ç”»ï¼Œè¯·æ‚¨æ ¹æ®ã€${canvasToLoad.theme}ã€‘ä¸»é¢˜è¿›è¡Œç»˜ç”»ï¼šè¯·è‡ªç”±åœ°è¡¨è¾¾æ‚¨å¯¹è¿™ä¸ªä¸»é¢˜çš„æ„Ÿå—å’Œæƒ³æ³•ï¼Œä¸è¦æ‹…å¿ƒç»˜ç”»æŠ€å·§ï¼Œé‡è¦çš„æ˜¯è¡¨è¾¾å†…å¿ƒçš„çœŸå®æƒ…æ„Ÿã€‚`
      } else if (canvasToLoad.mode === 'free') {
        paintingPrompt.value = `æ‚¨å·²é€‰æ‹©è‡ªç”±ç»˜ç”»ï¼Œè¯·éšæ„å‘æŒ¥ï¼Œæ”¾æ¾å¿ƒæƒ…ï¼šè¿™é‡Œæ²¡æœ‰ä»»ä½•é™åˆ¶ï¼Œæ‚¨å¯ä»¥ç”»ä»»ä½•æƒ³ç”»çš„å†…å®¹ï¼Œè®©æ‚¨çš„æ€ç»ªè‡ªç”±æµåŠ¨ï¼Œç”¨è‰²å½©å’Œçº¿æ¡è¡¨è¾¾æ­¤åˆ»çš„å¿ƒæƒ…ã€‚`
      } else if (canvasToLoad.mode === 'htp') {
        paintingPrompt.value = `æ‚¨å·²é€‰æ‹©æˆ¿æ ‘äººæµ‹è¯•ï¼šè¯·åœ¨åŒä¸€å¼ ç”»å¸ƒä¸Šç»˜åˆ¶æˆ¿å­ã€æ ‘æœ¨å’Œäººç‰©ã€‚è¿™ä¸ªç»å…¸çš„å¿ƒç†æµ‹éªŒå¯ä»¥å¸®åŠ©æˆ‘ä»¬äº†è§£æ‚¨çš„å†…å¿ƒä¸–ç•Œã€‚è¯·æŒ‰ç…§æ‚¨å†…å¿ƒçš„æƒ³æ³•è‡ªç”±ç»˜åˆ¶ï¼Œä¸éœ€è¦ç‰¹åˆ«æŠ€å·§ã€‚`
      }

      // ç¡®ä¿canvaså’Œctxå·²åˆå§‹åŒ–åå†åŠ è½½ç”»å¸ƒæ•°æ®
      setTimeout(() => {
        // åˆå§‹åŒ–ç”»å¸ƒä¸Šä¸‹æ–‡
        initCanvasContext()

        // åˆ›å»ºå›¾åƒå¯¹è±¡æ¥åŠ è½½ç”»å¸ƒæ•°æ®
        const img = new Image()
        img.onload = () => {
          if (ctx && drawingCanvas.value) {
            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, drawingCanvas.value.width, drawingCanvas.value.height)
            // ç»˜åˆ¶åŠ è½½çš„å›¾åƒ
            ctx.drawImage(img, 0, 0, drawingCanvas.value.width, drawingCanvas.value.height)
          }
          // é‡ç½®å†å²è®°å½•
          history.value = []
          analysisResult.value = null
        }
        img.src = canvasToLoad.data
      }, 100)
    }

    // åˆ é™¤ç”»å¸ƒ
    const deleteCanvas = (canvasId) => {
      if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç”»å¸ƒå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
        savedCanvases.value = savedCanvases.value.filter(c => c.id !== canvasId)
        // ä¿å­˜åˆ°localStorage
        localStorage.setItem('mindPaintingCanvases', JSON.stringify(savedCanvases.value))
      }
    }

    // æ˜¾ç¤ºé‡å‘½åå¯¹è¯æ¡†
    const showRenameDialog = (canvas) => {
      canvasToRename.value = canvas
      newCanvasName.value = canvas.name
      showRenameModal.value = true
    }

    // å…³é—­é‡å‘½åå¯¹è¯æ¡†
    const closeRenameDialog = () => {
      showRenameModal.value = false
      canvasToRename.value = null
      newCanvasName.value = ''
    }

    // ç¡®è®¤é‡å‘½å
    const confirmRename = () => {
      if (!canvasToRename.value || !newCanvasName.value.trim()) {
        alert('è¯·è¾“å…¥ç”»å¸ƒåç§°')
        return
      }

      // æ›´æ–°ç”»å¸ƒåç§°
      const canvasIndex = savedCanvases.value.findIndex(c => c.id === canvasToRename.value.id)
      if (canvasIndex >= 0) {
        savedCanvases.value[canvasIndex].name = newCanvasName.value.trim()

        // å¦‚æœæ˜¯å½“å‰æ­£åœ¨ç¼–è¾‘çš„ç”»å¸ƒï¼Œä¹Ÿæ›´æ–°å½“å‰åç§°
        if (currentCanvasId.value === canvasToRename.value.id) {
          currentCanvasName.value = newCanvasName.value.trim()
          isDefaultName.value = false
        }

        // ä¿å­˜åˆ°localStorage
        localStorage.setItem('mindPaintingCanvases', JSON.stringify(savedCanvases.value))

        // å…³é—­å¯¹è¯æ¡†
        closeRenameDialog()
      }
    }



    // RGBè½¬HSVé¢œè‰²ç©ºé—´
    const rgbToHsv = (r, g, b) => {
      r /= 255, g /= 255, b /= 255;
      
      const max = Math.max(r, g, b);
      const min = Math.min(r, g, b);
      let h = 0, s, v = max;
      
      const d = max - min;
      s = max === 0 ? 0 : d / max;
      
      if (max !== min) {
        switch (max) {
          case r: h = (g - b) / d + (g < b ? 6 : 0); break;
          case g: h = (b - r) / d + 2; break;
          case b: h = (r - g) / d + 4; break;
        }
        h /= 6;
      }
      
      return { h: h * 360, s: s, v: v };
    }
    
    // åˆ†æè‰²å½©ç‰¹å¾
    const analyzeColors = (imageData) => {
      const data = imageData.data;
      const pixelCount = data.length / 4;
      
      let warmColorCount = 0;
      let coolColorCount = 0;
      let highSaturationCount = 0;
      let lowValueCount = 0;
      
      // è‰²å½©ç›´æ–¹å›¾
      const colorHistogram = {};
      
      for (let i = 0; i < data.length; i += 4) {
        const r = data[i];
        const g = data[i + 1];
        const b = data[i + 2];
        const a = data[i + 3];
        
        // è·³è¿‡é€æ˜åƒç´ 
        if (a === 0) continue;
        
        const hsv = rgbToHsv(r, g, b);
        
        // å†·è‰²è°ƒ vs æš–è‰²è°ƒ (ç®€åŒ–åˆ¤æ–­)
        if ((hsv.h >= 0 && hsv.h <= 60) || (hsv.h >= 300 && hsv.h <= 360)) {
          warmColorCount++;
        } else if (hsv.h >= 180 && hsv.h <= 240) {
          coolColorCount++;
        }
        
        // é¥±å’Œåº¦åˆ†æ
        if (hsv.s > 0.7) highSaturationCount++;
        
        // æ˜åº¦åˆ†æ
        if (hsv.v < 0.3) lowValueCount++;
        
        // ç®€åŒ–çš„é¢œè‰²åˆ†ç±»ç»Ÿè®¡
        const colorKey = `${Math.floor(r/50)}_${Math.floor(g/50)}_${Math.floor(b/50)}`;
        colorHistogram[colorKey] = (colorHistogram[colorKey] || 0) + 1;
      }
      
      return {
        warmToCoolRatio: coolColorCount > 0 ? warmColorCount / coolColorCount : warmColorCount,
        highSaturationRatio: highSaturationCount / pixelCount,
        lowValueRatio: lowValueCount / pixelCount,
        colorDiversity: Object.keys(colorHistogram).length
      };
    }
    
    // åˆ†ææ„å›¾å’Œç©ºé—´ç‰¹å¾
    const analyzeComposition = (imageData, canvas) => {
      const data = imageData.data;
      const width = canvas.width;
      const height = canvas.height;
      
      let pixelCount = 0;
      let xSum = 0;
      let ySum = 0;
      let topPixels = 0;
      let bottomPixels = 0;
      let leftPixels = 0;
      let rightPixels = 0;
      
      // è®¡ç®—é‡å¿ƒå’Œç©ºé—´åˆ†å¸ƒ
      for (let i = 0; i < data.length; i += 4) {
        const a = data[i + 3];
        if (a > 0) { // éé€æ˜åƒç´ 
          const pixelIndex = i / 4;
          const x = pixelIndex % width;
          const y = Math.floor(pixelIndex / width);
          
          xSum += x;
          ySum += y;
          pixelCount++;
          
          // è®¡ç®—ç©ºé—´åˆ†å¸ƒ
          if (y < height * 0.3) topPixels++;
          if (y > height * 0.7) bottomPixels++;
          if (x < width * 0.3) leftPixels++;
          if (x > width * 0.7) rightPixels++;
        }
      }
      
      const centerX = pixelCount > 0 ? xSum / pixelCount : width / 2;
      const centerY = pixelCount > 0 ? ySum / pixelCount : height / 2;
      
      // è®¡ç®—ç”»é¢å¯†åº¦
      const totalPixels = width * height;
      const density = pixelCount / totalPixels;
      
      return {
        center: { x: centerX, y: centerY },
        verticalBalance: bottomPixels > 0 ? topPixels / bottomPixels : topPixels,
        horizontalBalance: rightPixels > 0 ? leftPixels / rightPixels : leftPixels,
        density: density,
        isTopHeavy: centerY < height * 0.4,
        isBottomHeavy: centerY > height * 0.6,
        isLeftHeavy: centerX < width * 0.4,
        isRightHeavy: centerX > width * 0.6
      };
    }
    
    // åˆ†ææäº¤æ—¶é—´
    const analyzeSubmissionTime = () => {
      const now = new Date();
      const hour = now.getHours();
      
      let timeCategory = 'normal';
      if (hour >= 22 || hour < 6) {
        timeCategory = 'late_night';
      } else if (hour >= 6 && hour < 9) {
        timeCategory = 'morning';
      } else if (hour >= 12 && hour < 14) {
        timeCategory = 'noon';
      } else if (hour >= 18 && hour < 22) {
        timeCategory = 'evening';
      }
      
      return {
        hour: hour,
        timeCategory: timeCategory,
        isLateNight: timeCategory === 'late_night',
        dayOfWeek: now.getDay()
      };
    }
    
    // ç”Ÿæˆå‹åŠ›æŒ‡æ•°
    const calculateStressIndex = (colorAnalysis, strokeAnalysis, composition, timeAnalysis) => {
      let stressScore = 0;
      
      // è‰²å½©å› ç´  (ä½æ˜åº¦ã€ä½é¥±å’Œåº¦ã€å†·è‰²è°ƒå¯èƒ½ä»£è¡¨å‹åŠ›)
      stressScore += colorAnalysis.lowValueRatio * 20;
      stressScore += colorAnalysis.highSaturationRatio * 10; // è¿‡é«˜çš„é¥±å’Œåº¦ä¹Ÿå¯èƒ½ä»£è¡¨æƒ…ç»ªæ³¢åŠ¨
      
      // ç¬”è§¦å› ç´  (æŠ–åŠ¨ã€ä¸è¿ç»­ã€æ¶‚æ”¹ç—•è¿¹å¯èƒ½ä»£è¡¨ç„¦è™‘)
      stressScore += (strokeAnalysis.jitterCount / (pathCount.value || 1)) * 25;
      stressScore += (strokeAnalysis.discontinuityCount / (pathCount.value || 1)) * 15;
      stressScore += (strokeAnalysis.overlapCount / (pathCount.value || 1)) * 20;
      
      // æ„å›¾å› ç´  (ä¸å¹³è¡¡ã€è¿‡å¯†å¯èƒ½ä»£è¡¨å‹åŠ›)
      if (composition.isTopHeavy || composition.isBottomHeavy || 
          composition.isLeftHeavy || composition.isRightHeavy) {
        stressScore += 10;
      }
      if (composition.density > 0.8) stressScore += 15; // è¿‡æ»¡
      if (composition.density < 0.1) stressScore += 5;  // è¿‡ç©º
      
      // æ—¶é—´å› ç´  (æ·±å¤œä½œç”»å¯èƒ½ä»£è¡¨å‹åŠ›)
      if (timeAnalysis.isLateNight) stressScore += 10;
      
      // æ—¶é—´å› ç´  (ç»˜ç”»æ—¶é—´è¿‡é•¿æˆ–è¿‡çŸ­)
      const totalMinutes = totalDrawingTime.value / 1000 / 60;
      if (totalMinutes > 30) stressScore += 10; // è€—æ—¶è¿‡é•¿å¯èƒ½ä»£è¡¨çŠ¹è±«
      if (totalMinutes < 1) stressScore += 5;   // è¿‡å¿«å¯èƒ½ä»£è¡¨æ•·è¡
      
      // é™åˆ¶åœ¨0-100èŒƒå›´å†…
      stressScore = Math.min(100, Math.max(0, stressScore));
      
      // è½¬æ¢ä¸º0-10çš„æŒ‡æ•°
      const stressIndex = (stressScore / 10).toFixed(1);
      
      let stressLevel = 'è½»åº¦';
      if (stressScore > 60) stressLevel = 'é«˜åº¦';
      else if (stressScore > 30) stressLevel = 'ä¸­åº¦';
      
      return { score: stressScore, index: stressIndex, level: stressLevel };
    }
    
    // ç”Ÿæˆæƒ…ç»ªé›·è¾¾å›¾æ•°æ®
    const generateMoodRadar = (colorAnalysis, strokeAnalysis, composition) => {
      // åŸºäºå„ç§åˆ†æç»´åº¦ç”Ÿæˆæƒ…ç»ªæ•°æ®
      const happy = 50 - (colorAnalysis.lowValueRatio * 40) + (colorAnalysis.highSaturationRatio * 30);
      const sad = 30 + (colorAnalysis.lowValueRatio * 50) - (colorAnalysis.warmToCoolRatio * 20);
      const anxious = 20 + (strokeAnalysis.jitterCount / (pathCount.value || 1) * 50) + 
                     (strokeAnalysis.discontinuityCount / (pathCount.value || 1) * 30);
      const calm = 40 - (strokeAnalysis.jitterCount / (pathCount.value || 1) * 30) - 
                   (composition.density * 20);
      const angry = 10 + (strokeAnalysis.overlapCount / (pathCount.value || 1) * 40) - 
                    (colorAnalysis.warmToCoolRatio * 10);
      const creative = 30 + (colorAnalysis.colorDiversity / 20) + (strokeAnalysis.averageLength / 100);
      
      // å½’ä¸€åŒ–åˆ°0-100èŒƒå›´
      const normalize = (value) => Math.min(100, Math.max(0, Math.round(value)));
      
      return {
        happy: normalize(happy),
        sad: normalize(sad),
        anxious: normalize(anxious),
        calm: normalize(calm),
        angry: normalize(angry),
        creative: normalize(creative)
      };
    }
    
    // ç”Ÿæˆä¸ªæ€§åŒ–å¿ƒç†ç”»åƒ
    const generatePersonalityPortrait = (colorAnalysis, strokeAnalysis, composition, timeAnalysis, stressInfo) => {
      let portrait = [];
      
      // åŸºäºè‰²å½©åˆ†æ
      if (colorAnalysis.warmToCoolRatio > 1.5) {
        portrait.push('æ‚¨çš„ç”»ä½œå……æ»¡äº†æ¸©æš–çš„è‰²è°ƒï¼Œæ˜¾ç¤ºå‡ºæ‚¨å½“å‰æƒ…æ„ŸçŠ¶æ€è¾ƒä¸ºç§¯æå’Œçƒ­æƒ…ã€‚');
      } else if (colorAnalysis.warmToCoolRatio < 0.5) {
        portrait.push('æ‚¨ä½¿ç”¨äº†è¾ƒå¤šçš„å†·è‰²è°ƒï¼Œè¿™å¯èƒ½åæ˜ å‡ºæ‚¨å½“å‰æ¯”è¾ƒå†·é™æˆ–æ˜¯æœ‰äº›å†…æ•›çš„æƒ…ç»ªã€‚');
      }
      
      if (colorAnalysis.highSaturationRatio > 0.3) {
        portrait.push('æ˜äº®é¥±å’Œçš„è‰²å½©é€‰æ‹©è¡¨æ˜æ‚¨å¯èƒ½å……æ»¡æ´»åŠ›å’Œåˆ›é€ åŠ›ã€‚');
      } else if (colorAnalysis.lowValueRatio > 0.3) {
        portrait.push('ç”»ä½œä¸­çš„æ·±è‰²å…ƒç´ è¾ƒå¤šï¼Œå¯èƒ½æš—ç¤ºæ‚¨éœ€è¦å…³æ³¨ä¸€ä¸‹å†…å¿ƒçš„æƒ…ç»ªçŠ¶æ€ã€‚');
      }
      
      // åŸºäºç¬”è§¦åˆ†æ
      if (strokeAnalysis.jitterCount / (pathCount.value || 1) > 5) {
        portrait.push('ç”»ä½œä¸­æœ‰äº›æŠ–åŠ¨çš„çº¿æ¡ï¼Œè¿™å¯èƒ½åæ˜ å‡ºæ‚¨æœ€è¿‘æœ‰äº›ç„¦è™‘æˆ–ä¸å®‰ã€‚');
      } else if (strokeAnalysis.averageLength > 100) {
        portrait.push('æµç•…çš„é•¿çº¿æ¡æ˜¾ç¤ºå‡ºæ‚¨æ€è·¯æ¸…æ™°ï¼Œè¡ŒåŠ¨æœæ–­ã€‚');
      }
      
      if (strokeAnalysis.overlapCount > 3) {
        portrait.push('ç”»é¢ä¸­å‡ºç°äº†ä¸€äº›åå¤æ¶‚æŠ¹çš„ç—•è¿¹ï¼Œè¿™å¯èƒ½è¡¨æ˜æ‚¨åœ¨åšå†³å®šæ—¶æœ‰äº›çŠ¹è±«æˆ–çº ç»“ã€‚');
      }
      
      // åŸºäºæ„å›¾åˆ†æ
      if (composition.isTopHeavy) {
        portrait.push('æ‚¨çš„ç”»ä½œé‡å¿ƒåä¸Šï¼Œæ˜¾ç¤ºå‡ºæ‚¨å¯èƒ½æœ‰ä¸°å¯Œçš„æƒ³è±¡åŠ›å’Œç†æƒ³ä¸»ä¹‰å€¾å‘ã€‚');
      } else if (composition.isBottomHeavy) {
        portrait.push('ç”»ä½œçš„é‡å¿ƒåä¸‹ï¼Œè¡¨æ˜æ‚¨å¯èƒ½æ˜¯ä¸€ä¸ªè¸å®ã€æ³¨é‡ç°å®çš„äººã€‚');
      }
      
      if (composition.density > 0.8) {
        portrait.push('ç”»é¢å…ƒç´ è¾ƒä¸ºå¯†é›†ï¼Œå¯èƒ½åæ˜ å‡ºæ‚¨å½“å‰çš„ç”Ÿæ´»æˆ–æ€ç»ªæ¯”è¾ƒå¿™ç¢Œã€‚');
      } else if (composition.density < 0.1) {
        portrait.push('ç”»é¢ç•™æœ‰è¾ƒå¤šç©ºç™½ï¼Œè¿™å¯èƒ½ä»£è¡¨æ‚¨éœ€è¦æ›´å¤šçš„ç©ºé—´æˆ–æ˜¯æœ‰äº›ç–ç¦»æ„Ÿã€‚');
      }
      
      // åŸºäºæ—¶é—´åˆ†æ
      if (timeAnalysis.isLateNight) {
        portrait.push('æ·±å¤œåˆ›ä½œå¯èƒ½è¡¨æ˜æ‚¨çš„æ€ç»ªè¾ƒä¸ºæ´»è·ƒï¼Œæˆ–æ˜¯æœ‰ä¸€äº›æœªè§£å†³çš„é—®é¢˜åœ¨è„‘æµ·ä¸­è¦ç»•ã€‚');
      }
      
      // åŸºäºå‹åŠ›æŒ‡æ•°
      if (stressInfo.score > 60) {
        portrait.push('æ ¹æ®æ‚¨çš„ç”»ä½œç‰¹å¾ï¼Œæ‚¨ç›®å‰å¯èƒ½æ‰¿å—ç€è¾ƒé«˜çš„å‹åŠ›ï¼Œå»ºè®®é€‚å½“æ”¾æ¾å’Œä¼‘æ¯ã€‚');
      } else if (stressInfo.score < 20) {
        portrait.push('æ‚¨çš„ç”»ä½œé€éœ²å‡ºè½»æ¾å’Œå¹³é™çš„æ°›å›´ï¼Œè¿™æ˜¯éå¸¸å¥½çš„çŠ¶æ€ã€‚');
      }
      
      // å¦‚æœæ²¡æœ‰è¶³å¤Ÿçš„ç‰¹å¾ï¼Œæä¾›ä¸€ä¸ªé€šç”¨æè¿°
      if (portrait.length === 0) {
        portrait.push('æ‚¨çš„ç”»ä½œå±•ç°äº†å¹³è¡¡å’Œå’Œè°çš„ç‰¹è´¨ï¼Œè¿™é€šå¸¸ä»£è¡¨ç€ç¨³å®šçš„å¿ƒç†çŠ¶æ€ã€‚');
      }
      
      return portrait.join(' ');
    }
    
    const analyzeDrawing = async () => {
      console.log('ğŸš€ analyzeDrawingå‡½æ•°è¢«è°ƒç”¨äº†ï¼')
      
      // éšè—ç»˜ç”»æç¤º
      showPaintingPrompt.value = false
      
      try {
        console.log('ğŸ” æ£€æŸ¥drawingCanvasæ˜¯å¦å­˜åœ¨:', drawingCanvas.value ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨')
        
        if (!drawingCanvas.value) {
          console.error('âŒ drawingCanvasä¸å­˜åœ¨ï¼');
          alert('ç”»å¸ƒåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ï¼');
          return;
        }
        
        const canvas = drawingCanvas.value;
        console.log('âœ… æˆåŠŸè·å–ç”»å¸ƒå¼•ç”¨')
        
        console.log('ğŸ“Š å°è¯•è·å–ç”»å¸ƒä¸Šä¸‹æ–‡...')
        const ctx = canvas.getContext('2d');
        if (!ctx) {
          console.error('âŒ æ— æ³•è·å–ç”»å¸ƒä¸Šä¸‹æ–‡ï¼');
          alert('æ— æ³•åˆå§‹åŒ–ç”»å¸ƒï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ï¼');
          return;
        }
        console.log('âœ… æˆåŠŸè·å–ç”»å¸ƒä¸Šä¸‹æ–‡')
        
        console.log('ğŸ“¸ å°è¯•è·å–ç”»å¸ƒå›¾åƒæ•°æ®...')
        const imageDataObj = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageDataObj.data;
        console.log('âœ… æˆåŠŸè·å–ç”»å¸ƒå›¾åƒæ•°æ®ï¼Œåƒç´ æ•°é‡:', data.length / 4)
        
        let isEmpty = true;
        console.log('ğŸ” å¼€å§‹æ£€æŸ¥ç”»å¸ƒæ˜¯å¦ä¸ºç©º...')

        // æ£€æŸ¥ç”»å¸ƒæ˜¯å¦ä¸ºç©º
        for (let i = 0; i < data.length; i += 4) {
          if (data[i] !== 255 || data[i + 1] !== 255 || data[i + 2] !== 255 || data[i + 3] !== 0) {
            isEmpty = false;
            break;
          }
        }

        console.log('ğŸ“Š ç”»å¸ƒæ£€æŸ¥å®Œæˆï¼Œæ˜¯å¦ä¸ºç©º:', isEmpty)
        if (isEmpty) {
          console.log('âš ï¸ ç”»å¸ƒä¸ºç©ºï¼Œæç¤ºç”¨æˆ·å…ˆç»˜åˆ¶å†…å®¹')
          alert('ç”»å¸ƒä¸ºç©ºï¼Œè¯·å…ˆç»˜åˆ¶å†…å®¹å†è¿›è¡Œåˆ†æï¼');
          return;
        }
        console.log('âœ… ç”»å¸ƒä¸ä¸ºç©ºï¼Œå¯ä»¥è¿›è¡Œåˆ†æ')
        
        // 1. è¿›è¡Œæœ¬åœ°åˆ†æ
        console.log('ğŸ“Š å¼€å§‹æœ¬åœ°åˆ†æ...')
        
        // è®¡ç®—æ€»ç»˜ç”»æ—¶é—´ï¼ˆç§’ï¼‰
        const totalPaintingTimeSeconds = totalDrawingTime.value / 1000;
        console.log('â±ï¸ æ€»ç»˜ç”»æ—¶é—´:', totalPaintingTimeSeconds.toFixed(2), 'ç§’')
        
        // è‰²å½©åˆ†æ
        const colorAnalysis = analyzeColors(imageDataObj);
        console.log('ğŸ¨ è‰²å½©åˆ†æç»“æœ:', colorAnalysis)
        
        // æ„å›¾åˆ†æ
        const compositionAnalysis = analyzeComposition(imageDataObj, canvas);
        console.log('ğŸ–¼ï¸ æ„å›¾åˆ†æç»“æœ:', compositionAnalysis)
        
        // æäº¤æ—¶é—´åˆ†æ
        const timeAnalysis = analyzeSubmissionTime();
        console.log('ğŸ• æäº¤æ—¶é—´åˆ†æç»“æœ:', timeAnalysis)
        
        // è®¡ç®—å‹åŠ›æŒ‡æ•°
        const stressInfo = calculateStressIndex(colorAnalysis, strokeStats.value, compositionAnalysis, timeAnalysis);
        console.log('ğŸ“Š å‹åŠ›åˆ†æç»“æœ:', stressInfo)
        
        // ç”Ÿæˆæƒ…ç»ªé›·è¾¾å›¾æ•°æ®
        const moodRadarData = generateMoodRadar(colorAnalysis, strokeStats.value, compositionAnalysis);
        console.log('ğŸ“ˆ æƒ…ç»ªé›·è¾¾å›¾æ•°æ®:', moodRadarData)
        
        // ç”Ÿæˆå¿ƒç†ç”»åƒ
        const personalityPortrait = generatePersonalityPortrait(colorAnalysis, strokeStats.value, compositionAnalysis, timeAnalysis, stressInfo);
        console.log('ğŸ‘¤ å¿ƒç†ç”»åƒ:', personalityPortrait)
        
        const imageData = canvas.toDataURL('image/png')
        console.log('ğŸ“¤ å¼€å§‹å‡†å¤‡å‘é€ç”»ä½œè¿›è¡ŒAIåˆ†æ...')
        console.log('ğŸ“Š æ•°æ®å‡†å¤‡å®Œæˆï¼Œå‡†å¤‡æ‰§è¡ŒAPIè°ƒç”¨...')

        // ä½¿ç”¨auth storeè·å–ç”¨æˆ·token
        const token = authStore.getToken;
        console.log('ğŸ”„ å³å°†æ‰§è¡ŒAPIè°ƒç”¨åˆ° /paintings/analyzeï¼Œä½¿ç”¨token:', token ? 'å·²æä¾›' : 'æœªæä¾›')

        // æ˜¾ç¤ºç­‰å¾…åŠ¨ç”»
        const loadingDiv = document.createElement('div');
        loadingDiv.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.5);
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          z-index: 9999;
          font-family: 'Microsoft YaHei', sans-serif;
        `;
        
        const spinner = document.createElement('div');
        spinner.style.cssText = `
          width: 50px;
          height: 50px;
          border: 5px solid #f3f3f3;
          border-top: 5px solid #3498db;
          border-radius: 50%;
          animation: spin 1s linear infinite;
          margin-bottom: 20px;
        `;
        
        const loadingText = document.createElement('div');
        loadingText.textContent = 'æ­£åœ¨ç”Ÿæˆæ‚¨çš„å¿ƒç†ä¾§å†™...';
        loadingText.style.cssText = `
          color: white;
          font-size: 18px;
          font-weight: bold;
        `;
        
        loadingDiv.appendChild(spinner);
        loadingDiv.appendChild(loadingText);
        document.body.appendChild(loadingDiv);
        
        // æ·»åŠ åŠ¨ç”»æ ·å¼
        const styleSheet = document.createElement('style');
        styleSheet.textContent = `
          @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
          }
        `;
        document.head.appendChild(styleSheet);

        try {
          const response = await axios.post('/api/v1/paintings/analyze', {
            image_data_url: imageData,
            painting_mode: currentPaintingMode.value === 'htp' ? 'house_tree_person' : currentPaintingMode.value === 'themed' ? 'theme_painting' : 'free_drawing',
            theme: selectedTheme.value || '',
            painting_time_seconds: totalPaintingTimeSeconds,
            local_analysis: {
              color_analysis: colorAnalysis,
              stroke_analysis: strokeStats.value,
              composition_analysis: compositionAnalysis,
              time_analysis: timeAnalysis
            }
          }, {
            headers: {
              'Authorization': token ? `Bearer ${token}` : ''
            },
            timeout: 30000 // è®¾ç½®30000msè¶…æ—¶ï¼Œå› ä¸ºAIåˆ†æéœ€è¦æ›´å¤šæ—¶é—´
          });

          console.log('âœ… APIè°ƒç”¨å®Œæˆï¼Œæ”¶åˆ°å“åº”ï¼ŒçŠ¶æ€ç :', response.status)
          
          if (response.status === 200) {
            console.log('ğŸ“ å“åº”æ­£å¸¸ï¼Œè·å–åˆ°åˆ†æç»“æœ...')
            const result = response.data;
            console.log('ğŸ“Š æˆåŠŸè·å–AIåˆ†æç»“æœ:', result)
            
            // æ„å»ºå„ç»´åº¦åˆ†æçš„Markdownæ ¼å¼æè¿°
            const buildMarkdownAnalysis = (data) => {
              if (!data) return '';
              let markdown = [];
              for (const [key, value] of Object.entries(data)) {
                // è½¬æ¢ä¸­æ–‡keyä¸ºæ›´å‹å¥½çš„æè¿°
                const keyMap = {
                  'emotion_tendency': 'æƒ…ç»ªå€¾å‘',
                  'cool_color_ratio': 'å†·è‰²è°ƒå æ¯”',
                  'warm_color_ratio': 'æš–è‰²è°ƒå æ¯”',
                  'color_diversity': 'è‰²å½©å¤šæ ·æ€§',
                  'stroke_characteristics': 'çº¿æ¡ç‰¹å¾',
                  'pressure_level': 'åŠ›åº¦æ°´å¹³',
                  'stroke_consistency': 'è¿è´¯æ€§',
                  'emotional_stability': 'æƒ…ç»ªç¨³å®šæ€§',
                  'å¯†åº¦': 'ç”»é¢å¯†åº¦',
                  'space_utilization': 'ç©ºé—´åˆ©ç”¨ç‡',
                  'ä¸­å¿ƒä½ç½®': 'ä¸­å¿ƒä½ç½®',
                  'å…ƒç´ æ’åˆ—æ–¹å¼': 'å…ƒç´ æ’åˆ—æ–¹å¼'
                };
                const displayKey = keyMap[key] || key;
                markdown.push(`- **${displayKey}**: ${value}`);
              }
              return markdown.join('\n');
            };

            // æå–APIè¿”å›çš„ç»“æ„åŒ–æ•°æ®
            const aiContentDescription = result.content_description || 'æš‚æ— å†…å®¹æè¿°';
            const aiAnalysisResult = result.analysis_result || '';
            
            // ä»APIè¿”å›çš„ç»“æ„åŒ–åˆ†æä¸­æå–å„éƒ¨åˆ†æ•°æ®
            const aiColorAnalysis = buildMarkdownAnalysis(result.color_emotion_analysis?.data) || 
                                   (result.color_emotion_analysis?.description ? `- **åˆ†æç»“æœ**: ${result.color_emotion_analysis.description}` : '');
            const aiStrokeAnalysis = buildMarkdownAnalysis(result.brush_dynamics_analysis?.data) || 
                                   (result.brush_dynamics_analysis?.description ? `- **åˆ†æç»“æœ**: ${result.brush_dynamics_analysis.description}` : '');
            const aiCompositionAnalysis = buildMarkdownAnalysis(result.composition_analysis?.data) || 
                                        (result.composition_analysis?.description ? `- **åˆ†æç»“æœ**: ${result.composition_analysis.description}` : '');
            
            // ä½¿ç”¨APIè¿”å›çš„æƒ…ç»ªé›·è¾¾å›¾æ•°æ®
            const apiMoodRadarData = result.mood_radar_data || moodRadarData;
            
            // åˆå¹¶å¤šç»´åº¦åˆ†æå†…å®¹
            const multiDimensionAnalysis = [
              aiColorAnalysis && `**è‰²å½©æƒ…æ„Ÿåˆ†æ**\n${aiColorAnalysis}`,
              aiStrokeAnalysis && `**ç¬”è§¦åŠ¨åŠ›å­¦åˆ†æ**\n${aiStrokeAnalysis}`,
              aiCompositionAnalysis && `**æ„å›¾ä¸ç©ºé—´åˆ†æ**\n${aiCompositionAnalysis}`
            ].filter(Boolean).join('\n\n');
            
            // åˆ›å»ºè¯¦ç»†çš„å¿ƒç†ç”»åƒ - ä¼˜å…ˆä½¿ç”¨APIçš„content_description
            const detailedPersonalityPortrait = aiContentDescription;
            
            // åˆå¹¶æœ¬åœ°åˆ†æå’ŒAIåˆ†æç»“æœï¼Œä¼˜å…ˆä½¿ç”¨APIè¿”å›çš„çœŸå®æ•°æ®
            analysisResult.value = {
              // ä½¿ç”¨APIè¿”å›çš„å‹åŠ›ç›¸å…³æ•°æ®
              stressIndex: apiMoodRadarData?.å‹åŠ›æ°´å¹³ ? apiMoodRadarData.å‹åŠ›æ°´å¹³.toFixed(1) : parseFloat(stressInfo.index),
              stressLevel: apiMoodRadarData?.å‹åŠ›æ°´å¹³ ? 
                (apiMoodRadarData.å‹åŠ›æ°´å¹³ > 7 ? 'é«˜åº¦' : apiMoodRadarData.å‹åŠ›æ°´å¹³ > 4 ? 'ä¸­åº¦' : 'è½»åº¦') : stressInfo.level,
              
              // ä½¿ç”¨APIè¿”å›çš„æƒ…ç»ªé›·è¾¾æ•°æ®
              moodRadar: apiMoodRadarData,
              
              // ä½¿ç”¨AIè¿”å›çš„ä¸ªæ€§åŒ–å¿ƒç†ç”»åƒ
              moodDescription: aiContentDescription,
              explanation: aiAnalysisResult || detailedPersonalityPortrait,
              personalityPortrait: detailedPersonalityPortrait,
              
              aiAnalysis: {
                colorAnalysis: aiColorAnalysis,
                strokeAnalysis: aiStrokeAnalysis,
                compositionAnalysis: aiCompositionAnalysis,
                symbolAnalysis: '', // APIæš‚æœªæä¾›å•ç‹¬çš„ç¬¦å·åˆ†æ
                suggestions: '', // å¯ä»¥ä»content_descriptionä¸­æå–å»ºè®®
                multiDimensionAnalysis: multiDimensionAnalysis || 'AIåˆ†ææš‚ä¸å¯ç”¨ï¼Œä»¥ä¸‹æ˜¯æœ¬åœ°åˆ†æç»“æœ'
              },
              
              // æ·»åŠ è¯¦ç»†åˆ†ææ•°æ®ä¾›å‰ç«¯ä½¿ç”¨
              detailedAnalysis: {
                colorAnalysis: colorAnalysis,
                strokeAnalysis: strokeStats.value,
                compositionAnalysis: compositionAnalysis,
                timeAnalysis: timeAnalysis,
                paintingTime: totalPaintingTimeSeconds
              }
            }
            
            console.log('ğŸ¨ å®Œæ•´åˆ†æç»“æœå·²æ›´æ–°åˆ°UI')
            
            // ç¡®ä¿æƒ…ç»ªé›·è¾¾å›¾åœ¨DOMæ›´æ–°åæ˜¾ç¤ºï¼Œä½¿ç”¨APIè¿”å›çš„æ•°æ®
            setTimeout(() => {
              showMoodRadarChart(apiMoodRadarData);
            }, 100);
            
            // ç§»é™¤ç­‰å¾…åŠ¨ç”»
            document.body.removeChild(loadingDiv);
            document.head.removeChild(styleSheet);
            
            alert('ç»˜ç”»åˆ†æå®Œæˆï¼å·²ç”Ÿæˆæ‚¨çš„æƒ…ç»ªæŠ¥å‘Šå’Œå¿ƒç†ç”»åƒã€‚');
          }
        } catch (apiError) {
          // ç§»é™¤ç­‰å¾…åŠ¨ç”»
          if (loadingDiv && document.body.contains(loadingDiv)) {
            document.body.removeChild(loadingDiv);
          }
          if (styleSheet && document.head.contains(styleSheet)) {
            document.head.removeChild(styleSheet);
          }
          console.warn('âš ï¸ APIè°ƒç”¨å¤±è´¥ï¼Œå°†ä½¿ç”¨æœ¬åœ°åˆ†æç»“æœ:', apiError.message)
          // ç”Ÿæˆæœ¬åœ°å¤šç»´åº¦åˆ†ææè¿°
            const generateLocalMultiDimensionAnalysis = () => {
              let analysis = [];
              
              // è‰²å½©åˆ†ææè¿°
              analysis.push('**è‰²å½©æƒ…æ„Ÿåˆ†æ**');
              if (colorAnalysis.warmToCoolRatio > 1.5) {
                analysis.push('- æš–è‰²è°ƒå ä¸»å¯¼ï¼Œæ˜¾ç¤ºç§¯ææƒ…ç»ª');
              } else if (colorAnalysis.warmToCoolRatio < 0.5) {
                analysis.push('- å†·è‰²è°ƒä¸ºä¸»ï¼Œå¯èƒ½åæ˜ å†·é™æˆ–å†…æ•›æƒ…ç»ª');
              } else {
                analysis.push('- è‰²å½©å¹³è¡¡ï¼Œæƒ…ç»ªç¨³å®š');
              }
            
            // ç¬”è§¦åˆ†ææè¿°
            analysis.push('\n**ç¬”è§¦åŠ¨åŠ›å­¦åˆ†æ**');
            if (strokeStats.value.jitterCount / (pathCount.value || 1) > 5) {
              analysis.push('- çº¿æ¡æœ‰äº›æŠ–åŠ¨ï¼Œå¯èƒ½æœ‰äº›ç„¦è™‘');
            } else {
              analysis.push('- çº¿æ¡æµç•…ï¼Œæƒ…ç»ªç¨³å®š');
            }
            analysis.push(`- çº¿æ¡æ•°é‡: ${strokeStats.value.pathCount || 0}æ¡`);
            analysis.push(`- å¹³å‡é•¿åº¦: ${Math.round(strokeStats.value.averageLength || 0)}px`);
            
            // æ„å›¾åˆ†ææè¿°
            analysis.push('\n**æ„å›¾ä¸ç©ºé—´åˆ†æ**');
            if (compositionAnalysis.density > 0.8) {
              analysis.push('- ç”»é¢å¯†é›†ï¼Œæ€ç»ªæ´»è·ƒ');
            } else if (compositionAnalysis.density < 0.1) {
              analysis.push('- ç”»é¢ç•™ç™½å¤šï¼Œéœ€è¦æ›´å¤šè¡¨è¾¾');
            } else {
              analysis.push('- æ„å›¾å¹³è¡¡ï¼Œæ€ç»´æ¸…æ™°');
            }
            analysis.push(`- é‡å¿ƒä½ç½®: ${compositionAnalysis.centerOfGravity || 'å±…ä¸­'}`);
            
            return analysis.join('\n');
          };
          
          // åˆ›å»ºæ›´è¯¦ç»†çš„æœ¬åœ°å¿ƒç†ç”»åƒ
          const detailedLocalPortrait = `${personalityPortrait} æ‚¨çš„ç»˜ç”»å±•ç°äº†ç‹¬ç‰¹çš„ä¸ªäººé£æ ¼ï¼Œåæ˜ å‡ºæ‚¨ä½œä¸ºè€ƒç ”å­¦ç”Ÿçš„å†…å¿ƒä¸–ç•Œã€‚ä»è‰²å½©ä½¿ç”¨ã€ç¬”è§¦ç‰¹å¾å’Œæ„å›¾æ–¹å¼å¯ä»¥çœ‹å‡ºæ‚¨çš„æ€è€ƒæ¨¡å¼å’Œæƒ…ç»ªçŠ¶æ€ã€‚å»ºè®®æ‚¨åœ¨å¤‡è€ƒè¿‡ç¨‹ä¸­ä¿æŒè¿™ç§è¡¨è¾¾å’Œè‡ªæˆ‘è§‰å¯Ÿçš„ä¹ æƒ¯ï¼Œè¿™å¯¹å¿ƒç†å¥åº·éå¸¸æœ‰ç›Šã€‚`;
          
          // å¦‚æœAPIè°ƒç”¨å¤±è´¥ï¼Œåªä½¿ç”¨æœ¬åœ°åˆ†æç»“æœ
          analysisResult.value = {
            stressIndex: parseFloat(stressInfo.index),
            stressLevel: stressInfo.level,
            moodRadar: moodRadarData,
            moodDescription: 'åŸºäºæœ¬åœ°åˆ†æçš„ç”»ä½œè§£è¯»',
            explanation: detailedLocalPortrait,
            personalityPortrait: detailedLocalPortrait,
            aiAnalysis: {
              multiDimensionAnalysis: generateLocalMultiDimensionAnalysis()
            },
            detailedAnalysis: {
              colorAnalysis: colorAnalysis,
              strokeAnalysis: strokeStats.value,
              compositionAnalysis: compositionAnalysis,
              timeAnalysis: timeAnalysis,
              paintingTime: totalPaintingTimeSeconds
            }
          }
          
          // ç§»é™¤ç­‰å¾…åŠ¨ç”»
          if (loadingDiv && document.body.contains(loadingDiv)) {
            document.body.removeChild(loadingDiv);
          }
          if (styleSheet && document.head.contains(styleSheet)) {
            document.head.removeChild(styleSheet);
          }
          
          console.log('ğŸ¨ æœ¬åœ°åˆ†æç»“æœå·²æ›´æ–°åˆ°UI')
          
          // æ˜¾ç¤ºæƒ…ç»ªé›·è¾¾å›¾
          showMoodRadarChart(moodRadarData);
          
          alert('å·²ä½¿ç”¨æœ¬åœ°åˆ†æå¼•æ“å®Œæˆç»˜ç”»åˆ†æï¼ç”Ÿæˆäº†æ‚¨çš„æƒ…ç»ªæŠ¥å‘Šå’Œå¿ƒç†ç”»åƒã€‚');
        }
      } catch (error) {
        console.error('åˆ†æè¿‡ç¨‹ä¸­å‡ºé”™:', error);
        console.error('é”™è¯¯ç±»å‹:', error.name);
        console.error('é”™è¯¯ä¿¡æ¯:', error.message);
        
        // å¢å¼ºçš„é”™è¯¯è¯Šæ–­ä¿¡æ¯
        if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
          console.error('âš ï¸ è¿æ¥é”™è¯¯ï¼šæ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡å™¨ã€‚è¯·æ£€æŸ¥ï¼š');
          console.error('1. åç«¯æœåŠ¡å™¨æ˜¯å¦æ­£åœ¨è¿è¡Œ');
          console.error('2. åç«¯ç«¯å£8000æ˜¯å¦æ­£ç¡®');
          console.error('3. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸');
          alert('è¿æ¥é”™è¯¯ï¼šæ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡å™¨ã€‚è¯·ç¡®ä¿æœåŠ¡å™¨æ­£åœ¨è¿è¡Œå¹¶æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚');
        }
        
        // æ˜¾ç¤ºçœŸå®é”™è¯¯ä¿¡æ¯
        analysisResult.value = {
          stressIndex: '0.0',
          stressLevel: '-',
          moodRadar: {},
          moodDescription: 'åˆ†æå¤±è´¥',
          explanation: `åˆ†æé”™è¯¯ï¼š${error.message}`
        }

        alert(`åˆ†æå¤±è´¥ï¼š${error.message}`);
      }
    }
    
    // æ˜¾ç¤ºæƒ…ç»ªé›·è¾¾å›¾
    const showMoodRadarChart = (moodData) => {
      console.log('ğŸ“Š å‡†å¤‡æ˜¾ç¤ºæƒ…ç»ªé›·è¾¾å›¾:', moodData)
      
      // ä½¿ç”¨Canvas APIç»˜åˆ¶é›·è¾¾å›¾
      const canvas = document.getElementById('moodRadarChart');
      if (!canvas) return;
      
      // è®¾ç½®canvasçš„å®é™…åƒç´ å°ºå¯¸ï¼Œç¡®ä¿ç»˜åˆ¶æ¯”ä¾‹æ­£ç¡®
      const container = canvas.parentElement;
      const rect = container.getBoundingClientRect();
      const size = Math.min(rect.width, rect.height);
      canvas.width = size;
      canvas.height = size;
      
      const ctx = canvas.getContext('2d');
      if (!ctx) return;
      
      // æ¸…ç©ºç”»å¸ƒ
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // é»˜è®¤æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰æä¾›æ•°æ®
      const defaultData = {
        happy: 60,
        calm: 50,
        anxious: 30,
        sad: 20,
        angry: 10,
        creative: 70
      };
      
      const data = moodData || defaultData;
      
      // æ£€æŸ¥æ˜¯å¦æ˜¯APIè¿”å›çš„ä¸­æ–‡é”®åæ•°æ®
      const isChineseKeyFormat = Object.keys(data).some(key => key.includes('åº¦') || key.includes('æ°´å¹³') || key.includes('æƒ…ç»ª'));
      
      let labels, values;
      
      if (isChineseKeyFormat) {
        // å¤„ç†APIè¿”å›çš„ä¸­æ–‡é”®åæ•°æ®
        labels = ['ç§¯ææƒ…ç»ª', 'ä¸“æ³¨åº¦', 'ç„¦è™‘ç¨‹åº¦', 'å‹åŠ›æ°´å¹³', 'æƒ…ç»ªç¨³å®šæ€§', 'åˆ›é€ åŠ›'];
        // ä½¿ç”¨å®‰å…¨çš„å±æ€§è®¿é—®ï¼Œç¡®ä¿å³ä½¿æ•°æ®ç¼ºå¤±ä¹Ÿä¸ä¼šå‡ºé”™
        values = [
          data['ç§¯ææƒ…ç»ª'] || 0,
          data['ä¸“æ³¨åº¦'] || 0,
          data['ç„¦è™‘ç¨‹åº¦'] || 0,
          data['å‹åŠ›æ°´å¹³'] || 0,
          data['æƒ…ç»ªç¨³å®šæ€§'] || 0,
          data['åˆ›é€ åŠ›'] || 0
        ];
      } else {
        // å¤„ç†åŸå§‹è‹±æ–‡é”®åæ•°æ®
        labels = ['å¿«ä¹', 'å¹³é™', 'ç„¦è™‘', 'æ‚²ä¼¤', 'æ„¤æ€’', 'åˆ›é€ åŠ›'];
        values = [data.happy || 0, data.calm || 0, data.anxious || 0, data.sad || 0, data.angry || 0, data.creative || 0];
      }
      
      // ä¿æŒæ•°æ®åŸå§‹èŒƒå›´ï¼ŒAPIè¿”å›çš„ä¸­æ–‡é”®åæ•°æ®èŒƒå›´æ˜¯0-10ï¼Œæ— éœ€ä¹˜ä»¥10
      // è¿™æ ·å¯ä»¥ç¡®ä¿é›·è¾¾å›¾æ¯”ä¾‹æ­£ç¡®
      
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;
      // å‡å°åŠå¾„ï¼Œç¡®ä¿æ ‡ç­¾ä¸ä¼šè¢«æˆªæ–­
      const radius = Math.min(centerX, centerY) * 0.7;
      const angleStep = (2 * Math.PI) / values.length;
      
      // ç»˜åˆ¶ç½‘æ ¼
      ctx.strokeStyle = '#e0e0e0';
      ctx.lineWidth = 1;
      
      for (let level = 1; level <= 5; level++) {
        const levelRadius = (radius / 5) * level;
        ctx.beginPath();
        
        for (let i = 0; i < values.length; i++) {
          const angle = i * angleStep - Math.PI / 2;
          const x = centerX + levelRadius * Math.cos(angle);
          const y = centerY + levelRadius * Math.sin(angle);
          
          if (i === 0) {
            ctx.moveTo(x, y);
          } else {
            ctx.lineTo(x, y);
          }
        }
        
        ctx.closePath();
        ctx.stroke();
      }
      
      // ç»˜åˆ¶è½´çº¿
      ctx.strokeStyle = '#999';
      ctx.lineWidth = 1;
      
      for (let i = 0; i < values.length; i++) {
        const angle = i * angleStep - Math.PI / 2;
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.lineTo(centerX + radius * Math.cos(angle), centerY + radius * Math.sin(angle));
        ctx.stroke();
      }
      
      // ç»˜åˆ¶æ•°æ®åŒºåŸŸ
      ctx.fillStyle = 'rgba(102, 126, 234, 0.2)';
      ctx.strokeStyle = '#667eea';
      ctx.lineWidth = 3;
      ctx.beginPath();
      
      for (let i = 0; i < values.length; i++) {
        const angle = i * angleStep - Math.PI / 2;
        // è°ƒæ•´è®¡ç®—æ–¹å¼ï¼Œå› ä¸ºæ•°æ®èŒƒå›´æ˜¯0-10è€Œä¸æ˜¯0-100
        const valueRadius = (radius / 10) * values[i];
        const x = centerX + valueRadius * Math.cos(angle);
        const y = centerY + valueRadius * Math.sin(angle);
        
        if (i === 0) {
          ctx.moveTo(x, y);
        } else {
          ctx.lineTo(x, y);
        }
      }
      
      ctx.closePath();
      ctx.fill();
      ctx.stroke();
      
      // ç»˜åˆ¶æ•°æ®ç‚¹
      ctx.fillStyle = '#764ba2';
      for (let i = 0; i < values.length; i++) {
        const angle = i * angleStep - Math.PI / 2;
        // è°ƒæ•´è®¡ç®—æ–¹å¼ï¼Œä¸æ•°æ®åŒºåŸŸä¿æŒä¸€è‡´
        const valueRadius = (radius / 10) * values[i];
        const x = centerX + valueRadius * Math.cos(angle);
        const y = centerY + valueRadius * Math.sin(angle);
        
        ctx.beginPath();
        ctx.arc(x, y, 5, 0, 2 * Math.PI);
        ctx.fill();
      }
      
      // ç»˜åˆ¶æ ‡ç­¾ - è°ƒæ•´ä½ç½®ä»¥é€‚åº”å¢å¤§çš„é›·è¾¾å›¾
      ctx.fillStyle = '#2c3e50';
      ctx.font = '16px Arial';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      
      for (let i = 0; i < values.length; i++) {
        const angle = i * angleStep - Math.PI / 2;
        // æ ‡ç­¾ä½ç½®è°ƒæ•´ä¸ºåŠå¾„çš„1.1å€ï¼Œç¡®ä¿åœ¨é›·è¾¾å›¾å¤–å›´ä¸”ä¸è¶…å‡ºç”»å¸ƒ
        const labelRadius = radius * 1.1;
        const x = centerX + labelRadius * Math.cos(angle);
        const y = centerY + labelRadius * Math.sin(angle);
        
        ctx.fillText(labels[i], x, y);
      }
    }
    
    // è·å–å‹åŠ›ç­‰çº§å¯¹åº”çš„æ ·å¼ç±»
    const getStressLevelClass = (level) => {
      switch (level) {
        case 'ä½':
          return 'stress-level-low';
        case 'ä¸­':
          return 'stress-level-medium';
        case 'é«˜':
          return 'stress-level-high';
        default:
          return '';
      }
    }
    
    // è·å–æäº¤æ—¶é—´åˆ†ç±»æ–‡æœ¬
    const getTimeCategoryText = (category) => {
      const categoryMap = {
        morning: 'æ—©æ™¨ï¼ˆ6:00-12:00ï¼‰',
        afternoon: 'ä¸‹åˆï¼ˆ12:00-18:00ï¼‰',
        evening: 'æ™šä¸Šï¼ˆ18:00-23:00ï¼‰',
        night: 'æ·±å¤œï¼ˆ23:00-6:00ï¼‰'
      };
      return categoryMap[category] || category;
    }
    
    // æ ¼å¼åŒ–Markdowné£æ ¼çš„åˆ†æå†…å®¹ä¸ºHTML
    const formatMarkdownAnalysis = (text) => {
      if (!text) return '';
      
      // é¦–å…ˆç§»é™¤æ‰€æœ‰ä¸å¿…è¦çš„æ ‡ç‚¹ç¬¦å·å’Œæ¨ªæ 
      let formatted = text
        .replace(/[ï¼š:ï¼›;ã€‚ã€,ï¼Œ.]\s*$/gm, '')  // ç§»é™¤è¡Œå°¾çš„æ ‡ç‚¹ç¬¦å·
        .replace(/^\s*-\s*/gm, '')  // ç§»é™¤è¡Œé¦–çš„æ¨ªæ å’Œç©ºæ ¼
        .replace(/^\s*â€¢\s*/gm, '')  // ç§»é™¤è¡Œé¦–çš„ç‚¹å·å’Œç©ºæ ¼
        .replace(/^\s*\*\s*/gm, '')  // ç§»é™¤è¡Œé¦–çš„æ˜Ÿå·å’Œç©ºæ ¼
        .replace(/\*([^*]*)\*/g, '$1')  // ç§»é™¤æ–‡æœ¬ä¸­é—´çš„å•ä¸ªæ˜Ÿå·
        .replace(/\*\*(.*?)\*\*\s*[:ï¼š]/g, '<h4>$1</h4>')  // å°†**æ ‡é¢˜**: è½¬æ¢ä¸ºh4ï¼Œå»æ‰å†’å·
        .replace(/\*\*(.*?)\*\*/g, '<h4>$1</h4>');      // å°†**æ ‡é¢˜**è½¬æ¢ä¸ºh4
      
      // å¤„ç†é”®å€¼å¯¹æ ¼å¼
      formatted = formatted.replace(/^([^:ï¼š]+)[ï¼š:](.*)$/gm, '<p><strong>$1</strong><span>$2</span></p>');
      
      return formatted;
    }
    
    // ç”Ÿæˆè‰²å½©åˆ†ææŠ¥å‘Š
    const generateColorAnalysis = (colorData) => {
      if (!colorData) return 'è‰²å½©åˆ†ææ•°æ®åŠ è½½ä¸­...';
      
      const analysis = [];
      
      // è‰²å½©æƒ…æ„Ÿå€¾å‘
      if (colorData.warmToCoolRatio > 1.5) {
        analysis.push('**æƒ…æ„Ÿå€¾å‘**: æ¸©æš–ç§¯æï¼Œå……æ»¡æ´»åŠ›');
      } else if (colorData.warmToCoolRatio < 0.5) {
        analysis.push('**æƒ…æ„Ÿå€¾å‘**: å†·é™å†…æ•›ï¼Œæ€ç»´ç†æ€§');
      } else {
        analysis.push('**æƒ…æ„Ÿå€¾å‘**: å¹³è¡¡å’Œè°ï¼Œæƒ…ç»ªç¨³å®š');
      }
      
      // è‰²å½©å¤šæ ·æ€§
      analysis.push(`**è‰²å½©å¤šæ ·æ€§**: ${colorData.colorDiversity > 20 ? 'ä¸°å¯Œ' : colorData.colorDiversity > 10 ? 'é€‚ä¸­' : 'å•ä¸€'}`);
      
      return analysis.join('\n');
    };
    
    // ç”Ÿæˆç¬”è§¦åˆ†ææŠ¥å‘Š
    const generateBrushAnalysis = (brushData) => {
      if (!brushData) return 'ç¬”è§¦åˆ†ææ•°æ®åŠ è½½ä¸­...';
      
      const analysis = [];
      
      // çº¿æ¡æµç•…æ€§
      if (brushData.averageLength > 100) {
        analysis.push('**çº¿æ¡ç‰¹ç‚¹**: æµç•…è‡ªä¿¡ï¼Œæ€ç»´å¼€é˜”');
      } else if (brushData.averageLength > 50) {
        analysis.push('**çº¿æ¡ç‰¹ç‚¹**: ç¨³å¥æœ‰åºï¼Œè®¡åˆ’æ€§å¼º');
      } else {
        analysis.push('**çº¿æ¡ç‰¹ç‚¹**: ç»†è‡´è°¨æ…ï¼Œæ³¨é‡ç»†èŠ‚');
      }
      
      // çº¿æ¡è¿ç»­æ€§
      if (brushData.continuity > 0.8) {
        analysis.push('**çº¿æ¡è¿ç»­æ€§**: é«˜ï¼Œæ³¨æ„åŠ›é›†ä¸­');
      } else {
        analysis.push('**çº¿æ¡è¿ç»­æ€§**: ä¸­ä½ï¼Œæ€ç»´æ´»è·ƒæˆ–æ˜“åˆ†æ•£');
      }
      
      return analysis.join('\n');
    };
    
    // ç”Ÿæˆæ„å›¾åˆ†ææŠ¥å‘Š
    const generateCompositionAnalysis = (compositionData) => {
      if (!compositionData) return 'æ„å›¾åˆ†ææ•°æ®åŠ è½½ä¸­...';
      
      const analysis = [];
      
      // ç”»é¢å¯†åº¦
      if (compositionData.density > 0.8) {
        analysis.push('**ç”»é¢å¯†åº¦**: é«˜ï¼Œä¿¡æ¯ä¸°å¯Œæˆ–å‹åŠ›è¾ƒå¤§');
      } else if (compositionData.density < 0.1) {
        analysis.push('**ç”»é¢å¯†åº¦**: ä½ï¼Œæ€ç»´å¼€é˜”æˆ–æƒ…ç»ªå¹³é™');
      } else {
        analysis.push('**ç”»é¢å¯†åº¦**: é€‚ä¸­ï¼Œå¹³è¡¡æ„Ÿè‰¯å¥½');
      }
      
      // ç©ºé—´åˆ©ç”¨
      analysis.push(`**ç©ºé—´åˆ©ç”¨ç‡**: ${Math.round((compositionData.density || 0) * 100)}%`);
      
      // é‡å¿ƒä½ç½®
      analysis.push(`**é‡å¿ƒä½ç½®**: ${compositionData.centerOfGravity || 'å±…ä¸­'}`);
      
      return analysis.join('\n');
    };

    const goBack = () => {
      router.push('/dashboard')
    }

    const generateIntervention = async () => {
      if (!drawingCanvas.value) {
        console.log('æ— æ³•ç”Ÿæˆå¿ƒçµé•œåƒï¼šç”»å¸ƒä¸å­˜åœ¨')
        alert('ç”»å¸ƒåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·é‡æ–°å°è¯•ï¼')
        return
      }
      
      isGeneratingMindMirror.value = true
      mindMirrorResult.value = null
      
      try {
        // è·å–ç”»å¸ƒå›¾åƒæ•°æ®
        const canvas = drawingCanvas.value
        const imageData = canvas.toDataURL('image/png')
        console.log('ğŸ“¤ å¼€å§‹å‘é€ç”»ä½œç”Ÿæˆå¿ƒçµé•œåƒ...')
        
        // å‡†å¤‡è¯·æ±‚é…ç½®
        const requestConfig = {
          timeout: 30000 // è®¾ç½®30000msè¶…æ—¶ï¼Œå› ä¸ºAIç”Ÿæˆéœ€è¦æ›´å¤šæ—¶é—´
        }
        
        // åªæœ‰å½“tokenå­˜åœ¨æ—¶æ‰æ·»åŠ è®¤è¯å¤´
        const token = localStorage.getItem('token')
        if (token) {
          requestConfig.headers = {
            'Authorization': `Bearer ${token}`
          }
        }
        
        // è°ƒç”¨åç«¯APIç”Ÿæˆå¿ƒçµé•œåƒ
        const response = await axios.post('/api/v1/paintings/generate-mind-mirror', {
          image_data_url: imageData
        }, requestConfig)
        
        if (response.data.success) {
          mindMirrorResult.value = {
            positive_image_description: response.data.positive_image_description,
            guidance_text: response.data.guidance_text,
            is_real_mirror: response.data.is_real_mirror
          }
          console.log('å¿ƒçµé•œåƒç”ŸæˆæˆåŠŸ:', mindMirrorResult.value)
        } else {
          console.error('ç”Ÿæˆå¿ƒçµé•œåƒå¤±è´¥:', response.data.message)
          // ä½¿ç”¨é»˜è®¤å“åº”
          mindMirrorResult.value = {
            positive_image_description: response.data.positive_image_description || 'è¿™æ˜¯ä¸€å¹…å……æ»¡é˜³å…‰å’Œå¸Œæœ›çš„ç”»é¢ï¼Œè‰²å½©æ˜äº®æ¸©æš–ï¼Œæ„å›¾å’Œè°å¹³è¡¡ã€‚',
            guidance_text: response.data.guidance_text || 'çœ‹ï¼Œå¦‚æœç»™è¿™é‡ŒåŠ ä¸€ç¼•é˜³å…‰ï¼Œæ˜¯ä¸æ˜¯æ„Ÿè§‰å……æ»¡äº†å¸Œæœ›ï¼Ÿ',
            is_real_mirror: false
          }
        }
        
        // å¤åˆ¶åŸå§‹ç”»å¸ƒåˆ°é¢„è§ˆç”»å¸ƒ
        setTimeout(() => {
          // ç¡®ä¿ç”»å¸ƒå¼•ç”¨å­˜åœ¨
          if (!originalPaintingPreview.value || !drawingCanvas.value) {
            console.error('ç”»å¸ƒå¼•ç”¨ä¸å­˜åœ¨ï¼Œæ— æ³•æ¸²æŸ“é¢„è§ˆ')
            return
          }
          
          try {
            // è·å–ç”»å¸ƒä¸Šä¸‹æ–‡
            const previewCtx = originalPaintingPreview.value.getContext('2d')
            const originalCanvas = drawingCanvas.value
            
            // æ¸…ç©ºé¢„è§ˆç”»å¸ƒ
            previewCtx.clearRect(0, 0, 300, 250)
            
            // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹ä»¥é€‚åº”é¢„è§ˆåŒºåŸŸ
            const scaleX = 300 / originalCanvas.width
            const scaleY = 250 / originalCanvas.height
            const scale = Math.min(scaleX, scaleY)
            
            // è®¡ç®—å±…ä¸­ä½ç½®
            const offsetX = (300 - originalCanvas.width * scale) / 2
            const offsetY = (250 - originalCanvas.height * scale) / 2
            
            // ç»˜åˆ¶ç¼©æ”¾åçš„ç”»å¸ƒå†…å®¹
            previewCtx.drawImage(
              originalCanvas,
              0, 0, originalCanvas.width, originalCanvas.height,
              offsetX, offsetY, originalCanvas.width * scale, originalCanvas.height * scale
            )
            
            // æ¸²æŸ“ç§¯æç‰ˆæœ¬é¢„è§ˆï¼ˆä½¿ç”¨ç›¸åŒçš„ç”»å¸ƒæ•°æ®ï¼‰
            if (positivePaintingPreview.value) {
              const positiveCtx = positivePaintingPreview.value.getContext('2d')
              
              // æ¸…ç©ºé¢„è§ˆç”»å¸ƒ
              positiveCtx.clearRect(0, 0, 300, 250)
              
              // ç»˜åˆ¶ç¼©æ”¾åçš„ç”»å¸ƒå†…å®¹
              positiveCtx.drawImage(
                originalCanvas,
                0, 0, originalCanvas.width, originalCanvas.height,
                offsetX, offsetY, originalCanvas.width * scale, originalCanvas.height * scale
              )
              
              // ä¸ºç§¯æç‰ˆæœ¬æ·»åŠ ä¸€äº›è§†è§‰æ•ˆæœï¼Œä½¿å…¶çœ‹èµ·æ¥æ›´ç§¯æ
              positiveCtx.globalCompositeOperation = 'multiply'
              positiveCtx.fillStyle = 'rgba(255, 240, 200, 0.3)'
              positiveCtx.fillRect(0, 0, 300, 250)
              positiveCtx.globalCompositeOperation = 'source-over'
            }
          } catch (error) {
            console.error('æ¸²æŸ“ç”»å¸ƒé¢„è§ˆæ—¶å‡ºé”™:', error)
          }
        }, 300) // å¢åŠ å»¶è¿Ÿç¡®ä¿DOMå®Œå…¨æ›´æ–°
        
        // æ˜¾ç¤ºå¿ƒçµé•œåƒç»“æœå¯¹è¯æ¡†
        showMindMirrorDialog.value = true
      } catch (error) {
        console.error('ç”Ÿæˆå¿ƒçµé•œåƒå¼‚å¸¸:', error)
        // é”™è¯¯æ—¶ä½¿ç”¨é»˜è®¤å€¼
        mindMirrorResult.value = {
          positive_image_description: 'è¿™æ˜¯ä¸€å¹…å……æ»¡é˜³å…‰å’Œå¸Œæœ›çš„ç”»é¢ï¼Œè‰²å½©æ˜äº®æ¸©æš–ï¼Œæ„å›¾å’Œè°å¹³è¡¡ã€‚',
          guidance_text: 'çœ‹ï¼Œå¦‚æœç»™è¿™é‡ŒåŠ ä¸€ç¼•é˜³å…‰ï¼Œæ˜¯ä¸æ˜¯æ„Ÿè§‰å……æ»¡äº†å¸Œæœ›ï¼Ÿ',
          is_real_mirror: false
        }
        
        // å¤åˆ¶åŸå§‹ç”»å¸ƒåˆ°é¢„è§ˆç”»å¸ƒ
        setTimeout(() => {
          // ç¡®ä¿ç”»å¸ƒå¼•ç”¨å­˜åœ¨
          if (!originalPaintingPreview.value || !drawingCanvas.value) {
            console.error('ç”»å¸ƒå¼•ç”¨ä¸å­˜åœ¨ï¼Œæ— æ³•æ¸²æŸ“é¢„è§ˆ')
            return
          }
          
          try {
            // è·å–ç”»å¸ƒä¸Šä¸‹æ–‡
            const previewCtx = originalPaintingPreview.value.getContext('2d')
            const originalCanvas = drawingCanvas.value
            
            // æ¸…ç©ºé¢„è§ˆç”»å¸ƒ
            previewCtx.clearRect(0, 0, 300, 250)
            
            // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹ä»¥é€‚åº”é¢„è§ˆåŒºåŸŸ
            const scaleX = 300 / originalCanvas.width
            const scaleY = 250 / originalCanvas.height
            const scale = Math.min(scaleX, scaleY)
            
            // è®¡ç®—å±…ä¸­ä½ç½®
            const offsetX = (300 - originalCanvas.width * scale) / 2
            const offsetY = (250 - originalCanvas.height * scale) / 2
            
            // ç»˜åˆ¶ç¼©æ”¾åçš„ç”»å¸ƒå†…å®¹
            previewCtx.drawImage(
              originalCanvas,
              0, 0, originalCanvas.width, originalCanvas.height,
              offsetX, offsetY, originalCanvas.width * scale, originalCanvas.height * scale
            )
            
            // æ¸²æŸ“ç§¯æç‰ˆæœ¬é¢„è§ˆï¼ˆä½¿ç”¨ç›¸åŒçš„ç”»å¸ƒæ•°æ®ï¼‰
            if (positivePaintingPreview.value) {
              const positiveCtx = positivePaintingPreview.value.getContext('2d')
              
              // æ¸…ç©ºé¢„è§ˆç”»å¸ƒ
              positiveCtx.clearRect(0, 0, 300, 250)
              
              // ç»˜åˆ¶ç¼©æ”¾åçš„ç”»å¸ƒå†…å®¹
              positiveCtx.drawImage(
                originalCanvas,
                0, 0, originalCanvas.width, originalCanvas.height,
                offsetX, offsetY, originalCanvas.width * scale, originalCanvas.height * scale
              )
              
              // ä¸ºç§¯æç‰ˆæœ¬æ·»åŠ ä¸€äº›è§†è§‰æ•ˆæœï¼Œä½¿å…¶çœ‹èµ·æ¥æ›´ç§¯æ
              positiveCtx.globalCompositeOperation = 'multiply'
              positiveCtx.fillStyle = 'rgba(255, 240, 200, 0.3)'
              positiveCtx.fillRect(0, 0, 300, 250)
              positiveCtx.globalCompositeOperation = 'source-over'
            }
          } catch (error) {
            console.error('æ¸²æŸ“ç”»å¸ƒé¢„è§ˆæ—¶å‡ºé”™:', error)
          }
        }, 300) // å¢åŠ å»¶è¿Ÿç¡®ä¿DOMå®Œå…¨æ›´æ–°
        
        showMindMirrorDialog.value = true
      } finally {
        isGeneratingMindMirror.value = false
      }
    }
    
    // è¯­éŸ³å¼•å¯¼ç›¸å…³çŠ¶æ€
    const isGeneratingGuidance = ref(false)
    const currentGuidance = ref(null)
    const isPlayingGuidance = ref(false)
    const isGeneratingStory = ref(false)
    const healingStory = ref(null)
    // å¿ƒçµé•œåƒç›¸å…³çŠ¶æ€
    const isGeneratingMindMirror = ref(false)
    const mindMirrorResult = ref(null)
    const originalPaintingPreview = ref(null)
    const positivePaintingPreview = ref(null)
    
    // ç”Ÿæˆå¹¶æ’­æ”¾æ­£å¿µç»˜ç”»å¼•å¯¼
    const generateAndPlayMindfulnessGuidance = async () => {
      if (isPlayingGuidance.value) {
        // å¦‚æœæ­£åœ¨æ’­æ”¾ï¼Œåœæ­¢æ’­æ”¾
        stopGuidanceSpeech()
        return
      }
      
      try {
        isGeneratingGuidance.value = true
        
        // å¦‚æœå·²æœ‰å¼•å¯¼æ–‡æœ¬ï¼Œç›´æ¥æ’­æ”¾
        if (currentGuidance.value) {
          playGuidanceSpeech()
          isGeneratingGuidance.value = false
          return
        }
        
        // å¯ç”¨APIè°ƒç”¨ï¼Œä½¿ç”¨åç«¯AIç”ŸæˆåŠŸèƒ½
        const useApiCall = true;
        
        // ç›´æ¥ä½¿ç”¨æœ¬åœ°åˆ†æç»“æœè°ƒç”¨APIï¼ˆå¦‚æœæœ‰ï¼‰
        // ç®€åŒ–æµç¨‹ï¼šä¸ç®¡ç”»å¸ƒæ˜¯å¦å·²ä¿å­˜ï¼Œéƒ½å°è¯•ä½¿ç”¨ç°æœ‰åˆ†ææ•°æ®
        if (useApiCall && analysisResult.value) {
          try {
            // ç›´æ¥å‘é€æœ¬åœ°åˆ†æç»“æœåˆ°åç«¯ç”Ÿæˆå¼•å¯¼ï¼Œæ— éœ€ä¾èµ–ç”»ä½œID
            console.log('Generating guidance using local analysis data');
            const response = await axios.post(`/api/v1/paintings/generate-guidance-direct`, {
              painting_analysis: analysisResult.value
            }, {
              headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
              },
              timeout: 6000
            })
            
            if (response.data && response.data.success) {
              currentGuidance.value = response.data.guidance.guidance_text
              
              // æ¸…ç©ºç”»å¸ƒï¼Œå‡†å¤‡æ–°çš„åˆ›ä½œ
              clearCanvas()
              
              // æ’­æ”¾å¼•å¯¼è¯­éŸ³
              playGuidanceSpeech()
              
              alert('AIä¸ªæ€§åŒ–å¼•å¯¼å·²ç”Ÿæˆï¼Œè¯·è·Ÿéšå¼•å¯¼è¿›è¡Œåˆ›ä½œ')
              isGeneratingGuidance.value = false
              return
            }
          } catch (apiError) {
            console.warn('ç›´æ¥APIè°ƒç”¨å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æ–¹æ¡ˆ:', apiError.message);
            // ç»§ç»­æ‰§è¡Œï¼Œå°è¯•å…¶ä»–æ–¹æ¡ˆ
          }
        }
        
        // å¤‡ç”¨æ–¹æ¡ˆï¼šæ£€æŸ¥æ˜¯å¦æœ‰å·²ä¿å­˜çš„ç”»å¸ƒ
        // æ£€æµ‹æ˜¯å¦ä¸ºæ—¶é—´æˆ³æ ¼å¼çš„ä¸´æ—¶IDï¼ˆçº¯æ•°å­—ä¸”é•¿åº¦ä¸º13ä½æˆ–10ä½ï¼‰
        const isTimestampId = currentCanvasId.value && /^\d{10,13}$/.test(currentCanvasId.value);
        const isSavedCanvas = currentCanvasId.value && 
          !isTimestampId && 
          savedCanvases.value.some(c => c.id === currentCanvasId.value) &&
          !isDefaultName.value;
        
        console.log('Canvas ID validation:', {
          id: currentCanvasId.value,
          isSavedCanvas,
          isTimestampId,
          hasLocalAnalysis: !!analysisResult.value,
          isDefaultName: isDefaultName.value
        });
        
        if (isSavedCanvas && useApiCall) {
          try {
            // è°ƒç”¨åç«¯APIç”Ÿæˆå¼•å¯¼æ–‡æœ¬ï¼Œè®¾ç½®6000msè¶…æ—¶ï¼Œå¹¶æ·»åŠ è®¤è¯å¤´
            console.log('Generating guidance for painting ID:', currentCanvasId.value);
            const response = await axios.post(`/api/v1/paintings/generate-guidance/${currentCanvasId.value}`, {}, {
              headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
              },
              timeout: 6000
            })
            
            if (response.data && response.data.success) {
              currentGuidance.value = response.data.guidance.guidance_text
              
              // æ¸…ç©ºç”»å¸ƒï¼Œå‡†å¤‡æ–°çš„åˆ›ä½œ
              clearCanvas()
              
              // æ’­æ”¾å¼•å¯¼è¯­éŸ³
              playGuidanceSpeech()
              
              alert('è¯­éŸ³å¼•å¯¼å·²ç”Ÿæˆï¼Œè¯·è·Ÿéšå¼•å¯¼è¿›è¡Œåˆ›ä½œ')
              isGeneratingGuidance.value = false
              return
            }
          } catch (apiError) {
            console.warn('APIè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å¼•å¯¼æ–‡æœ¬:', apiError.message);
            // ç»§ç»­æ‰§è¡Œï¼Œä½¿ç”¨é»˜è®¤å¼•å¯¼æ–‡æœ¬
          }
        }
        
        // ä½¿ç”¨é»˜è®¤å¼•å¯¼æ–‡æœ¬
        console.log('Using default guidance as painting ID is not saved in database');
        currentGuidance.value = 'ç°åœ¨ï¼Œè¯·ä½ è½»è½»æ”¾ä¸‹æ‰‹ä¸­çš„ç¬”ï¼Œå…ˆåšä¸‰æ¬¡æ·±å‘¼å¸ â€”â€” å¸æ°”æ—¶æ„Ÿå—æ–°é²œç©ºæ°”å……æ»¡èƒ¸è…”ï¼Œå‘¼æ°”æ—¶æ…¢æ…¢é‡Šæ”¾æ‰€æœ‰ç´§ç»·çš„æƒ…ç»ªï¼Œè®©è‚©è†€è‡ªç„¶ä¸‹æ²‰ï¼Œçœ‰å¿ƒä¹Ÿè·Ÿç€èˆ’å±•ã€‚ç­‰ä½ æ„Ÿè§‰å¿ƒè·³å˜å¾—å¹³ç¨³ï¼Œå†ç¼“ç¼“çå¼€çœ¼ç›ï¼ŒæŠŠç›®å…‰è½»è½»è½åœ¨é¢å‰çš„ç”»å¸ƒä¸Šã€‚\n' +
            'ä½ çœ‹ï¼Œè¿™å¼ ç©ºç™½çš„ç”»å¸ƒå°±åƒä¸€ç‰‡ç­‰å¾…è¢«æ¸©æŸ”å”¤é†’çš„å°ä¸–ç•Œï¼Œè€Œä½ çš„ç”»ç¬”ï¼Œå°±æ˜¯èƒ½ä¸ºå®ƒæ³¨å…¥ç”Ÿå‘½åŠ›çš„é­”æ³•æ£’ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘æƒ³é‚€è¯·ä½ å…ˆé—­ä¸Šçœ¼ç›ï¼Œåœ¨è„‘æµ·é‡Œå‹¾å‹’ä¸€å¹…ç”»é¢ï¼šæ¸…æ™¨çš„é˜³å…‰ç©¿è¿‡å±‚å±‚å å çš„æ ‘å¶ï¼Œæ´’ä¸‹ç»†ç¢çš„é‡‘æ–‘ï¼Œè½åœ¨ä¸€ç‰‡å¼€æ»¡å°é›èŠçš„è‰åœ°ä¸Šã€‚é£è½»è½»å¹è¿‡ï¼Œé›èŠçš„èŠ±ç“£ä¼šè½»è½»æ‘‡æ™ƒï¼Œåƒåœ¨å’Œä½ æ‰“æ‹›å‘¼ï¼›è¿œå¤„è¿˜æœ‰ä¸€æ¡å¼¯å¼¯çš„å°æºªï¼Œæºªæ°´æ¸…æ¾ˆå¾—èƒ½çœ‹è§æ°´åº•åœ†æ¶¦çš„é¹…åµçŸ³ï¼Œé˜³å…‰ç…§åœ¨æ°´é¢ä¸Šï¼Œä¼šæŠ˜å°„å‡ºæ˜Ÿæ˜Ÿç‚¹ç‚¹çš„å…‰ï¼Œåƒæ’’äº†ä¸€æŠŠç¢é’»ã€‚\n' +
            'ç°åœ¨ï¼Œæ…¢æ…¢çå¼€çœ¼ç›ï¼Œæ‹¿èµ·ä½ çš„ç”»ç¬”å§ã€‚ä¸ç”¨æ€¥ç€ç”»å®Œæ•´çš„åœºæ™¯ï¼Œæˆ‘ä»¬ä»æœ€è®©ä½ å¿ƒåŠ¨çš„éƒ¨åˆ†å¼€å§‹ â€”â€” å¦‚æœä½ å–œæ¬¢é‚£ç‰‡é˜³å…‰ï¼Œå°±å…ˆè˜¸å–ä¸€ç‚¹æ¸©æš–çš„é»„è‰²ï¼Œè½»è½»åœ¨ç”»å¸ƒä¸Šç‚¹å‡ºå‡ ç¼•å…‰çº¿ï¼Œæƒ³è±¡æ¯ä¸€ç¬”éƒ½æ˜¯é˜³å…‰åœ¨ç”»å¸ƒä¸Šè·³è·ƒï¼›å¦‚æœä½ æ›´åçˆ±å°æºªï¼Œå°±ç”¨æ·¡æ·¡çš„è“è‰²ç”»å‡ºå¼¯æ›²çš„çº¿æ¡ï¼Œçº¿æ¡ä¸ç”¨ç¬”ç›´ï¼Œåƒæºªæ°´è‡ªç„¶æµæ·Œçš„æ ·å­å°±å¥½ï¼Œå†ç”¨ç™½è‰²ç‚¹ç¼€å‡ æ»´æº…èµ·çš„æ°´èŠ±ï¼Œè®©æºªæ°´çœ‹èµ·æ¥çµåŠ¨åˆé²œæ´»ã€‚\n' +
            'ç”»ç€ç”»ç€ï¼Œä½ å¯ä»¥è¯•ç€ç»™è‰åœ°æ·»ä¸Šé¢œè‰² â€”â€” ä¸ä¸€å®šæ˜¯å‡åŒ€çš„ç»¿è‰²ï¼Œæˆ–è®¸é è¿‘é˜³å…‰çš„åœ°æ–¹ï¼Œè‰è‰²ä¼šåæµ…é»„ï¼Œåƒè¢«é˜³å…‰å»è¿‡ï¼›è€Œèº²åœ¨æ ‘è«ä¸‹çš„è‰ï¼Œé¢œè‰²ä¼šæ·±ä¸€ç‚¹ï¼Œå¸¦ç€æ¹¿æ¶¦çš„ç”Ÿæœºã€‚æ¥ç€ï¼Œæˆ‘ä»¬æ¥ç”»å°é›èŠï¼šå…ˆåœ¨è‰åœ°ä¸Šç‚¹å‡ºå°å°çš„ç™½è‰²åœ†åœˆå½“èŠ±ç“£ï¼Œå†ç”¨é»„è‰²ç‚¹ä¸ŠèŠ±å¿ƒï¼Œæ¯ä¸€æœµé›èŠéƒ½å¯ä»¥æœ‰è‡ªå·±çš„å§¿æ€ï¼Œæœ‰çš„å®Œå…¨ç»½æ”¾ï¼Œæœ‰çš„è¿˜æ˜¯å°å°çš„èŠ±è‹ï¼Œå°±åƒç”Ÿæ´»é‡Œé‚£äº›ä¸åŒé˜¶æ®µçš„ç¾å¥½ï¼Œéƒ½å€¼å¾—è¢«è®¤çœŸæç»˜ã€‚\n' +
            'å¦‚æœä½ çš„ç”»ç¬”ä¸å°å¿ƒç”»é”™äº†çº¿æ¡ä¹Ÿæ²¡å…³ç³»ï¼Œå°±æŠŠå®ƒå½“æˆæ˜¯è¿™ç‰‡å°ä¸–ç•Œé‡Œæ„å¤–çš„æƒŠå–œ â€”â€” æ¯”å¦‚å¤šä½™çš„ä¸€ç¬”ï¼Œæˆ–è®¸èƒ½å˜æˆéšé£é£˜åŠ¨çš„è’²å…¬è‹±ï¼›é¢œè‰²æ¶‚å‡ºè¾¹ç•Œçš„åœ°æ–¹ï¼Œå°±å½“æ˜¯é˜³å…‰æ¼«è¿‡äº†è‰åœ°çš„è¾¹ç¼˜ã€‚ä½ çœ‹ï¼Œè¿ "ä¸å®Œç¾" éƒ½èƒ½å˜æˆç‹¬ç‰¹çš„é£æ™¯ï¼Œå°±åƒä½ è‡ªå·±ï¼Œæ¯ä¸€ä¸ªçœŸå®çš„ç¬é—´éƒ½å€¼å¾—è¢«æ¥çº³ã€è¢«å–œçˆ±ã€‚\n' +
            'ç°åœ¨ï¼Œè®©ä½ çš„ç”»ç¬”ç»§ç»­åœ¨ç”»å¸ƒä¸Šæ¸¸èµ°å§ã€‚å¯ä»¥ç»™å°æºªè¾¹åŠ å‡ å—ç°è‰²çš„é¹…åµçŸ³ï¼ŒçŸ³å¤´ä¸Šè¿˜èƒ½æœ‰æ·¡æ·¡çš„çº¹è·¯ï¼›ä¹Ÿå¯ä»¥åœ¨å¤©ç©ºçš„ä½ç½®æ·»ä¸Šå‡ æœµè“¬æ¾çš„ç™½äº‘ï¼Œç”¨æµ…è“å’Œç™½è‰²è½»è½»æ™•æŸ“ï¼Œè®©å¤©ç©ºçœ‹èµ·æ¥åˆé«˜åˆå¼€é˜”ã€‚ç”»çš„æ—¶å€™ä¸ç”¨åœ¨æ„ç»†èŠ‚æ˜¯å¦ç²¾è‡´ï¼Œé‡ç‚¹æ˜¯æ„Ÿå—ç”»ç¬”åœ¨æŒ‡å°–ç§»åŠ¨çš„æ„Ÿè§‰ï¼Œæ„Ÿå—æ¯ä¸€ç§é¢œè‰²å¸¦ç»™ä½ çš„å¿ƒæƒ… â€”â€” é»„è‰²çš„æ¸©æš–ã€è“è‰²çš„å¹³é™ã€ç»¿è‰²çš„ç”Ÿæœºï¼Œè¿™äº›éƒ½æ˜¯ä½ å†…å¿ƒæ·±å¤„ç§¯æåŠ›é‡çš„å†™ç…§ã€‚\n' +
            'ç­‰ä½ è§‰å¾—ç”»é¢å·®ä¸å¤šå®Œæ•´äº†ï¼Œå°±åœä¸‹ç¬”ï¼Œé€€åä¸€æ­¥çœ‹çœ‹è‡ªå·±çš„ä½œå“ã€‚ä½ ä¼šå‘ç°ï¼Œä½ ä¸ä»…ç”»å‡ºäº†ä¸€ç‰‡æ¸…æ™¨çš„è‰åœ°ï¼Œæ›´ç”»å‡ºäº†æ­¤åˆ»å†…å¿ƒçš„å¹³é™ä¸å¸Œæœ›ã€‚è¿™ç‰‡å°å°çš„ç”»å¸ƒï¼Œå°±åƒä¸€ä¸ªå±äºä½ çš„èƒ½é‡ç©ºé—´ï¼Œæ¯å½“ä½ æ„Ÿåˆ°ç–²æƒ«æˆ–è¿·èŒ«æ—¶ï¼Œéƒ½å¯ä»¥å›åˆ°è¿™é‡Œï¼Œç”¨ç”»ç¬”é‡æ–°å”¤é†’è¿™äº›ç§¯æçš„ç”»é¢ï¼Œè®©å®ƒä»¬æˆä¸ºä½ ç»§ç»­å‘å‰çš„åŠ›é‡ã€‚\n'
        // æ¸…ç©ºç”»å¸ƒ
        clearCanvas()
        
        // æ’­æ”¾å¼•å¯¼è¯­éŸ³
        playGuidanceSpeech()
        
        alert('ä½¿ç”¨é»˜è®¤è¯­éŸ³å¼•å¯¼ï¼Œè¯·è·Ÿéšå¼•å¯¼è¿›è¡Œåˆ›ä½œ')
      } catch (error) {
        console.error('ç”Ÿæˆå¼•å¯¼å¤±è´¥:', error)
        
        // ä½¿ç”¨é»˜è®¤å¼•å¯¼æ–‡æœ¬ä½œä¸ºå¤‡ç”¨
        currentGuidance.value = 'ç°åœ¨ï¼Œè¯·ä½ è½»è½»æ”¾ä¸‹æ‰‹ä¸­çš„ç¬”ï¼Œå…ˆåšä¸‰æ¬¡æ·±å‘¼å¸ â€”â€” å¸æ°”æ—¶æ„Ÿå—æ–°é²œç©ºæ°”å……æ»¡èƒ¸è…”ï¼Œå‘¼æ°”æ—¶æ…¢æ…¢é‡Šæ”¾æ‰€æœ‰ç´§ç»·çš„æƒ…ç»ªï¼Œè®©è‚©è†€è‡ªç„¶ä¸‹æ²‰ï¼Œçœ‰å¿ƒä¹Ÿè·Ÿç€èˆ’å±•ã€‚ç­‰ä½ æ„Ÿè§‰å¿ƒè·³å˜å¾—å¹³ç¨³ï¼Œå†ç¼“ç¼“çå¼€çœ¼ç›ï¼ŒæŠŠç›®å…‰è½»è½»è½åœ¨é¢å‰çš„ç”»å¸ƒä¸Šã€‚\n' +
            'ä½ çœ‹ï¼Œè¿™å¼ ç©ºç™½çš„ç”»å¸ƒå°±åƒä¸€ç‰‡ç­‰å¾…è¢«æ¸©æŸ”å”¤é†’çš„å°ä¸–ç•Œï¼Œè€Œä½ çš„ç”»ç¬”ï¼Œå°±æ˜¯èƒ½ä¸ºå®ƒæ³¨å…¥ç”Ÿå‘½åŠ›çš„é­”æ³•æ£’ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘æƒ³é‚€è¯·ä½ å…ˆé—­ä¸Šçœ¼ç›ï¼Œåœ¨è„‘æµ·é‡Œå‹¾å‹’ä¸€å¹…ç”»é¢ï¼šæ¸…æ™¨çš„é˜³å…‰ç©¿è¿‡å±‚å±‚å å çš„æ ‘å¶ï¼Œæ´’ä¸‹ç»†ç¢çš„é‡‘æ–‘ï¼Œè½åœ¨ä¸€ç‰‡å¼€æ»¡å°é›èŠçš„è‰åœ°ä¸Šã€‚é£è½»è½»å¹è¿‡ï¼Œé›èŠçš„èŠ±ç“£ä¼šè½»è½»æ‘‡æ™ƒï¼Œåƒåœ¨å’Œä½ æ‰“æ‹›å‘¼ï¼›è¿œå¤„è¿˜æœ‰ä¸€æ¡å¼¯å¼¯çš„å°æºªï¼Œæºªæ°´æ¸…æ¾ˆå¾—èƒ½çœ‹è§æ°´åº•åœ†æ¶¦çš„é¹…åµçŸ³ï¼Œé˜³å…‰ç…§åœ¨æ°´é¢ä¸Šï¼Œä¼šæŠ˜å°„å‡ºæ˜Ÿæ˜Ÿç‚¹ç‚¹çš„å…‰ï¼Œåƒæ’’äº†ä¸€æŠŠç¢é’»ã€‚\n' +
            'ç°åœ¨ï¼Œæ…¢æ…¢çå¼€çœ¼ç›ï¼Œæ‹¿èµ·ä½ çš„ç”»ç¬”å§ã€‚ä¸ç”¨æ€¥ç€ç”»å®Œæ•´çš„åœºæ™¯ï¼Œæˆ‘ä»¬ä»æœ€è®©ä½ å¿ƒåŠ¨çš„éƒ¨åˆ†å¼€å§‹ â€”â€” å¦‚æœä½ å–œæ¬¢é‚£ç‰‡é˜³å…‰ï¼Œå°±å…ˆè˜¸å–ä¸€ç‚¹æ¸©æš–çš„é»„è‰²ï¼Œè½»è½»åœ¨ç”»å¸ƒä¸Šç‚¹å‡ºå‡ ç¼•å…‰çº¿ï¼Œæƒ³è±¡æ¯ä¸€ç¬”éƒ½æ˜¯é˜³å…‰åœ¨ç”»å¸ƒä¸Šè·³è·ƒï¼›å¦‚æœä½ æ›´åçˆ±å°æºªï¼Œå°±ç”¨æ·¡æ·¡çš„è“è‰²ç”»å‡ºå¼¯æ›²çš„çº¿æ¡ï¼Œçº¿æ¡ä¸ç”¨ç¬”ç›´ï¼Œåƒæºªæ°´è‡ªç„¶æµæ·Œçš„æ ·å­å°±å¥½ï¼Œå†ç”¨ç™½è‰²ç‚¹ç¼€å‡ æ»´æº…èµ·çš„æ°´èŠ±ï¼Œè®©æºªæ°´çœ‹èµ·æ¥çµåŠ¨åˆé²œæ´»ã€‚\n' +
            'ç”»ç€ç”»ç€ï¼Œä½ å¯ä»¥è¯•ç€ç»™è‰åœ°æ·»ä¸Šé¢œè‰² â€”â€” ä¸ä¸€å®šæ˜¯å‡åŒ€çš„ç»¿è‰²ï¼Œæˆ–è®¸é è¿‘é˜³å…‰çš„åœ°æ–¹ï¼Œè‰è‰²ä¼šåæµ…é»„ï¼Œåƒè¢«é˜³å…‰å»è¿‡ï¼›è€Œèº²åœ¨æ ‘è«ä¸‹çš„è‰ï¼Œé¢œè‰²ä¼šæ·±ä¸€ç‚¹ï¼Œå¸¦ç€æ¹¿æ¶¦çš„ç”Ÿæœºã€‚æ¥ç€ï¼Œæˆ‘ä»¬æ¥ç”»å°é›èŠï¼šå…ˆåœ¨è‰åœ°ä¸Šç‚¹å‡ºå°å°çš„ç™½è‰²åœ†åœˆå½“èŠ±ç“£ï¼Œå†ç”¨é»„è‰²ç‚¹ä¸ŠèŠ±å¿ƒï¼Œæ¯ä¸€æœµé›èŠéƒ½å¯ä»¥æœ‰è‡ªå·±çš„å§¿æ€ï¼Œæœ‰çš„å®Œå…¨ç»½æ”¾ï¼Œæœ‰çš„è¿˜æ˜¯å°å°çš„èŠ±è‹ï¼Œå°±åƒç”Ÿæ´»é‡Œé‚£äº›ä¸åŒé˜¶æ®µçš„ç¾å¥½ï¼Œéƒ½å€¼å¾—è¢«è®¤çœŸæç»˜ã€‚\n' +
            'å¦‚æœä½ çš„ç”»ç¬”ä¸å°å¿ƒç”»é”™äº†çº¿æ¡ä¹Ÿæ²¡å…³ç³»ï¼Œå°±æŠŠå®ƒå½“æˆæ˜¯è¿™ç‰‡å°ä¸–ç•Œé‡Œæ„å¤–çš„æƒŠå–œ â€”â€” æ¯”å¦‚å¤šä½™çš„ä¸€ç¬”ï¼Œæˆ–è®¸èƒ½å˜æˆéšé£é£˜åŠ¨çš„è’²å…¬è‹±ï¼›é¢œè‰²æ¶‚å‡ºè¾¹ç•Œçš„åœ°æ–¹ï¼Œå°±å½“æ˜¯é˜³å…‰æ¼«è¿‡äº†è‰åœ°çš„è¾¹ç¼˜ã€‚ä½ çœ‹ï¼Œè¿ â€œä¸å®Œç¾â€ éƒ½èƒ½å˜æˆç‹¬ç‰¹çš„é£æ™¯ï¼Œå°±åƒä½ è‡ªå·±ï¼Œæ¯ä¸€ä¸ªçœŸå®çš„ç¬é—´éƒ½å€¼å¾—è¢«æ¥çº³ã€è¢«å–œçˆ±ã€‚\n' +
            'ç°åœ¨ï¼Œè®©ä½ çš„ç”»ç¬”ç»§ç»­åœ¨ç”»å¸ƒä¸Šæ¸¸èµ°å§ã€‚å¯ä»¥ç»™å°æºªè¾¹åŠ å‡ å—ç°è‰²çš„é¹…åµçŸ³ï¼ŒçŸ³å¤´ä¸Šè¿˜èƒ½æœ‰æ·¡æ·¡çš„çº¹è·¯ï¼›ä¹Ÿå¯ä»¥åœ¨å¤©ç©ºçš„ä½ç½®æ·»ä¸Šå‡ æœµè“¬æ¾çš„ç™½äº‘ï¼Œç”¨æµ…è“å’Œç™½è‰²è½»è½»æ™•æŸ“ï¼Œè®©å¤©ç©ºçœ‹èµ·æ¥åˆé«˜åˆå¼€é˜”ã€‚ç”»çš„æ—¶å€™ä¸ç”¨åœ¨æ„ç»†èŠ‚æ˜¯å¦ç²¾è‡´ï¼Œé‡ç‚¹æ˜¯æ„Ÿå—ç”»ç¬”åœ¨æŒ‡å°–ç§»åŠ¨çš„æ„Ÿè§‰ï¼Œæ„Ÿå—æ¯ä¸€ç§é¢œè‰²å¸¦ç»™ä½ çš„å¿ƒæƒ… â€”â€” é»„è‰²çš„æ¸©æš–ã€è“è‰²çš„å¹³é™ã€ç»¿è‰²çš„ç”Ÿæœºï¼Œè¿™äº›éƒ½æ˜¯ä½ å†…å¿ƒæ·±å¤„ç§¯æåŠ›é‡çš„å†™ç…§ã€‚\n' +
            'ç­‰ä½ è§‰å¾—ç”»é¢å·®ä¸å¤šå®Œæ•´äº†ï¼Œå°±åœä¸‹ç¬”ï¼Œé€€åä¸€æ­¥çœ‹çœ‹è‡ªå·±çš„ä½œå“ã€‚ä½ ä¼šå‘ç°ï¼Œä½ ä¸ä»…ç”»å‡ºäº†ä¸€ç‰‡æ¸…æ™¨çš„è‰åœ°ï¼Œæ›´ç”»å‡ºäº†æ­¤åˆ»å†…å¿ƒçš„å¹³é™ä¸å¸Œæœ›ã€‚è¿™ç‰‡å°å°çš„ç”»å¸ƒï¼Œå°±åƒä¸€ä¸ªå±äºä½ çš„èƒ½é‡ç©ºé—´ï¼Œæ¯å½“ä½ æ„Ÿåˆ°ç–²æƒ«æˆ–è¿·èŒ«æ—¶ï¼Œéƒ½å¯ä»¥å›åˆ°è¿™é‡Œï¼Œç”¨ç”»ç¬”é‡æ–°å”¤é†’è¿™äº›ç§¯æçš„ç”»é¢ï¼Œè®©å®ƒä»¬æˆä¸ºä½ ç»§ç»­å‘å‰çš„åŠ›é‡ã€‚\n'
        // æ¸…ç©ºç”»å¸ƒ
        clearCanvas()
        
        // æ’­æ”¾å¼•å¯¼è¯­éŸ³
        playGuidanceSpeech()
        
        alert('ä½¿ç”¨é»˜è®¤å¼•å¯¼è¿›è¡Œç»˜ç”»ç»ƒä¹ ')
      } finally {
        isGeneratingGuidance.value = false
      }
    }
    
    // æ’­æ”¾å¼•å¯¼è¯­éŸ³ - ä½¿ç”¨æ›´è‡ªç„¶çš„çœŸäººå£°éŸ³æ•ˆæœ
    const playGuidanceSpeech = () => {
      if (!currentGuidance.value) return
      
      // åœæ­¢ä¹‹å‰å¯èƒ½åœ¨æ’­æ”¾çš„è¯­éŸ³
      stopGuidanceSpeech()
      
      // åˆ›å»ºè¯­éŸ³åˆæˆå®ä¾‹ï¼Œå¢å¼ºæ–‡æœ¬å¤„ç†ä½¿è¯­éŸ³æ›´è‡ªç„¶
      let text = currentGuidance.value
      
      // 1. å¢å¼ºæ ‡ç‚¹ç¬¦å·åœé¡¿ - æ¨¡æ‹ŸçœŸäººè¯´è¯èŠ‚å¥
      // é•¿å¥æœ«å°¾åœé¡¿æ›´é•¿
      text = text.replace(/([ã€‚ï¼ï¼Ÿ])/g, '$1<break time="400ms">')
      // åˆ†å¥åœé¡¿é€‚ä¸­
      text = text.replace(/([ï¼›ï¼š])/g, '$1<break time="300ms">')
      // çŸ­åœé¡¿
      text = text.replace(/([ï¼Œã€])/g, '$1<break time="150ms">')
      
      // 2. å¤„ç†æ®µè½ - æ·»åŠ æ›´é•¿çš„è‡ªç„¶åœé¡¿
      text = text.replace(/\n\n/g, '<break time="800ms">')
      text = text.replace(/\n/g, '<break time="600ms">')
      
      // 3. æ·»åŠ æƒ…æ„Ÿæ ‡è®°è¯ï¼ˆæŸäº›æµè§ˆå™¨æ”¯æŒï¼‰
      text = text.replace(/æ„Ÿå—|ä½“ä¼š|æƒ³è±¡/g, '<emphasis level="moderate">$&</emphasis>')
      text = text.replace(/å¹³é™|æ”¾æ¾|èˆ’é€‚/g, '<emphasis level="strong">$&</emphasis>')
      
      const utterance = new SpeechSynthesisUtterance(text)
      utterance.lang = 'zh-CN' // è®¾ç½®ä¸ºä¸­æ–‡
      
      // 4. ä¼˜åŒ–è¯­éŸ³å‚æ•°ä½¿å…¶æ›´æ¥è¿‘çœŸäººå£°éŸ³
      utterance.rate = 0.85 // ç¨å¾®æ”¾æ…¢è¯­é€Ÿï¼Œæ›´æ˜¾è‡ªç„¶
      utterance.pitch = 0.95 // å¾®è°ƒéŸ³è°ƒï¼Œé¿å…æœºæ¢°æ„Ÿ
      utterance.volume = 0.98 // æ¥è¿‘æ»¡éŸ³é‡ï¼Œæ›´æ¸…æ™°
      
      // 5. æ”¹è¿›å£°éŸ³é€‰æ‹©é€»è¾‘ - å¢åŠ æ›´å¤šå£°éŸ³é€‰é¡¹
      const voices = window.speechSynthesis.getVoices()
      console.log('å¯ç”¨è¯­éŸ³:', voices.map(v => v.name + ' (' + v.lang + ')'))
      
      // æ‰©å±•å¥³æ€§å£°éŸ³å…³é”®è¯ï¼Œå¢åŠ æ›´å¤šå¯èƒ½çš„ä¸­æ–‡å£°éŸ³åç§°
      const femaleVoicePatterns = [
        'Female', 'female', 'å¥³', 'å¥³å£°', 
        'Huihui', 'Yunxi', 'Xiaoxiao', 'Yaoyao', 
        'Luna', 'Zira', 'å¾®è½¯', 'Microsoft',
        'Lingua', 'Melina', 'Mei-Jia', 'Ting-Ting',
        'Zhiyu', 'Yating', 'Suyun', 'Aiwei'
      ]
      
      // æ”¹è¿›çš„å£°éŸ³ç­›é€‰é€»è¾‘
      let preferredVoice = voices.find(voice => {
        const isCN = voice.lang === 'zh-CN' || voice.lang.startsWith('zh-') || 
                    voice.lang === 'cmn-CN' || voice.name.includes('Chinese')
        const hasFemaleKeywords = femaleVoicePatterns.some(pattern => 
          voice.name.includes(pattern)
        )
        // ä¼˜å…ˆé€‰æ‹©é«˜è´¨é‡è¯­éŸ³å¼•æ“
        const isHighQuality = voice.name.includes('Premium') || 
                             voice.name.includes('Neural') ||
                             voice.name.includes('Enhanced')
        
        return isCN && (hasFemaleKeywords || isHighQuality)
      })
      
      // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç†æƒ³çš„ä¸­æ–‡å¥³æ€§å£°éŸ³ï¼Œå°è¯•å…¶ä»–ä¸­æ–‡å£°éŸ³
      if (!preferredVoice) {
        preferredVoice = voices.find(voice => 
          voice.lang === 'zh-CN' || voice.lang.startsWith('zh-') ||
          voice.lang === 'cmn-CN'
        )
      }
      
      // å¦‚æœè¿˜æ˜¯æ²¡æœ‰æ‰¾åˆ°ä¸­æ–‡å£°éŸ³ï¼Œå°è¯•å…¶ä»–è‡ªç„¶åº¦è¾ƒé«˜çš„å£°éŸ³
      if (!preferredVoice && voices.length > 0) {
        // å¯»æ‰¾å¬èµ·æ¥æ›´è‡ªç„¶çš„å£°éŸ³
        const naturalVoices = voices.filter(v => 
          v.name.includes('Neural') || v.name.includes('Premium') ||
          v.name.includes('Enhanced') || v.name.includes('Female')
        )
        
        if (naturalVoices.length > 0) {
          preferredVoice = naturalVoices[0]
        } else {
          // é€‰æ‹©ç¬¬ä¸€ä¸ªå¯ç”¨å£°éŸ³ä½œä¸ºåå¤‡
          preferredVoice = voices[0]
        }
        console.warn('æœªæ‰¾åˆ°ç†æƒ³çš„ä¸­æ–‡å£°éŸ³ï¼Œä½¿ç”¨æ›¿ä»£å£°éŸ³:', preferredVoice.name)
      }
      
      // å¦‚æœæœ‰æ‰¾åˆ°åˆé€‚çš„å£°éŸ³ï¼Œè®¾ç½®å®ƒå¹¶æ ¹æ®ä¸åŒå£°éŸ³è°ƒæ•´å‚æ•°
      if (preferredVoice) {
        utterance.voice = preferredVoice
        console.log('é€‰æ‹©çš„è¯­éŸ³:', preferredVoice.name)
        
        // ä¸ºä¸åŒå£°éŸ³å¼•æ“ä¼˜åŒ–å‚æ•°
        if (preferredVoice.name.includes('Huihui')) {
          utterance.pitch = 1.08
          utterance.rate = 0.82
        } else if (preferredVoice.name.includes('Yunxi') || preferredVoice.name.includes('Xiaoxiao')) {
          utterance.pitch = 1.02
          utterance.rate = 0.88
        } else if (preferredVoice.name.includes('Zira') || preferredVoice.name.includes('Microsoft')) {
          utterance.pitch = 1.05
          utterance.rate = 0.8
        } else if (preferredVoice.name.includes('Neural')) {
          // ç¥ç»ç½‘ç»œå£°éŸ³å¼•æ“ç‰¹æ®Šä¼˜åŒ–
          utterance.pitch = 1.0
          utterance.rate = 0.85
        } else if (preferredVoice.name.includes('Female') && !preferredVoice.name.includes('Chinese')) {
          // éä¸­æ–‡å¥³å£°ï¼Œé™ä½è¯­é€Ÿä»¥æé«˜å¯ç†è§£æ€§
          utterance.pitch = 1.1
          utterance.rate = 0.75
        }
      }
      
      // ç›‘å¬è¯­éŸ³ç»“æŸäº‹ä»¶
      utterance.onend = () => {
        isPlayingGuidance.value = false
        console.log('è¯­éŸ³æ’­æ”¾ç»“æŸ')
      }
      
      utterance.onerror = (event) => {
        console.error('è¯­éŸ³åˆæˆé”™è¯¯:', event)
        isPlayingGuidance.value = false
        // æ›´å‹å¥½çš„é”™è¯¯æç¤º
        alert('å·²é€€å‡ºè¯­éŸ³ç»˜ç”»å¼•å¯¼')
      }
      
      utterance.onstart = () => {
        console.log('è¯­éŸ³å¼€å§‹æ’­æ”¾')
      }
      
      // 6. å¢å¼ºçš„è¯­éŸ³æ’­æ”¾æ§åˆ¶
      // æ·»åŠ éŸµå¾‹è°ƒæ•´ï¼ˆprosodyï¼‰å‚æ•°ï¼Œæå‡è‡ªç„¶åº¦
      utterance.prosody = {
        rate: utterance.rate,
        pitch: utterance.pitch
      }
      
      // æ·»åŠ è¯­éŸ³æƒ…æ„Ÿè®¾ç½®ï¼ˆå¦‚æœæµè§ˆå™¨æ”¯æŒï¼‰
      if (typeof utterance.emotion !== 'undefined') {
        utterance.emotion = 'calm' // å¹³é™çš„æƒ…ç»ªï¼Œé€‚åˆæ­£å¿µå¼•å¯¼
      }
      
      // ç¡®ä¿è·å–äº†æ‰€æœ‰å¯ç”¨å£°éŸ³åå†æ’­æ”¾
      if (voices.length === 0) {
        console.log('å£°éŸ³åˆ—è¡¨ä¸ºç©ºï¼Œç­‰å¾…åŠ è½½...')
        // å¦‚æœå£°éŸ³åˆ—è¡¨ä¸ºç©ºï¼Œç­‰å¾…onvoiceschangedäº‹ä»¶
        const handleVoicesChanged = () => {
          console.log('å£°éŸ³åŠ è½½å®Œæˆï¼Œé‡æ–°æ’­æ”¾')
          playGuidanceSpeech() // é‡æ–°è°ƒç”¨ä»¥åº”ç”¨å£°éŸ³è®¾ç½®
          window.speechSynthesis.onvoiceschanged = null
        }
        window.speechSynthesis.onvoiceschanged = handleVoicesChanged
        // ä¸»åŠ¨è§¦å‘ä¸€æ¬¡å£°éŸ³åŠ è½½
        window.speechSynthesis.getVoices()
      } else {
        // å¢åŠ è¯­éŸ³ç¼“å†²æ—¶é—´ï¼Œç¡®ä¿æ’­æ”¾æµç•…
        setTimeout(() => {
          // å¼€å§‹æ’­æ”¾
          console.log('å¼€å§‹æ’­æ”¾è¯­éŸ³')
          window.speechSynthesis.speak(utterance)
          isPlayingGuidance.value = true
        }, 100) // 100msç¼“å†²æ—¶é—´ï¼Œé¿å…æ’­æ”¾å¡é¡¿
      }
    }
    
    // åœæ­¢å¼•å¯¼è¯­éŸ³
    const stopGuidanceSpeech = () => {
      window.speechSynthesis.cancel()
      isPlayingGuidance.value = false
    }

    // å¿ƒçµé•œåƒå¯¹è¯æ¡†ç›¸å…³
    const showMindMirrorDialog = ref(false)
    
    const closeMindMirrorDialog = () => {
      showMindMirrorDialog.value = false
    }
    
    // ç”Ÿæˆç–—æ„ˆå°æ•…äº‹
    const generateHealingStory = async () => {
      if (!analysisResult.value) {
        console.log('æ— æ³•ç”Ÿæˆç–—æ„ˆæ•…äº‹ï¼šæ²¡æœ‰åˆ†æç»“æœ')
        return
      }
      
      isGeneratingStory.value = true
      healingStory.value = null
      
      try {
        console.log('å°è¯•ç›´æ¥ä½¿ç”¨åˆ†ææ•°æ®ç”Ÿæˆç–—æ„ˆæ•…äº‹...')
        
        // è°ƒç”¨æ–°çš„APIç«¯ç‚¹ï¼Œç›´æ¥ä¼ é€’åˆ†æç»“æœ
        const response = await axios.post('/api/v1/paintings/generate-story-direct', {
          analysis_result: analysisResult.value
        }, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          },
          timeout: 30000 // è®¾ç½®30000msè¶…æ—¶ï¼Œå› ä¸ºAIç”Ÿæˆéœ€è¦æ›´å¤šæ—¶é—´
        })
        
        healingStory.value = response.data.story
        console.log('ç–—æ„ˆæ•…äº‹ç”ŸæˆæˆåŠŸ')
      } catch (error) {
        console.error('ç”Ÿæˆç–—æ„ˆæ•…äº‹å¤±è´¥:', error)
        // å¤±è´¥æ—¶ä½¿ç”¨é»˜è®¤æ•…äº‹
        healingStory.value = 'åœ¨ä¸€ç‰‡ç»¿æ„ç›ç„¶çš„æ£®æ—ä¸­ï¼Œä½ å‘ç°äº†ä¸€é¢ç¥å¥‡çš„é•œå­ã€‚å½“ä½ æœ›å‘é•œä¸­ï¼Œçœ‹åˆ°çš„ä¸ä»…æ˜¯è‡ªå·±ï¼Œè¿˜æœ‰æ— æ•°å¯èƒ½ã€‚æ¯ä¸€ç‰‡è½å¶éƒ½ä»£è¡¨ä¸€ä¸ªè¿‡å»çš„çƒ¦æ¼ï¼Œæ¯ä¸€é“é˜³å…‰éƒ½é¢„ç¤ºç€æ–°çš„å¸Œæœ›ã€‚æ·±å‘¼å¸ï¼Œæ„Ÿå—å¤§è‡ªç„¶çš„æ²»æ„ˆåŠ›é‡ï¼Œä½ ä¼šå‘ç°ï¼Œå†…å¿ƒçš„å¹³é™ä¸€ç›´éƒ½åœ¨é‚£é‡Œï¼Œç­‰å¾…ä½ å»å‘ç°ã€‚'
      } finally {
        isGeneratingStory.value = false
      }
    }

    return {
      goBack,
      drawingCanvas,
      currentColor,
      brushSize,
      brushType,
      currentTool,
      isGeneratingStory,
      healingStory,
      generateHealingStory,
      isGeneratingMindMirror,
        mindMirrorResult,
        generateIntervention,
        showMindMirrorDialog,
        closeMindMirrorDialog,
        originalPaintingPreview,
        positivePaintingPreview,
      eraserType,
      analysisResult,
      history,
      showCanvasList,
      showModeSelection,
      showThemeSelection,
      currentPaintingMode,
      themeOptions,
      selectedTheme,
      savedCanvases,
      filteredCanvases,
      currentCanvasId,
      currentCanvasName,
      isDefaultName,
      showRenameModal,
      newCanvasName,
      startDrawing,
      draw,
      stopDrawing,
      clearCanvas,
      selectTool,
      undo,
      saveCanvas,
      createNewCanvas,
      loadCanvas,
      deleteCanvas,
      showRenameDialog,
      closeRenameDialog,
      confirmRename,
      analyzeDrawing,
      generateAndPlayMindfulnessGuidance,
      isGeneratingGuidance,
      currentGuidance,
      isPlayingGuidance,
      stopGuidanceSpeech,
      selectPaintingMode,
      selectTheme,
      showMoodRadarChart,
      getStressLevelClass,
      getTimeCategoryText,
      formatMarkdownAnalysis,
      generateColorAnalysis,
      generateBrushAnalysis,
        generateCompositionAnalysis,
        showPaintingPrompt,
        paintingPrompt
    }
  }
}
</script>

<style scoped>
/* ç»˜ç”»æç¤ºåŒºåŸŸæ ·å¼ */
.painting-prompt {
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  border-radius: 16px;
  padding: 20px 24px;
  margin-bottom: 18px;
  text-align: center;
  font-size: 16px;
  line-height: 1.7;
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.06);
  border: 1px solid #e2e8f0;
  border-left: 5px solid #6366f1;
  color: #475569;
  font-weight: 500;
  animation: promptSlideIn 0.6s ease-out;
  transition: all 0.3s ease;
}

.painting-prompt:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
  border-color: #cbd5e1;
}

@keyframes promptSlideIn {
  from {
    opacity: 0;
    transform: translateY(10px) translateX(-5px);
  }
  to {
    opacity: 1;
    transform: translateY(0) translateX(0);
  }
}

/* æƒ…ç»ªçŠ¶æ€æè¿°åŒºåŸŸ */
.mood-description-section {
  background-color: #ffffff;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
}

.mood-description-content {
  font-size: 16px;
  line-height: 1.6;
  color: #333;
  white-space: pre-wrap;
}

/* å¤šç»´åº¦åˆ†æç½‘æ ¼å¸ƒå±€ */
.analysis-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 15px;
  margin-top: 15px;
}

/* åˆ†æå¡ç‰‡æ ·å¼ - ä¼˜åŒ–è®¾è®¡ */
.analysis-card {
  background: #ffffff;
  border-radius: 14px;
  padding: 18px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  border: 1px solid #f0f0f0;
}

.analysis-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
}

/* å¡ç‰‡å¤´éƒ¨æ ·å¼ */
.card-header {
  display: flex;
  align-items: center;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 2px solid #f0f0f0;
}

.card-icon {
  font-size: 24px;
  margin-right: 12px;
}

.card-header h4 {
  margin: 0;
  font-size: 18px;
  font-weight: 600;
  color: #374151;
}

/* å¡ç‰‡ç±»å‹ç‰¹å®šæ ·å¼ */
.card-color {
  border-top: 4px solid #ec4899;
}

.card-brush {
  border-top: 4px solid #3b82f6;
}

.card-composition {
  border-top: 4px solid #10b981;
}

.card-color .card-header h4 {
  color: #be185d;
}

.card-brush .card-header h4 {
  color: #1d4ed8;
}

.card-composition .card-header h4 {
  color: #059669;
}

/* åˆ†æå†…å®¹æ ·å¼ */
.analysis-content {
  font-size: 17px;
  line-height: 1.7;
}

.analysis-content h4 {
  color: #4b5563;
  font-size: 18px;
  margin-top: 14px;
  margin-bottom: 10px;
  font-weight: 600;
}

.analysis-content strong {
  color: #111827;
  font-size: 17px;
}

.analysis-content ul {
  padding-left: 20px;
  margin-bottom: 14px;
}

.analysis-content li {
  margin-bottom: 8px;
  line-height: 1.7;
  color: #6b7280;
  font-size: 17px;
}

/* æ”¹è¿›çš„åˆ†æå†…å®¹æ ·å¼ */
.analysis-content-improved {
  font-size: 18px;
  line-height: 1.8;
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.analysis-content-improved h4 {
  color: #2c3e50;
  font-size: 22px;
  margin: 0 0 15px 0;
  font-weight: 700;
  border-bottom: 2px solid #e5e7eb;
  padding-bottom: 8px;
}

.analysis-content-improved p {
  margin: 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 0;
  border-bottom: 1px solid #f3f4f6;
}

.analysis-content-improved p strong {
  color: #111827;
  font-size: 19px;
  font-weight: 700;
  flex: 1;
  margin-right: 15px;
}

.analysis-content-improved p span {
  color: #2c3e50;
  font-size: 19px;
  font-weight: 600;
  text-align: right;
}

.analysis-content br {
  display: block;
  margin: 12px 0;
  content: '';
}

/* å¤šç»´åº¦åˆ†æå¡ç‰‡æ ·å¼ */
.multi-dimension-card {
  background-color: #ffffff;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 16px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  border-left: 4px solid #6366f1;
}

.multi-dimension-card .analysis-content h4 {
  color: #4f46e5;
  font-size: 18px;
  margin-top: 20px;
  margin-bottom: 12px;
  font-weight: 600;
}

.multi-dimension-card .analysis-content ul {
  padding-left: 20px;
  margin-bottom: 16px;
}

.multi-dimension-card .analysis-content li {
  margin-bottom: 8px;
  line-height: 1.5;
  color: #4b5563;
}

.multi-dimension-card .analysis-content br {
  display: block;
  margin: 8px 0;
  content: '';
}

/* é’ˆå¯¹æ€§å»ºè®®éƒ¨åˆ† */
.suggestions-section {
  margin-top: 24px;
  padding-top: 24px;
  border-top: 1px solid #e5e7eb;
}

.suggestions-section h4 {
  color: #10b981;
  font-size: 18px;
  margin-bottom: 12px;
  font-weight: 600;
}

.suggestions-content {
  font-size: 16px;
  line-height: 1.6;
  color: #4b5563;
  background-color: #f0fdf4;
  padding: 16px;
  border-radius: 8px;
  border-left: 3px solid #10b981;
}
.mind-painting-container {
  padding: 20px;
  max-width: 1200px;
  margin: 0 auto;
  font-family: 'Arial', sans-serif;
  background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
  min-height: 100vh;
  border-radius: 8px;
}

/* åˆ†æç»“æœæ ·å¼ */
.analysis-result {
  background: rgba(255, 255, 255, 0.95);
  border-radius: 15px;
  padding: 30px;
  margin-top: 30px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
  backdrop-filter: blur(10px);
}

.analysis-result h2 {
  color: #2c3e50;
  text-align: center;
  margin-bottom: 30px;
  font-size: 28px;
  font-weight: 700;
}

.analysis-overview {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 30px;
  margin-bottom: 40px;
}

.stress-meter {
  background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
  border-radius: 12px;
  padding: 25px;
  text-align: center;
  box-shadow: 0 4px 15px rgba(255, 154, 158, 0.2);
}

.stress-meter h3 {
  color: #2c3e50;
  margin-bottom: 20px;
  font-size: 20px;
}

.stress-index-container {
  display: flex;
  flex-direction: column;
  align-items: center;
}

.stress-index-value {
  font-size: 48px;
  font-weight: 700;
  margin-bottom: 10px;
  text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
}

.stress-level-low {
  color: #27ae60;
}

.stress-level-medium {
  color: #f39c12;
}

.stress-level-high {
  color: #e74c3c;
}

.stress-level-label {
  font-size: 18px;
  color: #555;
  font-weight: 600;
}

.painting-info {
  background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
  border-radius: 12px;
  padding: 25px;
  box-shadow: 0 4px 15px rgba(161, 196, 253, 0.2);
}

.painting-info h3 {
  color: #2c3e50;
  margin-bottom: 20px;
  font-size: 20px;
}

.painting-info p {
  color: #34495e;
  margin-bottom: 10px;
  font-size: 16px;
  line-height: 1.6;
}

.painting-info p strong {
  color: #2c3e50;
}

.mood-radar-section {
  margin-bottom: 20px;
  text-align: center;
}

.mood-radar-section h3 {
  color: #2c3e50;
  margin-bottom: 10px;
  font-size: 24px;
}

.mood-radar-chart {
  display: flex;
  justify-content: center;
  align-items: center;
  background: rgba(255, 255, 255, 0.8);
  border-radius: 12px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
}

.radar-container {
  position: relative;
  width: 100%;
  max-width: 500px;
  aspect-ratio: 1/1;
  margin: 0;
}

.radar-container canvas {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  object-fit: contain;
}

.personality-portrait {
  margin-bottom: 40px;
  background: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%);
  border-radius: 12px;
  padding: 30px;
  box-shadow: 0 4px 15px rgba(212, 252, 121, 0.2);
}

.personality-portrait h3 {
  color: #2c3e50;
  margin-bottom: 20px;
  font-size: 24px;
  text-align: center;
}

.portrait-content {
  color: #2c3e50;
  font-size: 18px;
  line-height: 1.8;
  font-weight: 500;
  text-align: justify;
}

.detailed-analysis h3 {
  color: #2c3e50;
  margin-bottom: 30px;
  font-size: 24px;
  text-align: center;
}

.analysis-card {
  background: rgba(255, 255, 255, 0.9);
  border-radius: 12px;
  padding: 25px;
  margin-bottom: 25px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
  border-left: 5px solid #3498db;
}

.analysis-card h4 {
  color: #2c3e50;
  margin-bottom: 20px;
  font-size: 20px;
}

.analysis-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
}

.analysis-item {
  display: flex;
  flex-direction: column;
  padding: 15px;
  background: rgba(255, 255, 255, 0.7);
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.analysis-item .label {
  color: #7f8c8d;
  font-size: 14px;
  margin-bottom: 8px;
}

.analysis-item .value {
  color: #2c3e50;
  font-size: 18px;
  font-weight: 600;
}

.analysis-actions {
  display: flex;
  justify-content: center;
  gap: 30px;
  margin: 40px auto;
  flex-wrap: wrap;
  max-width: 1200px;
  padding: 35px;
}

/* é«˜äº®åŒºåŸŸæ ·å¼ */
.highlighted-section {
  border-top: 5px solid #667eea;
  border-bottom: 5px solid #667eea;
  background-color: rgba(102, 126, 234, 0.1);
  border-radius: 15px;
}

/* ç»Ÿä¸€æ ·å¼çš„æ“ä½œæŒ‰é’® */
.action-button {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  padding: 28px 56px;
  border-radius: 45px;
  font-size: 24px;
  font-weight: 800;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 12px 30px rgba(102, 126, 234, 0.6);
  display: inline-flex;
  align-items: center;
  gap: 16px;
  min-width: 220px;
  justify-content: center;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  line-height: 1.4;
}

.action-button:hover:not(:disabled) {
  transform: translateY(-3px);
  box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
}

.action-button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

.primary-button {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  padding: 15px 30px;
  border-radius: 30px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

.primary-button:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
}

.success-button {
  background: linear-gradient(135deg, #52c41a 0%, #389e0d 100%);
  color: white;
  border: none;
  padding: 15px 30px;
  border-radius: 30px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(82, 196, 26, 0.3);
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.success-button:hover:not(:disabled) {
  transform: translateY(-3px);
  box-shadow: 0 8px 25px rgba(82, 196, 26, 0.4);
}

.success-button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

.secondary-button {
  background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  color: white;
  border: none;
  padding: 15px 30px;
  border-radius: 30px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(240, 147, 251, 0.3);
}

.secondary-button:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 25px rgba(240, 147, 251, 0.4);
}

/* æ¨¡å¼é€‰æ‹©é¡µé¢æ ·å¼ */
.mode-selection-container {
  text-align: center;
}

.mode-selection-title {
  color: #2c3e50;
  margin-bottom: 40px;
  font-size: 28px;
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.mode-options {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 30px;
  margin-bottom: 40px;
}

.mode-card {
  background: rgba(255, 255, 255, 0.95);
  border-radius: 15px;
  padding: 30px;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
  backdrop-filter: blur(10px);
  border: 2px solid transparent;
}

.mode-card:hover {
  transform: translateY(-10px);
  box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
  border-color: #007bff;
}

.mode-icon {
  font-size: 48px;
  margin-bottom: 20px;
}

.mode-card h3 {
  color: #2c3e50;
  margin-bottom: 15px;
  font-size: 24px;
}

.mode-description {
  color: #555;
  margin-bottom: 20px;
  line-height: 1.6;
  font-size: 16px;
}

.mode-examples {
  text-align: left;
  background: rgba(0, 123, 255, 0.05);
  padding: 15px;
  border-radius: 10px;
  margin-top: 20px;
}

.mode-examples p {
  color: #007bff;
  font-weight: 600;
  margin-bottom: 10px;
  font-size: 14px;
}

.mode-examples ul {
  list-style-type: none;
  padding: 0;
  margin: 0;
}

.mode-examples li {
  color: #666;
  margin-bottom: 5px;
  font-size: 14px;
  line-height: 1.5;
}

/* ä¸»é¢˜é€‰æ‹©é¡µé¢æ ·å¼ */
.theme-selection-container {
  text-align: center;
}

.theme-selection-title {
  color: #2c3e50;
  margin-bottom: 20px;
  font-size: 28px;
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.theme-selection-subtitle {
  color: #555;
  margin-bottom: 40px;
  font-size: 18px;
}

.theme-options {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 20px;
  margin-bottom: 40px;
}

.theme-card {
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(245, 247, 250, 0.95));
  border-radius: 20px;
  padding: 30px 25px;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
  backdrop-filter: blur(15px);
  border: 2px solid transparent;
  text-align: center;
  min-height: 160px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  position: relative;
  overflow: hidden;
}

.theme-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
  transition: left 0.5s ease;
}

.theme-card:hover {
  transform: translateY(-10px) scale(1.02);
  box-shadow: 0 15px 30px rgba(0, 123, 255, 0.25);
  border-color: #007bff;
  background: linear-gradient(135deg, rgba(255, 255, 255, 1), rgba(240, 245, 255, 1));
}

.theme-card:hover::before {
  left: 100%;
}

.theme-icon {
  font-size: 42px;
  margin-bottom: 18px;
  transition: transform 0.3s ease;
  z-index: 1;
}

.theme-card:hover .theme-icon {
  transform: scale(1.2) rotate(5deg);
}

.theme-text {
  color: #2c3e50;
  font-size: 16px;
  font-weight: 600;
  line-height: 1.6;
  margin: 0;
  z-index: 1;
  transition: color 0.3s ease;
}

.theme-card:hover .theme-text {
  color: #007bff;
}

/* å“åº”å¼è°ƒæ•´ */
@media (max-width: 768px) {
  .theme-options {
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
  }
  
  .theme-card {
    min-height: 140px;
    padding: 20px;
  }
  
  .theme-icon {
    font-size: 36px;
    margin-bottom: 12px;
  }
  
  .theme-text {
    font-size: 14px;
  }
}

.theme-card:hover .theme-icon {
  opacity: 1;
  transform: scale(1.1);
  transition: all 0.3s ease;
}

.page-header {
  display: flex;
  align-items: center;
  margin-bottom: 20px;
  gap: 20px;
  flex-wrap: wrap;
}

.page-header h1 {
  flex: 1;
  min-width: 200px;
}

.back-button {
  background: rgba(255, 255, 255, 0.9);
  border: 2px solid rgba(255, 255, 255, 0.3);
  border-radius: 25px;
  padding: 10px 20px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 600;
  color: #2c3e50;
  transition: all 0.3s ease;
  backdrop-filter: blur(10px);
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
}

.back-button:hover {
  background: rgba(255, 255, 255, 1);
  transform: translateY(-2px);
  box-shadow: 0 6px 25px rgba(0, 0, 0, 0.15);
}

.back-icon {
  font-size: 1.2em;
  font-weight: bold;
}

h1 {
  color: #2c3e50;
  margin: 0;
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

p {
  color: #555;
  margin-bottom: 30px;
}

/* ç”»å¸ƒåŒºåŸŸæ ·å¼ */
.canvas-area {
  background-color: #f0f0f0;
  border: 1px solid #ccc;
  border-radius: 8px;
  margin-bottom: 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
  overflow: hidden;
}

canvas {
  background-color: white;
  border-top: 1px solid #ccc; /* ä¿®æ”¹ä¸ºä¸Šè¾¹æ¡† */
  cursor: crosshair;
  width: 100%;
  max-width: 1200px; /* è¿›ä¸€æ­¥å¢å¤§æœ€å¤§å®½åº¦ */
  height: 600px; /* è®¾ç½®å›ºå®šé«˜åº¦ */
  box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.1);
}

/* å·¥å…·æ æ ·å¼ */
.tool-bar {
  padding: 15px;
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  align-items: center;
  justify-content: center;
  width: 100%;
  max-width: 1200px;
  background-color: #f8f9fa;
  border-bottom: 1px solid #e9ecef;
}

.tool-section {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
  margin-bottom: 10px;
}

.tool-section label {
  font-weight: 600;
  color: #2c3e50;
  white-space: nowrap;
}

/* ç”»ç¬”ç±»å‹æŒ‰é’® */
.brush-type-buttons, .eraser-buttons {
  display: flex;
  gap: 5px;
  flex-wrap: wrap;
}

.brush-button, .eraser-button {
  background-color: #fff;
  border: 2px solid #ddd;
  border-radius: 5px;
  padding: 8px 12px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.brush-button:hover, .eraser-button:hover {
  background-color: #f0f0f0;
  border-color: #007bff;
}

.brush-button.active, .eraser-button.active {
  background-color: #007bff;
  color: white;
  border-color: #007bff;
}

/* é¢œè‰²é€‰æ‹©å™¨ */
input[type="color"] {
  width: 40px;
  height: 40px;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
}

/* æ»‘å—æ ·å¼ */
input[type="range"] {
  width: 120px;
  height: 6px;
  background: #ddd;
  border-radius: 3px;
  outline: none;
  -webkit-appearance: none;
}

input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 18px;
  height: 18px;
  background: #007bff;
  border-radius: 50%;
  cursor: pointer;
}

input[type="range"]::-moz-range-thumb {
  width: 18px;
  height: 18px;
  background: #007bff;
  border-radius: 50%;
  cursor: pointer;
  border: none;
}

/* æ“ä½œæŒ‰é’® */
.action-button {
  background-color: #007bff;
  color: white;
  padding: 8px 15px;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  transition: background-color 0.3s ease;
}

.action-button:hover:not(:disabled) {
  background-color: #0056b3;
}

.action-button:disabled {
  background-color: #ccc;
  cursor: not-allowed;
}

/* åˆ†æç»“æœæ ·å¼ */
.analysis-result {
  background-color: #e8f5e9;
  padding: 20px;
  border-radius: 10px;
  margin-top: 30px;
  text-align: left;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
}

.analysis-result h2 {
  color: #4CAF50;
  margin-bottom: 15px;
}

.analysis-result p {
  margin-bottom: 10px;
  color: #333;
}

/* ç”»å¸ƒåˆ—è¡¨æ ·å¼ */
.canvas-list-container {
  width: 100%;
}

.canvas-list-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 30px;
  flex-wrap: wrap;
  gap: 15px;
}

.canvas-list-header h2 {
  color: #2c3e50;
  margin: 0;
}

.new-canvas-button {
  background: linear-gradient(135deg, #4CAF50, #45a049);
  color: white;
  border: none;
  border-radius: 25px;
  padding: 12px 25px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s ease;
  box-shadow: 0 4px 20px rgba(76, 175, 80, 0.3);
}

.new-canvas-button:hover {
  background: linear-gradient(135deg, #45a049, #3d8b40);
  transform: translateY(-2px);
  box-shadow: 0 6px 25px rgba(76, 175, 80, 0.4);
}

.canvas-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  gap: 25px;
  margin-bottom: 40px;
}

.canvas-item {
  background: rgba(255, 255, 255, 0.9);
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
  transition: all 0.3s ease;
  backdrop-filter: blur(10px);
}

.canvas-item:hover {
  transform: translateY(-5px);
  box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
}

.canvas-thumbnail {
  position: relative;
  width: 100%;
  height: 200px;
  overflow: hidden;
  cursor: pointer;
  background-color: #f5f5f5;
}

.canvas-thumbnail img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: transform 0.3s ease;
}

.canvas-thumbnail:hover img {
  transform: scale(1.05);
}

.canvas-name {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  padding: 10px;
  background: linear-gradient(transparent, rgba(0, 0, 0, 0.7));
  color: white;
  font-weight: 600;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.canvas-actions {
  display: flex;
  justify-content: space-around;
  padding: 15px;
  gap: 10px;
}

.rename-button, .delete-button {
  flex: 1;
  padding: 8px 12px;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  font-weight: 500;
  transition: all 0.2s ease;
}

.rename-button {
  background-color: #2196F3;
  color: white;
}

.rename-button:hover {
  background-color: #1976D2;
}

.delete-button {
  background-color: #f44336;
  color: white;
}

.delete-button:hover {
  background-color: #d32f2f;
}

.no-canvases {
  text-align: center;
  padding: 60px 20px;
  background: rgba(255, 255, 255, 0.8);
  border-radius: 12px;
  backdrop-filter: blur(10px);
}

.no-canvases p {
  font-size: 18px;
  color: #666;
  margin-bottom: 30px;
}

/* ç”»å¸ƒä¿¡æ¯æ˜¾ç¤º */
.canvas-info {
  display: flex;
  align-items: center;
  gap: 10px;
  background: rgba(255, 255, 255, 0.8);
  padding: 8px 15px;
  border-radius: 20px;
  backdrop-filter: blur(10px);
}

.canvas-name-display {
  font-weight: 600;
  color: #2c3e50;
  max-width: 200px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.rename-button-small {
  background-color: #2196F3;
  color: white;
  border: none;
  border-radius: 15px;
  padding: 5px 12px;
  cursor: pointer;
  font-size: 12px;
  font-weight: 500;
  transition: background-color 0.2s ease;
}

.rename-button-small:hover {
  background-color: #1976D2;
}

/* æ¨¡æ€æ¡†æ ·å¼ */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  backdrop-filter: blur(3px);
  overflow: hidden; /* é˜²æ­¢æ»šåŠ¨ */
}

.rename-modal {
  background: white;
  border-radius: 12px;
  padding: 30px;
  width: 90%;
  max-width: 400px;
  box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
  animation: modalFadeIn 0.3s ease;
}

@keyframes modalFadeIn {
  from {
    opacity: 0;
    transform: translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.rename-modal h3 {
  margin-top: 0;
  margin-bottom: 20px;
  color: #2c3e50;
}

.rename-modal input[type="text"] {
  width: 100%;
  padding: 12px;
  border: 2px solid #ddd;
  border-radius: 8px;
  font-size: 16px;
  margin-bottom: 20px;
  transition: border-color 0.2s ease;
}

.rename-modal input[type="text"]:focus {
  outline: none;
  border-color: #007bff;
}

.modal-buttons {
  display: flex;
  gap: 15px;
  justify-content: flex-end;
}

.modal-buttons button {
  padding: 10px 20px;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.2s ease;
}

.modal-buttons button:first-child {
  background-color: #f0f0f0;
  color: #333;
}

.modal-buttons button:first-child:hover {
  background-color: #e0e0e0;
}

.modal-buttons button:last-child {
  background-color: #007bff;
  color: white;
}

.modal-buttons button:last-child:hover {
    background-color: #0056b3;
  }
  
  /* å¤šç»´åº¦åˆ†æç½‘æ ¼å¸ƒå±€ */
  .analysis-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 24px;
    margin-bottom: 24px;
  }
  
  .analysis-card {
    background-color: #ffffff;
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
    border: 1px solid #f0f0f0;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  
  .analysis-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
  }
  
  .card-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 2px solid #f3f4f6;
  }
  
  .card-icon {
    font-size: 24px;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #f8fafc;
    border-radius: 8px;
  }
  
  .analysis-card h4 {
    margin: 0;
    color: #1e293b;
    font-size: 1.2rem;
    font-weight: 600;
  }
  
  /* ä¸ºä¸åŒç±»å‹çš„å¡ç‰‡è®¾ç½®ä¸åŒçš„ä¸»é¢˜è‰² */
  .analysis-card.card-color .card-header {
    border-color: #ff6b6b;
  }
  
  .analysis-card.card-brush .card-header {
    border-color: #4ecdc4;
  }
  
  .analysis-card.card-composition .card-header {
    border-color: #45b7d1;
  }
  
  .analysis-content {
    color: #555;
    line-height: 1.6;
  }

  /* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .tool-bar {
    flex-direction: column;
    align-items: stretch;
  }

  .tool-section {
    justify-content: center;
  }

  .canvas-grid {
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  }

  .page-header {
    flex-direction: column;
    align-items: flex-start;
  }

  .canvas-info {
    width: 100%;
    justify-content: space-between;
  }
}
/* ç–—æ„ˆå°æ•…äº‹ç›¸å…³æ ·å¼ */
  .info-button {
    background-color: #3498db;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
    margin: 0 10px;
    transition: background-color 0.3s;
  }
  
  .info-button:hover:not(:disabled) {
    background-color: #2980b9;
  }
  
  .info-button:disabled {
    background-color: #95a5a6;
    cursor: not-allowed;
  }
  
  .healing-story-section {
    background-color: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 10px;
    padding: 20px;
    margin-top: 20px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
  }
  
  .healing-story-section h3 {
    color: #343a40;
    margin-top: 0;
    margin-bottom: 15px;
    font-size: 20px;
  }
  
  .healing-story-content {
    color: #495057;
    line-height: 1.6;
    font-size: 16px;
    background-color: white;
    padding: 15px;
    border-radius: 5px;
    border-left: 4px solid #3498db;
  }
  
  /* å¿ƒçµé•œåƒå¯¹è¯æ¡†æ ·å¼ */
  .mind-mirror-modal {
    background: white;
    border-radius: 15px;
    width: 90%;
    max-width: 1000px;
    max-height: 85vh;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    animation: modalSlideIn 0.3s ease-out;
    display: flex;
    flex-direction: column;
  }
  
  /* ç§¯æç‰ˆæœ¬æè¿°æ ·å¼ */
  .positive-image-description {
    background-color: #e3f2fd;
    padding: 15px;
    border-radius: 8px;
    margin: 15px 0;
    border-left: 4px solid #2196f3;
    line-height: 1.6;
    font-size: 16px;
  }
  
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 25px 30px;
    border-bottom: 1px solid #e5e7eb;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px 15px 0 0;
  }
  
  .modal-header h3 {
    margin: 0;
    font-size: 24px;
    font-weight: 700;
  }
  
  .close-button {
    background: none;
    border: none;
    color: white;
    font-size: 28px;
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: background-color 0.3s;
  }
  
  .close-button:hover {
    background-color: rgba(255, 255, 255, 0.2);
  }
  
  .modal-content {
    padding: 30px;
    overflow-y: auto;
    max-height: calc(85vh - 150px); /* ç¡®ä¿å†…å®¹åŒºåŸŸä¸ä¼šæŒ¤å‹é¡µè„š */
  }
  
  .modal-footer {
    padding: 20px 30px;
    border-top: 1px solid #e5e7eb;
    display: flex;
    justify-content: center;
  }
  
  .mind-mirror-container {
    display: flex;
    flex-direction: column;
    gap: 30px;
  }
  
  .painting-comparison {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 20px;
    flex-wrap: wrap;
  }
  
  .painting-item {
    flex: 1;
    min-width: 250px;
    display: flex;
    flex-direction: column;
    gap: 15px;
  }
  
  .painting-item h4 {
    text-align: center;
    color: #2c3e50;
    font-size: 18px;
    margin: 0;
  }
  
  .painting-preview {
    width: 100%;
    height: 250px;
    background-color: #f8f9fa;
    border: 2px dashed #ced4da;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }
  
  .painting-preview canvas {
    display: block;
    width: 100%;
    height: 100%;
    object-fit: contain;
  }
  
  .arrow-icon {
    font-size: 36px;
    color: #667eea;
    margin: 0 20px;
    animation: pulse 2s infinite;
  }
  
  .positive-version {
    width: 100%;
    height: 250px;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    border: 2px solid #667eea;
    border-radius: 10px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 20px;
    position: relative;
    overflow: hidden;
  }
  
  .sunshine-animation {
    position: absolute;
    top: 20px;
    right: 20px;
    font-size: 48px;
    animation: rotate 10s linear infinite;
  }
  
  .positive-description {
    font-size: 18px;
    color: #2c3e50;
    text-align: center;
    line-height: 1.6;
    font-weight: 500;
    z-index: 1;
    padding: 15px;
    background-color: rgba(255, 255, 255, 0.8);
    border-radius: 10px;
  }
  
  .guidance-text {
    background-color: #fff3cd;
    border: 2px solid #ffeaa7;
    border-radius: 12px;
    padding: 25px;
    display: flex;
    align-items: flex-start;
    gap: 20px;
  }
  
  .guidance-icon {
    font-size: 32px;
    flex-shrink: 0;
    margin-top: 5px;
  }
  
  .guidance-text p {
    font-size: 20px;
    color: #856404;
    line-height: 1.8;
    font-weight: 600;
    margin: 0;
  }
  
  .reflection-section {
    background-color: #e8f5e8;
    border: 2px solid #c3e6cb;
    border-radius: 12px;
    padding: 25px;
  }
  
  .reflection-section h4 {
    color: #155724;
    font-size: 20px;
    margin-top: 0;
    margin-bottom: 20px;
  }
  
  .reflection-section p {
    font-size: 18px;
    color: #155724;
    line-height: 1.8;
    margin: 12px 0;
  }
  
  @keyframes modalSlideIn {
    from {
      opacity: 0;
      transform: translateY(-50px) scale(0.9);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }
  
  @keyframes pulse {
    0%, 100% {
      transform: scale(1);
    }
    50% {
      transform: scale(1.2);
    }
  }
  
  @keyframes rotate {
    from {
      transform: rotate(0deg);
    }
    to {
      transform: rotate(360deg);
    }
  }
  
  /* å“åº”å¼è®¾è®¡ */
  @media (max-width: 768px) {
    .painting-comparison {
      flex-direction: column;
    }
    
    .arrow-icon {
      transform: rotate(90deg);
      margin: 20px 0;
    }
    
    .guidance-text {
      flex-direction: column;
      align-items: center;
      text-align: center;
    }
    
    .mind-mirror-modal {
      width: 95%;
      margin: 10px;
      max-width: none;
    }
  }
  </style>

