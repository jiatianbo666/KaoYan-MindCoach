<template>
  <div class="messenger-container">
    <!-- é£˜è¿‡çš„çœŸå®äº‘æœµ - ç‹¬ç«‹å±‚ -->
    <div class="floating-clouds">
      <div class="realistic-cloud cloud-drift-1">
        <div class="cloud-part cloud-main"></div>
        <div class="cloud-part cloud-small-1"></div>
        <div class="cloud-part cloud-small-2"></div>
        <div class="cloud-part cloud-tiny-1"></div>
        <div class="cloud-part cloud-tiny-2"></div>
      </div>
      <div class="realistic-cloud cloud-drift-2">
        <div class="cloud-part cloud-main"></div>
        <div class="cloud-part cloud-small-1"></div>
        <div class="cloud-part cloud-small-2"></div>
        <div class="cloud-part cloud-medium-1"></div>
      </div>
      <div class="realistic-cloud cloud-drift-3">
        <div class="cloud-part cloud-main"></div>
        <div class="cloud-part cloud-small-1"></div>
        <div class="cloud-part cloud-tiny-1"></div>
      </div>
      <div class="realistic-cloud cloud-drift-4">
        <div class="cloud-part cloud-main"></div>
        <div class="cloud-part cloud-small-1"></div>
        <div class="cloud-part cloud-small-2"></div>
        <div class="cloud-part cloud-medium-1"></div>
        <div class="cloud-part cloud-tiny-1"></div>
      </div>
      <div class="realistic-cloud cloud-drift-5">
        <div class="cloud-part cloud-main"></div>
        <div class="cloud-part cloud-small-1"></div>
        <div class="cloud-part cloud-medium-1"></div>
        <div class="cloud-part cloud-tiny-1"></div>
      </div>
      <div class="realistic-cloud cloud-drift-6">
        <div class="cloud-part cloud-main"></div>
        <div class="cloud-part cloud-small-1"></div>
        <div class="cloud-part cloud-small-2"></div>
        <div class="cloud-part cloud-tiny-1"></div>
        <div class="cloud-part cloud-tiny-2"></div>
        <div class="cloud-part cloud-tiny-3"></div>
      </div>
      <div class="realistic-cloud cloud-drift-7">
        <div class="cloud-part cloud-main"></div>
        <div class="cloud-part cloud-medium-1"></div>
        <div class="cloud-part cloud-small-1"></div>
      </div>
    </div>

    <!-- é£˜è½çš„èŠ±ç“£ - ç‹¬ç«‹å±‚ -->
    <div class="floating-petals">
      <div class="petal petal-1">
        <div class="petal-shape petal-sakura"></div>
      </div>
      <div class="petal petal-2">
        <div class="petal-shape petal-rose"></div>
      </div>
      <div class="petal petal-3">
        <div class="petal-shape petal-sakura"></div>
      </div>
      <div class="petal petal-4">
        <div class="petal-shape petal-plum"></div>
      </div>
      <div class="petal petal-5">
        <div class="petal-shape petal-sakura"></div>
      </div>
      <div class="petal petal-6">
        <div class="petal-shape petal-rose"></div>
      </div>
      <div class="petal petal-7">
        <div class="petal-shape petal-plum"></div>
      </div>
      <div class="petal petal-8">
        <div class="petal-shape petal-sakura"></div>
      </div>
      <div class="petal petal-9">
        <div class="petal-shape petal-rose"></div>
      </div>
      <div class="petal petal-10">
        <div class="petal-shape petal-plum"></div>
      </div>
      <div class="petal petal-11">
        <div class="petal-shape petal-sakura"></div>
      </div>
      <div class="petal petal-12">
        <div class="petal-shape petal-rose"></div>
      </div>
      <div class="petal petal-13">
        <div class="petal-shape petal-sakura"></div>
      </div>
      <div class="petal petal-14">
        <div class="petal-shape petal-plum"></div>
      </div>
      <div class="petal petal-15">
        <div class="petal-shape petal-rose"></div>
      </div>
    </div>

    <!-- èƒŒæ™¯è£…é¥°æ•ˆæœ - ç‹¬ç«‹å±‚ -->
    <div class="background-decorations">
      <!-- å¤é£äº‘çº¹è£…é¥° -->
      <div class="cloud-patterns">
        <div class="cloud-pattern cloud-1"></div>
        <div class="cloud-pattern cloud-2"></div>
        <div class="cloud-pattern cloud-3"></div>
      </div>
    </div>

    <!-- è¯—æ„èƒŒæ™¯è£…é¥°å±‚ -->
    <div class="paper-background">
    </div>

    <!-- é¡µé¢å¤´éƒ¨ -->
    <div class="page-header">
      <button class="back-button glass-bubble" @click="goBack">
        <svg class="back-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M19 12H5M12 19L5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        è¿”å›ä¸»ç•Œé¢
      </button>
      <h1 class="page-title">å¿ƒè¯­ä¿¡ä½¿</h1>
      <p class="page-subtitle">è®©AIå€¾å¬ä½ çš„å¿ƒå£°ï¼Œç”¨æ¸©æš–å›åº”ä½ çš„å›°æƒ‘</p>
    </div>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <div class="main-content">
      <!-- å›ä¿¡æ’­æ”¾åŒº -->
      <div class="reply-area" v-if="currentReply">
        <transition name="letter-arrive" appear>
          <div class="letter-envelope" @click="openReply">
            <div class="envelope-front">
              <div class="envelope-seal"></div>
              <p class="envelope-text">æ¥è‡ªAIä¼™ä¼´çš„å›ä¿¡</p>
              <p class="envelope-hint">ç‚¹å‡»æŸ¥çœ‹è¯¦ç»†å†…å®¹</p>
            </div>
          </div>
        </transition>
      </div>

      <!-- æ¶ˆæ¯å†å²åŒºåŸŸ -->
      <div class="messages-history" v-if="showHistory">
        <div class="history-bubble glass-bubble">
          <div class="history-header">
            <h3>ğŸ“® ä¿¡ä»¶å†å²</h3>
            <button @click="showHistory = false" class="close-history">Ã—</button>
          </div>
          
          <div class="history-stats">
            <div class="stat-item">
              <span class="stat-label">æ€»ä¿¡ä»¶</span>
              <span class="stat-value">{{ messageHistory.length }}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">æœ¬å‘¨</span>
              <span class="stat-value">{{ getWeeklyCount() }}</span>
            </div>
          </div>

          <div class="history-list">
            <div v-for="msg in messageHistory" :key="msg.id" 
                 class="history-item" 
                 :class="{ 'risk-red': msg.risk_level === 'red', 'risk-yellow': msg.risk_level === 'yellow' }"
                 @click="viewHistoryMessage(msg)">
              <div class="history-date">{{ formatDate(msg.created_at) }}</div>
              <div class="history-preview">{{ msg.text_content?.substring(0, 40) }}...</div>
              <div class="history-emotion">
                <span class="emotion-label">{{ getEmotionLabel(msg.emotion_report) }}</span>
                <div class="risk-indicator" :class="msg.risk_level"></div>
              </div>
              <div class="history-stress" v-if="msg.emotion_report">
                <span class="stress-label">å‹åŠ›:</span>
                <div class="stress-bar">
                  <div class="stress-fill" :style="{ width: msg.emotion_report.stress_index + '%' }"></div>
                </div>
                <span class="stress-value">{{ msg.emotion_report.stress_index }}</span>
              </div>
            </div>
            
            <div v-if="messageHistory.length === 0" class="empty-history">
              <p>è¿˜æ²¡æœ‰ä¿¡ä»¶è®°å½•</p>
              <p>å¼€å§‹ä½ çš„ç¬¬ä¸€å°å¿ƒè¯­ä¿¡ä»¶å§ ğŸ’Œ</p>
            </div>
          </div>
        </div>
      </div>

      <!-- è¾“å…¥åŒºåŸŸ - ä¿¡çº¸æ ·å¼ -->
      <div class="input-section">
        <div class="letter-paper-input">
          <div class="paper-lines"></div>
          
          <!-- æ–‡å­—è¾“å…¥åŒº -->
          <div class="text-input-area">
            <div class="rich-text-toolbar">
              <button @click="formatText('bold')" class="format-btn" title="åŠ ç²—"><b>B</b></button>
              <button @click="formatText('italic')" class="format-btn" title="æ–œä½“"><i>I</i></button>
              <button @click="formatText('underline')" class="format-btn" title="ä¸‹åˆ’çº¿"><u>U</u></button>
              <div class="emoji-dropdown">
                <button @click="toggleEmojiPanel" class="format-btn" title="æ·»åŠ è¡¨æƒ…">ğŸ˜Š</button>
                <div v-show="showEmojiPanel" class="emoji-panel">
                  <div class="emoji-categories">
                    <button @click="setEmojiCategory('emotion')" 
                            :class="{ active: currentEmojiCategory === 'emotion' }"
                            class="emoji-cat-btn">ğŸ˜Š</button>
                    <button @click="setEmojiCategory('heart')" 
                            :class="{ active: currentEmojiCategory === 'heart' }"
                            class="emoji-cat-btn">â¤ï¸</button>
                    <button @click="setEmojiCategory('nature')" 
                            :class="{ active: currentEmojiCategory === 'nature' }"
                            class="emoji-cat-btn">ğŸŒ¸</button>
                    <button @click="setEmojiCategory('study')" 
                            :class="{ active: currentEmojiCategory === 'study' }"
                            class="emoji-cat-btn">ğŸ“š</button>
                  </div>
                  <div class="emoji-grid">
                    <button v-for="emoji in currentEmojis" 
                            :key="emoji" 
                            @click="insertEmoji(emoji)" 
                            class="emoji-btn">{{ emoji }}</button>
                  </div>
                </div>
              </div>
            </div>
            <div 
              ref="textInput"
              class="text-input rich-text-input"
              contenteditable="true"
              @input="handleRichTextInput"
              @keydown="handleKeyDown"
              @paste="handlePaste"
              data-placeholder="åœ¨è¿™é‡Œå†™ä¸‹ä½ çš„å¿ƒå£°... ">
            </div>
            <div class="char-count">{{ textLength }}/1000</div>
          </div>

          <!-- å¤šåª’ä½“è¾“å…¥åŒº -->
          <div class="media-input-area">
            <!-- å›¾ç‰‡é¢„è§ˆ -->
            <div v-if="selectedImage" class="image-preview">
              <canvas ref="imageCanvas" class="preview-canvas"></canvas>
              <div class="image-info">
                <span class="image-size">{{ imageInfo.size }}</span>
                <span class="image-type">{{ imageInfo.type }}</span>
              </div>
              <button @click="removeImage" class="remove-media">Ã—</button>
            </div>

            <!-- è¯­éŸ³å½•åˆ¶æŒ‡ç¤º -->
            <div v-if="isRecording" class="voice-recording">
              <div class="recording-animation">
                <div class="pulse"></div>
                <svg class="mic-icon" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                  <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                </svg>
              </div>
              <p>æ­£åœ¨å½•éŸ³ä¸­...</p>
              <button @click="stopVoiceInput" class="stop-recording">åœæ­¢å½•éŸ³</button>
            </div>
          </div>

          <!-- æ§åˆ¶æŒ‰é’®åŒº -->
          <div class="control-buttons">
            <div class="input-buttons">
              <!-- å›¾ç‰‡ä¸Šä¼  -->
              <button @click="triggerImageUpload" class="input-btn glass-bubble" title="æ·»åŠ å›¾ç‰‡">
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                </svg>
              </button>

              <!-- è¯­éŸ³è¾“å…¥ -->
              <button @click="startVoiceInput" 
                      v-if="!isRecording" 
                      class="input-btn glass-bubble" 
                      title="è¯­éŸ³è¾“å…¥">
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                  <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                </svg>
              </button>

              <!-- åŒ¿åæ¨¡å¼ -->
              <button @click="toggleAnonymous" 
                      class="input-btn glass-bubble"
                      :class="{ active: anonymousMode }"
                      title="åŒ¿åæ¨¡å¼">
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM21 9V7L15 7V9C15 11.8 12.8 14 10 14S5 11.8 5 9V7L3 7V9C3 12.5 5.6 15.4 9 15.9V22H15V15.9C18.4 15.4 21 12.5 21 9Z"/>
                </svg>
              </button>

              <!-- å†å²è®°å½• -->
              <button @click="toggleHistory" 
                      class="input-btn glass-bubble" 
                      title="å†å²ä¿¡ä»¶">
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M13 3C9.23 3 6.19 5.95 6 9.66L4.34 8L3.07 9.27L7 13.2L10.93 9.27L9.66 8L8 9.66C8.19 7.05 10.22 5 13 5C15.76 5 18 7.24 18 10S15.76 15 13 15H11V17H13C16.87 17 20 13.87 20 10S16.87 3 13 3Z"/>
                </svg>
              </button>
            </div>

            <!-- å‘é€æŒ‰é’® -->
            <button @click="sendMessage" 
                    class="send-button" 
                    :disabled="!canSend"
                    :class="{ sending: isSending }">
              <transition name="button-content" mode="out-in">
                <span v-if="!isSending" key="send">å°ä¿¡å¯„å‡º</span>
                <div v-else key="sending" class="sending-animation">
                  <div class="flying-pigeon">ğŸ•Šï¸</div>
                </div>
              </transition>
            </button>
          </div>
        </div>

        <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
        <input type="file" 
               ref="imageInput" 
               @change="handleImageUpload" 
               accept="image/*" 
               style="display: none;" />
      </div>
    </div>

    <!-- å¼•å¯¼æç¤ºå¼¹çª— -->
    <div v-if="showGuidance" class="guidance-modal" @click="hideGuidance">
      <div class="guidance-content glass-bubble" @click.stop>
        <div class="guidance-icon">ğŸ’­</div>
        <h3>å¿ƒçµå¯„è¯­</h3>
        <p class="guidance-main-text">{{ guidanceText }}</p>
        <p class="guidance-sub-text">åœ¨è¿™é‡Œå€¾è¯‰ä½ çš„å¿ƒå£°ï¼ŒAIä¼™ä¼´ä¼šè®¤çœŸå€¾å¬</p>
        <button @click="hideGuidance" class="guidance-close">å¼€å§‹å€¾è¯‰</button>
      </div>
    </div>

    <!-- éšç§æç¤º -->
    <div v-if="showPrivacyTip" class="privacy-modal" @click="showPrivacyTip = false">
      <div class="privacy-content glass-bubble" @click.stop>
        <div class="privacy-icon">ğŸ”’</div>
        <h3>åŒ¿åæ¨¡å¼</h3>
        <p>{{ privacyTipText }}</p>
        <div class="privacy-features">
          <div class="feature-item">
            <span class="feature-icon">ğŸš«</span>
            <span>ä¸ä¿å­˜ä¸ªäººä¿¡æ¯</span>
          </div>
          <div class="feature-item">
            <span class="feature-icon">ğŸ›¡ï¸</span>
            <span>ç«¯åˆ°ç«¯åŠ å¯†ä¼ è¾“</span>
          </div>
          <div class="feature-item">
            <span class="feature-icon">â°</span>
            <span>ä¼šè¯åè‡ªåŠ¨æ¸…é™¤</span>
          </div>
        </div>
        <button @click="showPrivacyTip = false" class="privacy-close">çŸ¥é“äº†</button>
      </div>
    </div>

    <!-- ä¿¡ä»¶å‘é€åŠ¨ç”» -->
    <transition name="letter-send" @after-leave="onLetterSent">
      <div v-if="showSendAnimation" class="letter-send-transition">
        <div class="envelope-animation" :class="animationStep">
          <img src="/ä¿¡å°.png" alt="ä¿¡å°" class="envelope-image" />
          <div class="envelope-glow"></div>
        </div>
      </div>
    </transition>

    <!-- å›ä¿¡è¯¦æƒ…æµ®çª— -->
    <transition name="modal-fade">
      <div v-if="showReplyModal" class="reply-modal-backdrop" @click="closeReplyModal">
        <div class="reply-modal" @click.stop>
          <div class="modal-header">
            <h3>æ¥è‡ªAIä¼™ä¼´çš„å›ä¿¡</h3>
            <div class="modal-controls">
              <!-- è¯­éŸ³æœ—è¯»æ§åˆ¶æŒ‰é’® -->
              <button 
                @click="toggleSpeech" 
                class="speech-control-btn"
                :class="{ 'speaking': isSpeaking, 'paused': speechPaused }"
                :title="speechButtonTitle">
                <span v-if="!isSpeaking && !speechPaused">ğŸ”Š</span>
                <span v-else-if="isSpeaking && !speechPaused">â¸ï¸</span>
                <span v-else>â–¶ï¸</span>
              </button>
              <button @click="closeReplyModal" class="modal-close">Ã—</button>
            </div>
          </div>
          
          <!-- æ–°å¢ï¼šå·¦å³åˆ†æ å¸ƒå±€ -->
          <div class="modal-content-wrapper">
            <!-- å·¦ä¾§ï¼šå¿ƒç†è¾…å¯¼è€å¸ˆè§†é¢‘ -->
            <div class="teacher-video-section">
              <video 
                ref="teacherVideo"
                class="teacher-video"
                :src="'/å¿ƒç†è¾…å¯¼è€å¸ˆ.mp4'"
                autoplay
                muted
                loop
                playsinline
                @loadedmetadata="onVideoLoaded"
                @timeupdate="onVideoTimeUpdate"
                @ended="onVideoEnded">
                æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
              </video>
            </div>
            
            <!-- å³ä¾§ï¼šå›ä¿¡å†…å®¹ -->
            <div class="letter-content-section">
              <div class="modal-content">
                <div class="letter-paper">
                  <div class="letter-text" v-html="currentReply?.content"></div>
                  
                  <!-- å±æœºå¹²é¢„è­¦å‘Š -->
                  <div v-if="currentReply?.crisisResources" class="crisis-intervention-warning">
                    <div class="crisis-header" :class="currentReply.crisisResources.level">
                      <div class="crisis-icon">
                        <span v-if="currentReply.crisisResources.level === 'high_risk'">ğŸš¨</span>
                        <span v-else>âš ï¸</span>
                      </div>
                      <h4>{{ currentReply.crisisResources.message }}</h4>
                    </div>
                    
                    <div v-if="currentReply.crisisResources.immediate_actions" class="immediate-actions">
                      <h5>ç«‹å³è¡ŒåŠ¨ï¼š</h5>
                      <ul>
                        <li v-for="action in currentReply.crisisResources.immediate_actions" 
                            :key="action">{{ action }}</li>
                      </ul>
                    </div>
                    
                    <div v-if="currentReply.crisisResources.resources" class="crisis-resources">
                      <h5>ç´§æ€¥è”ç³»æ–¹å¼ï¼š</h5>
                      <div v-if="currentReply.crisisResources.resources.hotlines" class="hotline-list">
                        <div v-for="hotline in currentReply.crisisResources.resources.hotlines" 
                             :key="hotline.phone"
                             class="hotline-item">
                          <span class="hotline-name">{{ hotline.name }}</span>
                          <a :href="'tel:' + hotline.phone" class="hotline-phone">ğŸ“ {{ hotline.phone }}</a>
                          <span class="hotline-time">{{ hotline.available }}</span>
                        </div>
                      </div>
                      
                      <div v-if="currentReply.crisisResources.resources.emergency_contacts" class="emergency-contacts">
                        <h6>ç´§æ€¥è”ç³»ï¼š</h6>
                        <div v-for="contact in currentReply.crisisResources.resources.emergency_contacts" 
                             :key="contact.phone"
                             class="emergency-item">
                          <a :href="'tel:' + contact.phone" class="emergency-phone">
                            {{ contact.name }}: {{ contact.phone }}
                          </a>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- æƒ…ç»ªæŠ¥å‘Šæ˜¾ç¤º -->
                  <div v-if="currentReply?.emotionReport" class="emotion-report-card">
                    <h4>ğŸ“Š æƒ…ç»ªåˆ†ææŠ¥å‘Š</h4>
                    <div class="stress-indicator-large">
                      <span class="stress-label">å‹åŠ›æŒ‡æ•°</span>
                      <div class="stress-circle" :class="getStressLevel(currentReply.emotionReport.stress_index)">
                        <span class="stress-number">{{ currentReply.emotionReport.stress_index }}</span>
                      </div>
                    </div>
                    <div class="main-emotions">
                      <span class="emotion-tag" 
                            v-for="emotion in currentReply.emotionReport.main_emotions" 
                            :key="emotion">
                        {{ emotion }}
                      </span>
                    </div>
                    
                    <!-- æƒ…ç»ªé›·è¾¾å›¾ -->
                    <div class="emotion-radar">
                      <h5>æƒ…ç»ªåˆ†æé›·è¾¾å›¾</h5>
                      <canvas ref="radarChart" width="300" height="300"></canvas>
                    </div>
                  </div>

                  <!-- å¾®ä»»åŠ¡æŒ‰é’®åŒº -->
                  <div v-if="currentReply?.followUpTasks" class="micro-tasks">
                    <h4>ğŸ¯ ä»Šæ—¥å°ä»»åŠ¡</h4>
                    <div class="task-buttons">
                      <button v-for="task in currentReply.followUpTasks" 
                              :key="task"
                              @click="completeTask(task)"
                              class="task-button">
                        {{ task }}
                      </button>
                    </div>
                  </div>

                  <!-- èµ„æºé“¾æ¥ -->
                  <div v-if="currentReply?.resourceLinks && currentReply.resourceLinks.length > 0" class="resource-links">
                    <h4>ğŸ”— æ¨èèµ„æº</h4>
                    <div class="link-buttons">
                      <button v-for="link in currentReply.resourceLinks" 
                              :key="link"
                              @click="openResource(link)"
                              class="resource-button">
                        {{ link }}
                      </button>
                    </div>
                  </div>
                  
                  <video v-if="currentReply?.videoUrl" 
                         :src="currentReply.videoUrl" 
                         controls 
                         autoplay 
                         class="reply-video">
                  </video>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </transition>
  </div>
</template>

<script>
import { ref, computed, onMounted, nextTick } from 'vue'
import { useRouter } from 'vue-router'

export default {
  name: 'MessengerView',
  setup() {
    const router = useRouter()
    
    // åŸºç¡€çŠ¶æ€
    const inputText = ref('')
    const selectedImage = ref(null)
    const isRecording = ref(false)
    const isSending = ref(false)
    const anonymousMode = ref(false)
    const showHistory = ref(false)
    const showGuidance = ref(true)
    const showPrivacyTip = ref(false)
    
    // å¯Œæ–‡æœ¬ç¼–è¾‘å™¨ç›¸å…³
    const showEmojiPanel = ref(false)
    const currentEmojiCategory = ref('emotion')
    const textLength = ref(0)
    
    // è¡¨æƒ…æ•°æ®
    const emojiData = {
      emotion: ['ğŸ˜Š', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ¤£', 'ğŸ˜‚', 'ğŸ™‚', 'ğŸ™ƒ', 'ğŸ˜‰', 'ğŸ˜‡', 'ğŸ¥°', 'ğŸ˜', 'ğŸ¤©', 'ğŸ˜˜', 'ğŸ˜—', 'ğŸ˜š', 'ğŸ˜™', 'ğŸ˜‹', 'ğŸ˜›', 'ğŸ˜œ', 'ğŸ¤ª', 'ğŸ˜', 'ğŸ¤‘', 'ğŸ¤—', 'ğŸ¤­', 'ğŸ¤«', 'ğŸ¤”', 'ğŸ˜', 'ğŸ˜‘', 'ğŸ˜¶', 'ğŸ˜', 'ğŸ˜’', 'ğŸ™„', 'ğŸ˜¬', 'ğŸ¤¥', 'ğŸ˜”', 'ğŸ˜ª', 'ğŸ¤¤', 'ğŸ˜´', 'ğŸ˜·', 'ğŸ¤’', 'ğŸ¤•', 'ğŸ¤¢', 'ğŸ¤®', 'ğŸ¤§', 'ğŸ¥µ', 'ğŸ¥¶', 'ğŸ¥´', 'ğŸ˜µ', 'ğŸ¤¯', 'ğŸ¤ ', 'ğŸ¥³', 'ğŸ˜', 'ğŸ¤“', 'ğŸ§'],
      heart: ['â¤ï¸', 'ğŸ§¡', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™', 'ğŸ’œ', 'ğŸ–¤', 'ğŸ¤', 'ğŸ¤', 'ğŸ’”', 'â£ï¸', 'ğŸ’•', 'ğŸ’', 'ğŸ’“', 'ğŸ’—', 'ğŸ’–', 'ğŸ’˜', 'ğŸ’', 'ğŸ’Ÿ', 'ğŸ’Œ', 'ğŸ’’', 'ğŸ’', 'ğŸ’', 'ğŸŒ¹', 'ğŸŒº', 'ğŸŒ»', 'ğŸŒ·', 'ğŸŒ¸', 'ğŸ’'],
      nature: ['ğŸŒ¸', 'ğŸŒº', 'ğŸŒ»', 'ğŸŒ·', 'ğŸŒ¹', 'ğŸŒ¾', 'ğŸŒ¿', 'ğŸ€', 'ğŸŒ±', 'ğŸŒ³', 'ğŸŒ²', 'ğŸŒ´', 'ğŸŒµ', 'ğŸŒ¶ï¸', 'ğŸ„', 'ğŸŒ°', 'ğŸŒ™', 'â­', 'ğŸŒŸ', 'ğŸ’«', 'âœ¨', 'â˜€ï¸', 'ğŸŒ¤ï¸', 'â›…', 'ğŸŒ¥ï¸', 'â˜ï¸', 'ğŸŒ¦ï¸', 'ğŸŒ§ï¸', 'â›ˆï¸', 'ğŸŒ©ï¸', 'ğŸŒ¨ï¸', 'â„ï¸', 'â˜ƒï¸', 'â›„', 'ğŸŒˆ', 'ğŸŒŠ', 'ğŸ’§', 'ğŸ’¦', 'ğŸ”¥'],
      study: ['ğŸ“š', 'ğŸ“–', 'ğŸ“', 'âœï¸', 'ğŸ–Šï¸', 'ğŸ–‹ï¸', 'âœ’ï¸', 'ğŸ““', 'ğŸ“”', 'ğŸ“•', 'ğŸ“—', 'ğŸ“˜', 'ğŸ“™', 'ğŸ“’', 'ğŸ“„', 'ğŸ“ƒ', 'ğŸ“‘', 'ğŸ“Š', 'ğŸ“ˆ', 'ğŸ“‰', 'ğŸ“‡', 'ğŸ“‹', 'ğŸ“Œ', 'ğŸ“', 'ğŸ“', 'ğŸ–‡ï¸', 'ğŸ“', 'ğŸ“', 'âœ‚ï¸', 'ğŸ—ƒï¸', 'ğŸ—‚ï¸', 'ğŸ—ï¸', 'ğŸ“°', 'ğŸ“¦', 'ğŸ†', 'ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰', 'ğŸ¯', 'ğŸ“', 'ğŸ’¡', 'ğŸ”¬', 'ğŸ”­', 'âš—ï¸', 'ğŸ§®', 'ğŸ’»', 'ğŸ–¥ï¸', 'ğŸ–¨ï¸', 'âŒ¨ï¸', 'ğŸ–±ï¸']
    }
    
    // åŠ¨ç”»çŠ¶æ€
    const showSendAnimation = ref(false)
    const animationStep = ref('') // 'folding', 'flying'
    
    // å›¾åƒç›¸å…³çŠ¶æ€
    const imageInfo = ref({ size: '', type: '' })
    
    // å›ä¿¡ç›¸å…³
    const currentReply = ref(null)
    const replyOpened = ref(false)
    const showReplyModal = ref(false)  // æ–°å¢ï¼šæ§åˆ¶å›ä¿¡æµ®çª—æ˜¾ç¤º
    
    // è¯­éŸ³æœ—è¯»ç›¸å…³
    const isSpeaking = ref(false)
    const speechPaused = ref(false)
    let speechSynthesis = null
    let currentUtterance = null
    
    // å†å²æ¶ˆæ¯
    const messageHistory = ref([])
    
    // å¼•ç”¨
    const textInput = ref(null)
    const imageInput = ref(null)
    const imageCanvas = ref(null)
    const radarChart = ref(null)
    const teacherVideo = ref(null)  // æ–°å¢ï¼šå¿ƒç†è¾…å¯¼è€å¸ˆè§†é¢‘å¼•ç”¨
    
    // åª’ä½“å½•åˆ¶
    let mediaRecorder = null
    let audioChunks = []
    
    // å¼•å¯¼æ–‡æœ¬
    const guidanceTexts = [
      "ä»ä»Šå¤©çš„å‹åŠ›è¯´èµ·å§ï¼Ÿ",
      "æœ‰ä»€ä¹ˆæƒ³è¦åˆ†äº«çš„å¿ƒæƒ…å—ï¼Ÿ",
      "å­¦ä¹ ä¸­é‡åˆ°äº†ä»€ä¹ˆå›°éš¾ï¼Ÿ",
      "æœ€è¿‘æœ‰ä»€ä¹ˆè®©ä½ å¼€å¿ƒçš„äº‹æƒ…ï¼Ÿ",
      "æƒ³èŠèŠä½ çš„æ‹…å¿§å—ï¼Ÿ"
    ]
    
    const guidanceText = ref(guidanceTexts[Math.floor(Math.random() * guidanceTexts.length)])
    const privacyTipText = ref('åŒ¿åæ¨¡å¼ä¸‹ï¼Œæ‚¨çš„ä¿¡æ¯ä¸ä¼šè¢«ä¿å­˜ï¼Œè¯·æ”¾å¿ƒå€¾è¯‰ã€‚')

    // è®¡ç®—å±æ€§
    const canSend = ref(true)
    const currentEmojis = computed(() => {
      return emojiData[currentEmojiCategory.value] || emojiData.emotion
    })
    
    const speechButtonTitle = computed(() => {
      if (!isSpeaking.value && !speechPaused.value) {
        return 'å¼€å§‹æœ—è¯»å›ä¿¡'
      } else if (isSpeaking.value && !speechPaused.value) {
        return 'æš‚åœæœ—è¯»'
      } else {
        return 'ç»§ç»­æœ—è¯»'
      }
    })
    
    // é¡µé¢æ–¹æ³•
    const goBack = () => {
      console.log('goBackæ–¹æ³•è¢«è°ƒç”¨')
      try {
        router.push('/dashboard')
        console.log('è·¯ç”±è·³è½¬è¯·æ±‚å·²å‘é€')
      } catch (error) {
        console.error('è·¯ç”±è·³è½¬å¤±è´¥:', error)
      }
    }

    const hideGuidance = () => {
      showGuidance.value = false
      nextTick(() => {
        textInput.value?.focus()
      })
    }

    const toggleAnonymous = () => {
      anonymousMode.value = !anonymousMode.value
      if (anonymousMode.value) {
        showPrivacyTip.value = true
      }
    }

    const toggleHistory = async () => {
      showHistory.value = !showHistory.value
      if (showHistory.value && messageHistory.value.length === 0) {
        await loadMessageHistory()
      }
    }

    // æ–‡ä»¶å¤„ç†
    const triggerImageUpload = () => {
      imageInput.value?.click()
    }

    const handleImageUpload = (event) => {
      const file = event.target.files[0]
      if (file) {
        // è®°å½•å›¾åƒä¿¡æ¯
        imageInfo.value = {
          size: (file.size / 1024 / 1024).toFixed(2) + 'MB',
          type: file.type.split('/')[1].toUpperCase()
        }
        
        const reader = new FileReader()
        reader.onload = (e) => {
          selectedImage.value = e.target.result
          // ä½¿ç”¨Canvasç»˜åˆ¶é¢„è§ˆ
          nextTick(() => {
            drawImagePreview(e.target.result)
          })
        }
        reader.readAsDataURL(file)
      }
    }

    const drawImagePreview = (imageSrc) => {
      const canvas = imageCanvas.value
      if (!canvas) return
      
      const ctx = canvas.getContext('2d')
      const img = new Image()
      
      img.onload = () => {
        // è®¾ç½®Canvaså°ºå¯¸
        const maxWidth = 200
        const maxHeight = 150
        let { width, height } = img
        
        // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹
        const ratio = Math.min(maxWidth / width, maxHeight / height)
        width *= ratio
        height *= ratio
        
        canvas.width = width
        canvas.height = height
        
        // æ¸…ç©ºå¹¶ç»˜åˆ¶å›¾åƒ
        ctx.clearRect(0, 0, width, height)
        ctx.drawImage(img, 0, 0, width, height)
        
        // æ·»åŠ è¾¹æ¡†æ•ˆæœ
        ctx.strokeStyle = 'rgba(139, 111, 71, 0.5)'
        ctx.lineWidth = 2
        ctx.strokeRect(0, 0, width, height)
      }
      
      img.src = imageSrc
    }

    const removeImage = () => {
      selectedImage.value = null
      imageInfo.value = { size: '', type: '' }
      if (imageInput.value) {
        imageInput.value.value = ''
      }
    }

    // è¯­éŸ³å¤„ç†ç›¸å…³å˜é‡
    let recognition = null
    let speechStartTime = null
    const speechTranscript = ref('') // æ”¹ä¸ºå“åº”å¼å˜é‡
    let speechStream = null

    // è¯­éŸ³å¤„ç†
    const startVoiceInput = async () => {
      try {
        // è·å–éŸ³é¢‘æµ
        speechStream = await navigator.mediaDevices.getUserMedia({ 
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            autoGainControl: true
          }
        })
        
        // åˆå§‹åŒ–MediaRecorderï¼ˆç”¨äºä¿å­˜éŸ³é¢‘ï¼‰
        mediaRecorder = new MediaRecorder(speechStream)
        audioChunks = []
        
        // è®°å½•å¼€å§‹æ—¶é—´
        speechStartTime = Date.now()
        speechTranscript.value = '' // æ¸…ç©ºä¹‹å‰çš„è½¬å½•ç»“æœ
        console.log('è¯­éŸ³å½•åˆ¶å¼€å§‹ï¼Œæ—¶é—´:', speechStartTime)
        
        mediaRecorder.ondataavailable = (event) => {
          audioChunks.push(event.data)
        }
        
        // å¯åŠ¨è¯­éŸ³è¯†åˆ«
        if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
          try {
            // æ·»åŠ å°å»¶è¿Ÿç¡®ä¿éŸ³é¢‘æµå‡†å¤‡å°±ç»ª
            await new Promise(resolve => setTimeout(resolve, 100))
            await startSpeechRecognition()
          } catch (speechError) {
            // è¯­éŸ³è¯†åˆ«å¤±è´¥æ—¶é™é»˜å¤„ç†ï¼Œä»ç„¶å¯ä»¥å½•éŸ³
          }
        }
        
        // å¼€å§‹å½•éŸ³
        mediaRecorder.start()
        isRecording.value = true
        
      } catch (error) {
        let errorMessage = 'æ— æ³•å¯åŠ¨è¯­éŸ³è¾“å…¥ï¼š'
        if (error.name === 'NotAllowedError') {
          errorMessage += 'è¯·å…è®¸éº¦å…‹é£æƒé™'
        } else if (error.name === 'NotFoundError') {
          errorMessage += 'æœªæ‰¾åˆ°éº¦å…‹é£è®¾å¤‡'
        } else if (error.name === 'NotSupportedError') {
          errorMessage += 'æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘å½•åˆ¶'
        } else {
          errorMessage += error.message
        }
        
        alert(errorMessage)
      }
    }

    const stopVoiceInput = () => {
      if (isRecording.value) {
        // åœæ­¢è¯­éŸ³è¯†åˆ«
        if (recognition) {
          recognition.stop()
        }
        
        // åœæ­¢å½•éŸ³
        if (mediaRecorder) {
          mediaRecorder.stop()
        }
        
        // åœæ­¢éŸ³é¢‘æµ
        if (speechStream) {
          speechStream.getTracks().forEach(track => track.stop())
          speechStream = null
        }
        
        isRecording.value = false
        
        // ä¸å†åœ¨è¿™é‡Œè°ƒç”¨ processFinalResultï¼Œè€Œæ˜¯åœ¨ recognition.onend ä¸­è°ƒç”¨
        console.log('åœæ­¢å½•éŸ³ï¼Œç­‰å¾…è¯­éŸ³è¯†åˆ«ç»“æŸ...')
      }
    }

    // å¯åŠ¨è¯­éŸ³è¯†åˆ«
    const startSpeechRecognition = () => {
      return new Promise((resolve, reject) => {
        try {
          // æ£€æŸ¥è¯­éŸ³è¯†åˆ«APIæ”¯æŒ
          const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition
          if (!SpeechRecognition) {
            reject(new Error('æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«'))
            return
          }
          
          recognition = new SpeechRecognition()
          
          // é…ç½®è¯­éŸ³è¯†åˆ«
          recognition.lang = 'zh-CN'
          recognition.continuous = true  // è¿ç»­è¯†åˆ«
          recognition.interimResults = true  // å¯ç”¨ä¸­é—´ç»“æœï¼Œæé«˜è¯†åˆ«ç‡
          recognition.maxAlternatives = 1
          
          recognition.onstart = () => {
            resolve()
          }
          
          recognition.onresult = (event) => {
            console.log('è¯­éŸ³è¯†åˆ«ç»“æœäº‹ä»¶è§¦å‘ï¼Œç»“æœæ•°é‡:', event.results.length)
            let finalTranscript = ''
            
            for (let i = event.resultIndex; i < event.results.length; i++) {
              const result = event.results[i]
              console.log(`ç»“æœ ${i}: ${result[0].transcript}, isFinal: ${result.isFinal}`)
              
              if (result.isFinal) {
                finalTranscript += result[0].transcript
              }
            }
            
            // æ›´æ–°å…¨å±€è½¬å½•æ–‡æœ¬
            if (finalTranscript.trim()) {
              console.log('æ·»åŠ æœ€ç»ˆè½¬å½•æ–‡æœ¬:', finalTranscript)
              speechTranscript.value += finalTranscript
              console.log('å½“å‰å®Œæ•´è½¬å½•æ–‡æœ¬:', speechTranscript.value)
            }
          }
          
          recognition.onerror = (event) => {
            console.log('è¯­éŸ³è¯†åˆ«é”™è¯¯:', event.error)
            // é™é»˜å¤„ç†æŸäº›é”™è¯¯ï¼Œé¿å…å½±å“ç”¨æˆ·ä½“éªŒ
            if (event.error !== 'no-speech' && event.error !== 'aborted') {
              console.error('è¯­éŸ³è¯†åˆ«ä¸¥é‡é”™è¯¯:', event.error)
              reject(event.error)
            }
          }
          
          recognition.onend = () => {
            console.log('è¯­éŸ³è¯†åˆ«ç»“æŸï¼Œå½“å‰è½¬å½•æ–‡æœ¬:', speechTranscript.value)
            // è¯­éŸ³è¯†åˆ«çœŸæ­£ç»“æŸåï¼Œå†å¤„ç†æœ€ç»ˆç»“æœ
            setTimeout(() => {
              processFinalResult()
            }, 100) // çŸ­æš‚å»¶è¿Ÿç¡®ä¿æ‰€æœ‰å¤„ç†å®Œæˆ
          }
          
          // å¯åŠ¨è¯†åˆ«ï¼Œæ·»åŠ å°å»¶è¿Ÿç¡®ä¿å‡†å¤‡å°±ç»ª
          setTimeout(() => {
            recognition.start()
          }, 50)
          
        } catch (error) {
          reject(error)
        }
      })
    }

    // å¤„ç†æœ€ç»ˆç»“æœ
    const processFinalResult = () => {
      console.log('processFinalResult è¢«è°ƒç”¨')
      
      // ç«‹å³ä¿å­˜å½“å‰çš„è½¬å½•æ–‡æœ¬ï¼Œé¿å…è¢«åç»­æ“ä½œæ¸…ç©º
      const currentTranscript = speechTranscript.value
      console.log('å½“å‰è½¬å½•æ–‡æœ¬å¿«ç…§:', currentTranscript)
      
      const endTime = Date.now()
      const duration = speechStartTime ? (endTime - speechStartTime) / 1000 : 0
      console.log('å½•éŸ³æ—¶é•¿:', duration, 'ç§’')
      console.log('è¯†åˆ«çš„æ–‡å­—:', currentTranscript)
      
      // è®¡ç®—è¯­é€Ÿï¼ˆåŸºäºå®é™…è½¬å½•çš„æ–‡å­—ï¼‰
      const wordCount = currentTranscript.replace(/\s+/g, '').length // ä¸­æ–‡å­—ç¬¦æ•°
      const wordsPerMinute = duration > 0 ? Math.round((wordCount / duration) * 60) : 0
      
      // æ„å»ºæœ€ç»ˆæ–‡æœ¬
      let finalText = ''
      if (currentTranscript.trim()) {
        // æˆåŠŸè¯†åˆ«åˆ°æ–‡å­—
        finalText = currentTranscript.trim()
        const audioInfo = `[è¯­éŸ³æ—¶é•¿: ${duration.toFixed(1)}ç§’, è¯­é€Ÿ: ${wordsPerMinute}å­—/åˆ†é’Ÿ]`
        finalText += `\n${audioInfo}`
      } else {
        // æ²¡æœ‰è¯†åˆ«åˆ°æ–‡å­—
        finalText = `[è¯­éŸ³è¯†åˆ«æœªæˆåŠŸï¼Œä½†å·²å½•åˆ¶éŸ³é¢‘] [è¯­éŸ³æ—¶é•¿: ${duration.toFixed(1)}ç§’, è¯­é€Ÿ: 0å­—/åˆ†é’Ÿ]`
      }
      
      console.log('æœ€ç»ˆæ–‡æœ¬:', finalText)
      
      // æ·»åŠ åˆ°è¾“å…¥æ¡† - ä¿®å¤æ¢è¡Œç¬¦é—®é¢˜
      const currentText = inputText.value.trim() // å»é™¤ç°æœ‰æ–‡æœ¬çš„é¦–å°¾ç©ºç™½
      let newText = ''
      
      if (currentText) {
        // å¦‚æœæœ‰ç°æœ‰æ–‡æœ¬ï¼Œæ·»åŠ ä¸¤ä¸ªæ¢è¡Œç¬¦åˆ†éš”
        newText = currentText + '\n\n' + finalText
      } else {
        // å¦‚æœæ²¡æœ‰ç°æœ‰æ–‡æœ¬ï¼Œç›´æ¥ä½¿ç”¨æ–°æ–‡æœ¬ï¼ˆé¿å…å¼€å¤´çš„æ¢è¡Œç¬¦ï¼‰
        newText = finalText
      }
      
      inputText.value = newText
      console.log('è®¾ç½®inputText:', newText)
      
      // åŒæ­¥æ›´æ–°å¯Œæ–‡æœ¬ç¼–è¾‘å™¨æ˜¾ç¤º
      nextTick(() => {
        if (textInput.value) {
          textInput.value.innerText = newText
          textLength.value = newText.length
          console.log('å·²æ›´æ–°å¯Œæ–‡æœ¬ç¼–è¾‘å™¨')
          
          // å°†å…‰æ ‡ç§»åˆ°æœ«å°¾
          const range = document.createRange()
          const selection = window.getSelection()
          range.selectNodeContents(textInput.value)
          range.collapse(false)
          selection.removeAllRanges()
          selection.addRange(range)
        } else {
          console.log('textInput.value ä¸ºç©ºï¼Œæ— æ³•æ›´æ–°ç¼–è¾‘å™¨')
        }
      })
    }

    // å¯Œæ–‡æœ¬ç¼–è¾‘å™¨å‡½æ•°
    const handleRichTextInput = () => {
      const editor = textInput.value
      if (!editor) return
      
      // æ›´æ–°æ–‡æœ¬é•¿åº¦
      textLength.value = editor.innerText.length
      
      // é™åˆ¶å­—ç¬¦æ•°
      if (textLength.value > 1000) {
        editor.innerText = editor.innerText.substring(0, 1000)
      }
      
      // æ›´æ–° inputText ä¸ºçº¯æ–‡æœ¬ç‰ˆæœ¬ï¼ˆç”¨äºå‘é€ï¼‰
      inputText.value = editor.innerText
    }

    const formatText = (format) => {
      const editor = textInput.value
      if (!editor) return
      
      // ç¡®ä¿ç¼–è¾‘å™¨è·å¾—ç„¦ç‚¹
      editor.focus()
      
      // ä½¿ç”¨æµè§ˆå™¨çš„execCommandæ¥å®ç°çœŸå®çš„å¯Œæ–‡æœ¬æ ¼å¼åŒ–
      try {
        document.execCommand(format, false, null)
      } catch (e) {
        console.error('æ ¼å¼åŒ–å¤±è´¥:', e)
      }
      
      // æ›´æ–°æ–‡æœ¬å†…å®¹
      handleRichTextInput()
    }

    const insertEmoji = (emoji) => {
      const editor = textInput.value
      if (!editor) return
      
      // ç¡®ä¿ç¼–è¾‘å™¨è·å¾—ç„¦ç‚¹
      editor.focus()
      
      // æ’å…¥è¡¨æƒ…
      try {
        document.execCommand('insertText', false, emoji)
      } catch (e) {
        // é™çº§æ–¹æ¡ˆï¼šç›´æ¥æ·»åŠ åˆ°å†…å®¹
        const selection = window.getSelection()
        if (selection.rangeCount > 0) {
          const range = selection.getRangeAt(0)
          const textNode = document.createTextNode(emoji)
          range.insertNode(textNode)
          range.setStartAfter(textNode)
          range.setEndAfter(textNode)
          selection.removeAllRanges()
          selection.addRange(range)
        } else {
          editor.innerHTML += emoji
        }
      }
      
      // å…³é—­è¡¨æƒ…é¢æ¿
      showEmojiPanel.value = false
      
      // æ›´æ–°æ–‡æœ¬å†…å®¹
      handleRichTextInput()
    }

    const toggleEmojiPanel = () => {
      showEmojiPanel.value = !showEmojiPanel.value
    }

    const setEmojiCategory = (category) => {
      currentEmojiCategory.value = category
    }

    // è§†é¢‘æ’­æ”¾æ§åˆ¶å‡½æ•°
    const onVideoLoaded = () => {
      const video = teacherVideo.value
      if (video) {
        console.log('è§†é¢‘å·²åŠ è½½ï¼Œæ€»æ—¶é•¿:', video.duration, 'ç§’')
      }
    }

    const onVideoTimeUpdate = () => {
      // å¾ªç¯æ’­æ”¾æ¨¡å¼ï¼šç§»é™¤æš‚åœé€»è¾‘ï¼Œè®©è§†é¢‘è‡ªç„¶å¾ªç¯
      // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å…¶ä»–è§†é¢‘æ’­æ”¾ç›‘æ§é€»è¾‘ï¼ˆå¦‚æœéœ€è¦çš„è¯ï¼‰
    }

    const onVideoEnded = () => {
      const video = teacherVideo.value
      if (video) {
        console.log('è§†é¢‘æ’­æ”¾ç»“æŸï¼Œå‡†å¤‡å¾ªç¯')
        // å¾ªç¯æ’­æ”¾æ¨¡å¼ï¼šè®©è§†é¢‘è‡ªç„¶é‡æ–°å¼€å§‹ï¼Œä¸æ‰‹åŠ¨è®¾ç½®æ—¶é—´
        // loopå±æ€§ä¼šè‡ªåŠ¨å¤„ç†å¾ªç¯é€»è¾‘
      }
    }

    // è¯­éŸ³æœ—è¯»åŠŸèƒ½
    const initSpeechSynthesis = () => {
      console.log('ä½¿ç”¨Qwen-TTSè¯­éŸ³åˆæˆæœåŠ¡')
    }

    const extractTextFromHTML = (htmlContent) => {
      if (!htmlContent) return ''
      
      // åˆ›å»ºä¸´æ—¶DOMå…ƒç´ æ¥è§£æHTML
      const tempDiv = document.createElement('div')
      tempDiv.innerHTML = htmlContent
      
      // æå–çº¯æ–‡æœ¬å†…å®¹
      let text = tempDiv.textContent || tempDiv.innerText || ''
      
      // æ¸…ç†æ–‡æœ¬ï¼šç§»é™¤å¤šä½™ç©ºç™½å­—ç¬¦
      text = text.replace(/\s+/g, ' ').trim()
      
      // ç§»é™¤emojiè¡¨æƒ…ç¬¦å·
      text = text.replace(/[\u{1F600}-\u{1F64F}]/gu, '') // è¡¨æƒ…ç¬¦å·
      text = text.replace(/[\u{1F300}-\u{1F5FF}]/gu, '') // æ‚é¡¹ç¬¦å·
      text = text.replace(/[\u{1F680}-\u{1F6FF}]/gu, '') // äº¤é€šè¿è¾“ç¬¦å·
      text = text.replace(/[\u{1F700}-\u{1F77F}]/gu, '') // ç‚¼é‡‘æœ¯ç¬¦å·
      text = text.replace(/[\u{1F780}-\u{1F7FF}]/gu, '') // å‡ ä½•å½¢çŠ¶æ‰©å±•
      text = text.replace(/[\u{1F800}-\u{1F8FF}]/gu, '') // è¡¥å……ç®­å¤´-C
      text = text.replace(/[\u{1F900}-\u{1F9FF}]/gu, '') // è¡¥å……ç¬¦å·å’Œè±¡å½¢æ–‡å­—
      text = text.replace(/[\u{1FA00}-\u{1FA6F}]/gu, '') // æ‰©å±•A
      text = text.replace(/[\u{1FA70}-\u{1FAFF}]/gu, '') // æ‰©å±•B
      text = text.replace(/[\u{2600}-\u{26FF}]/gu, '')   // æ‚é¡¹ç¬¦å·
      text = text.replace(/[\u{2700}-\u{27BF}]/gu, '')   // è£…é¥°ç¬¦å·
      text = text.replace(/[\u{FE00}-\u{FE0F}]/gu, '')   // å˜å¼‚é€‰æ‹©å™¨
      text = text.replace(/[\u{1F1E0}-\u{1F1FF}]/gu, '') // æ——å¸œ
      
      // ç§»é™¤å¸¸è§çš„æ–‡æœ¬emojiè¡¨æƒ… - ä½¿ç”¨åˆ†ç¦»çš„æ›¿æ¢é¿å…å­—ç¬¦ç±»é—®é¢˜
      const emojiList = ['ğŸ”Š', 'â¸ï¸', 'â–¶ï¸', 'ğŸš¨', 'âš ï¸', 'ğŸ¬', 'âœ¨', 'ğŸ¤', 'ğŸ‰', 'ğŸ¯', 'âš¡', 'ğŸŒŸ', 'ğŸ’ª', 
                        'â¤ï¸', 'ğŸ’™', 'ğŸ’š', 'ğŸ’›', 'ğŸ’œ', 'ğŸ§¡', 'ğŸ¤', 'ğŸ–¤', 'ğŸ’', 'ğŸ’–', 'ğŸ’—', 'ğŸ’“', 'ğŸ’•', 
                        'ğŸ’˜', 'ğŸ’Ÿ', 'â£ï¸', 'ğŸ’”', 'ğŸ’‹', 'ğŸ‘‹', 'ğŸ¤š', 'ğŸ–ï¸', 'âœ‹', 'ğŸ––', 'ğŸ‘Œ', 'ğŸ¤Œ', 'ğŸ¤', 
                        'âœŒï¸', 'ğŸ¤', 'ğŸ¤Ÿ', 'ğŸ¤˜', 'ğŸ¤™', 'ğŸ‘ˆ', 'ğŸ‘‰', 'ğŸ‘†', 'ğŸ–•', 'ğŸ‘‡', 'â˜ï¸', 'ğŸ‘', 'ğŸ‘', 
                        'ğŸ‘Š', 'âœŠ', 'ğŸ¤›', 'ğŸ¤œ', 'ğŸ‘', 'ğŸ™Œ', 'ğŸ‘', 'ğŸ¤²', 'ğŸ¤', 'ğŸ™']
      
      emojiList.forEach(emoji => {
        text = text.replace(new RegExp(emoji, 'g'), '')
      })
      
      // ç§»é™¤æ–¹æ‹¬å·å†…çš„è¡¨æƒ…æè¿°ï¼ˆå¦‚ [è¯­éŸ³æ—¶é•¿: 3.0ç§’, è¯­é€Ÿ: 0å­—/åˆ†é’Ÿ]ï¼‰
      text = text.replace(/\[.*?\]/g, '')
      
      // å†æ¬¡æ¸…ç†å¤šä½™ç©ºç™½
      text = text.replace(/\s+/g, ' ').trim()
      
      return text
    }

    const playAudioFromBytes = (audioData) => {
      return new Promise((resolve, reject) => {
        try {
          console.log('å‡†å¤‡æ’­æ”¾éŸ³é¢‘ï¼Œæ•°æ®å¤§å°:', audioData.byteLength)
          
          // åˆ›å»ºAudioå¯¹è±¡å¹¶æ’­æ”¾
          const audio = new Audio()
          const blob = new Blob([audioData], { type: 'audio/mpeg' })
          const audioUrl = URL.createObjectURL(blob)
          
          console.log('éŸ³é¢‘URL:', audioUrl)
          audio.src = audioUrl
          
          // è®¾ç½®éŸ³é‡ç¡®ä¿èƒ½å¬åˆ°
          audio.volume = 1.0
          audio.muted = false
          
          audio.onloadedmetadata = () => {
            console.log('éŸ³é¢‘å…ƒæ•°æ®å·²åŠ è½½ï¼Œæ—¶é•¿:', audio.duration, 'ç§’')
          }
          
          audio.oncanplay = () => {
            console.log('éŸ³é¢‘å¯ä»¥æ’­æ”¾')
          }
          
          audio.onplay = () => {
            console.log('éŸ³é¢‘å¼€å§‹æ’­æ”¾')
            isSpeaking.value = true
            speechPaused.value = false
          }
          
          audio.onpause = () => {
            console.log('éŸ³é¢‘æš‚åœ')
            speechPaused.value = true
          }
          
          audio.onended = () => {
            console.log('éŸ³é¢‘æ’­æ”¾ç»“æŸ')
            isSpeaking.value = false
            speechPaused.value = false
            URL.revokeObjectURL(audioUrl)
            resolve()
          }
          
          audio.onerror = (error) => {
            console.error('éŸ³é¢‘æ’­æ”¾é”™è¯¯:', error)
            console.error('éŸ³é¢‘é”™è¯¯è¯¦æƒ…:', audio.error)
            isSpeaking.value = false
            speechPaused.value = false
            URL.revokeObjectURL(audioUrl)
            reject(error)
          }
          
          // ä¿å­˜audioå¼•ç”¨ç”¨äºæ§åˆ¶
          currentUtterance = audio
          
          // å°è¯•æ’­æ”¾
          const playPromise = audio.play()
          if (playPromise !== undefined) {
            playPromise
              .then(() => {
                console.log('éŸ³é¢‘æ’­æ”¾å¼€å§‹æˆåŠŸ')
              })
              .catch((error) => {
                console.error('éŸ³é¢‘æ’­æ”¾å¤±è´¥:', error)
                if (error.name === 'NotAllowedError') {
                  alert('æµè§ˆå™¨éœ€è¦ç”¨æˆ·äº¤äº’æ‰èƒ½æ’­æ”¾éŸ³é¢‘ã€‚è¯·ç¡®ä¿ï¼š\n1. ç‚¹å‡»äº†é¡µé¢\n2. æµè§ˆå™¨æ²¡æœ‰é™éŸ³\n3. ç³»ç»ŸéŸ³é‡å·²å¼€å¯')
                } else if (error.name === 'NotSupportedError') {
                  alert('æµè§ˆå™¨ä¸æ”¯æŒæ­¤éŸ³é¢‘æ ¼å¼')
                }
                reject(error)
              })
          }
          
        } catch (error) {
          console.error('åˆ›å»ºéŸ³é¢‘æ’­æ”¾å™¨å¤±è´¥:', error)
          reject(error)
        }
      })
    }

    const startSpeech = async (text) => {
      if (!text) return
      
      try {
        console.log('å¼€å§‹TTSè½¬æ¢ï¼Œæ–‡æœ¬:', text)
        isSpeaking.value = true
        speechPaused.value = false
        
        // è°ƒç”¨åç«¯TTS API
        const response = await fetch('http://localhost:8000/api/v1/tts/convert', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            text: text,
            voice: 'Cherry',  // ä½¿ç”¨Cherryå¥³æ€§å£°éŸ³
            language_type: 'Chinese'
          })
        })
        
        if (!response.ok) {
          throw new Error(`TTS APIè¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`)
        }
        
        // è·å–éŸ³é¢‘æ•°æ®
        const audioData = await response.arrayBuffer()
        console.log('æ”¶åˆ°éŸ³é¢‘æ•°æ®ï¼Œå¤§å°:', audioData.byteLength, 'bytes')
        
        // è°ƒè¯•ï¼šä¿å­˜éŸ³é¢‘æ–‡ä»¶åˆ°æœ¬åœ°ï¼ˆå¯é€‰ï¼‰
        if (window.debugAudio) {
          const blob = new Blob([audioData], { type: 'audio/wav' })
          const url = URL.createObjectURL(blob)
          const a = document.createElement('a')
          a.href = url
          a.download = `tts_debug_${Date.now()}.wav`
          a.click()
          URL.revokeObjectURL(url)
          console.log('è°ƒè¯•éŸ³é¢‘æ–‡ä»¶å·²ä¸‹è½½')
        }
        
        // æ’­æ”¾éŸ³é¢‘
        await playAudioFromBytes(audioData)
        
      } catch (error) {
        console.error('TTSè½¬æ¢å¤±è´¥:', error)
        isSpeaking.value = false
        speechPaused.value = false
        alert(`è¯­éŸ³åˆæˆå¤±è´¥: ${error.message}`)
      }
    }

    const toggleSpeech = async () => {
      if (!currentReply.value?.content) {
        alert('æ²¡æœ‰å¯æœ—è¯»çš„å›ä¿¡å†…å®¹')
        return
      }
      
      if (!isSpeaking.value && !speechPaused.value) {
        // å¼€å§‹æœ—è¯»
        const textToRead = extractTextFromHTML(currentReply.value.content)
        console.log('å‡†å¤‡æœ—è¯»çš„æ–‡æœ¬:', textToRead)
        
        if (!textToRead.trim()) {
          alert('æ²¡æœ‰å¯æœ—è¯»çš„æ–‡æœ¬å†…å®¹')
          return
        }
        
        await startSpeech(textToRead)
      } else if (isSpeaking.value && !speechPaused.value && currentUtterance) {
        // æš‚åœæœ—è¯»
        if (currentUtterance.pause) {
          currentUtterance.pause()
        }
      } else if (speechPaused.value && currentUtterance) {
        // ç»§ç»­æœ—è¯»
        if (currentUtterance.play) {
          currentUtterance.play().catch(console.error)
          speechPaused.value = false
        }
      }
    }

    const stopSpeech = () => {
      if (currentUtterance) {
        if (currentUtterance.pause) {
          currentUtterance.pause()
        }
        if (currentUtterance.src && currentUtterance.src.startsWith('blob:')) {
          URL.revokeObjectURL(currentUtterance.src)
        }
        currentUtterance = null
      }
      isSpeaking.value = false
      speechPaused.value = false
    }

    const handlePaste = (event) => {
      // é˜»æ­¢é»˜è®¤ç²˜è´´è¡Œä¸º
      event.preventDefault()
      
      // è·å–çº¯æ–‡æœ¬å†…å®¹
      const text = (event.clipboardData || window.clipboardData).getData('text')
      
      // æ’å…¥çº¯æ–‡æœ¬
      document.execCommand('insertText', false, text)
      
      // æ›´æ–°æ–‡æœ¬å†…å®¹
      handleRichTextInput()
    }

    const handleKeyDown = (event) => {
      // æ”¯æŒä¸€äº›å¿«æ·é”®
      if (event.ctrlKey || event.metaKey) {
        switch (event.key) {
          case 'b':
            event.preventDefault()
            formatText('bold')
            break
          case 'i':
            event.preventDefault()
            formatText('italic')
            break
          case 'u':
            event.preventDefault()
            formatText('underline')
            break
        }
      }
      
      // Enteré”®å‘é€
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault()
        sendMessage()
      }
      
      // é™åˆ¶å­—æ•°
      if (textLength.value >= 1000 && !['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'].includes(event.key)) {
        event.preventDefault()
      }
    }

    // å‘é€æ¶ˆæ¯
    const sendMessage = async () => {
      if (!inputText.value.trim() && !selectedImage.value) return
      
      isSending.value = true
      canSend.value = false

      try {
        // å¼€å§‹ä¿¡ä»¶å‘é€åŠ¨ç”»
        await startSendAnimation()

        // å‡†å¤‡å‘é€æ•°æ®
        const formData = new FormData()
        formData.append('message_type', getMessageType())
        formData.append('anonymous_mode', anonymousMode.value)
        
        if (inputText.value.trim()) {
          formData.append('text_content', inputText.value.trim())
        }
        
        if (selectedImage.value) {
          // å°†base64è½¬æ¢ä¸ºæ–‡ä»¶
          const imageFile = await base64ToFile(selectedImage.value, 'image.png')
          formData.append('image_file', imageFile)
        }

        // æ¨¡æ‹ŸAPIè°ƒç”¨
        const response = await makeAPICall(formData)
        
        // æ˜¾ç¤ºå›ä¿¡
        await showReplyAnimation(response)
        
        // æ¸…ç©ºè¾“å…¥
        inputText.value = ''
        selectedImage.value = null
        
        // åˆ·æ–°å†å²
        if (showHistory.value) {
          await loadMessageHistory()
        }

      } catch (error) {
        console.error('å‘é€å¤±è´¥:', error)
        alert('å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•')
      } finally {
        isSending.value = false
        canSend.value = true
      }
    }

    // å¼€å§‹å‘é€åŠ¨ç”»
    const startSendAnimation = async () => {
      showSendAnimation.value = true
      animationStep.value = 'appearing'
      
      // ä¿¡å°å‡ºç°åŠ¨ç”»æŒç»­2ç§’
      await new Promise(resolve => setTimeout(resolve, 2000))
      
      // æ— ç¼åˆ‡æ¢åˆ°é£è¡ŒåŠ¨ç”»ï¼ˆæ— å»¶è¿Ÿï¼‰
      animationStep.value = 'flying'
      
      // ä¿¡å°é£è¡ŒåŠ¨ç”»æŒç»­2.8ç§’ï¼ˆæ›´é•¿çš„é£è¡Œæ—¶é—´ï¼Œæ›´ä¸æ»‘ï¼‰
      await new Promise(resolve => setTimeout(resolve, 2800))
      
      // åŠ¨ç”»ç»“æŸ
      showSendAnimation.value = false
      animationStep.value = ''
    }

    // åŠ¨ç”»ç»“æŸå›è°ƒ
    const onLetterSent = () => {
      console.log('ä¿¡ä»¶å‘é€åŠ¨ç”»å®Œæˆ')
    }

    // æ˜¾ç¤ºå›ä¿¡åŠ¨ç”»
    const showReplyAnimation = async (response) => {
        // è®¾ç½®å®Œæ•´çš„å›ä¿¡å†…å®¹
        currentReply.value = {
          content: response.ai_reply_text,
          videoUrl: response.video_url,
          emotionReport: response.emotion_report,
          followUpTasks: response.ai_reply?.follow_up_tasks || [
            'æ·±å‘¼å¸3åˆ†é’Ÿ',
            'å†™ä¸‹ä¸€ä»¶å¼€å¿ƒçš„äº‹',
            'ç»™è‡ªå·±ä¸€ä¸ªæ‹¥æŠ±'
          ],
          resourceLinks: response.ai_reply?.resource_links || [],
          crisisResources: response.crisis_resources || null
        }      // é‡ç½®æ‰“å¼€çŠ¶æ€
      replyOpened.value = false
      
      // ç­‰å¾…ä¸€ä¸‹è®©ä¿¡å°å…ˆå‡ºç°
      await new Promise(resolve => setTimeout(resolve, 500))
      
      console.log('å›ä¿¡å·²é£˜å…¥ï¼Œç‚¹å‡»ä¿¡å°å¯ä»¥æŸ¥çœ‹å†…å®¹')
    }

    const getMessageType = () => {
      if (inputText.value && selectedImage.value) return 'mixed'
      if (selectedImage.value) return 'image'
      if (inputText.value.includes('[è¯­éŸ³æ¶ˆæ¯å·²å½•åˆ¶]')) return 'audio'
      return 'text'
    }

    const base64ToFile = async (base64String, filename) => {
      const response = await fetch(base64String)
      const blob = await response.blob()
      return new File([blob], filename, { type: blob.type })
    }

    // æ¨¡æ‹ŸAPIè°ƒç”¨ - æ”¹ä¸ºçœŸå®APIè°ƒç”¨
    const makeAPICall = async (formData) => {
      try {
        const token = localStorage.getItem('access_token')
        const response = await fetch('/api/v1/messengers/send-message', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          },
          body: formData
        })
        
        if (!response.ok) {
          throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`)
        }
        
        return await response.json()
      } catch (error) {
        console.error('APIè°ƒç”¨å¤±è´¥:', error)
        // å¦‚æœAPIå¤±è´¥ï¼Œå›é€€åˆ°æ¨¡æ‹Ÿæ•°æ®
        return simulateAPICall()  // ç§»é™¤æœªä½¿ç”¨çš„å‚æ•°
      }
    }

    // æ¨¡æ‹ŸAPIè°ƒç”¨ï¼ˆä½œä¸ºåå¤‡ï¼‰
    const simulateAPICall = async () => {  // ç§»é™¤æœªä½¿ç”¨çš„ formData å‚æ•°
      return new Promise((resolve) => {
        setTimeout(() => {
          const stressIndex = 86  // å†™æ­»å‹åŠ›æŒ‡æ•°ä¸º86ï¼Œæ˜¾ç¤ºå‹åŠ›å¾ˆå¤§
          const emotions = ['ç„¦è™‘', 'ç–²æƒ«', 'å‹åŠ›', 'æ‹…å¿§', 'æœŸå¾…', 'ç´§å¼ ']
          const selectedEmotions = emotions.slice(0, Math.floor(Math.random() * 3) + 1)
          
          resolve({
            message_id: Date.now(),
            emotion_report: {
              stress_index: stressIndex,
              main_emotions: selectedEmotions,
              possible_causes: ['å­¦ä¹ å‹åŠ›', 'è€ƒè¯•ç„¦è™‘', 'æ—¶é—´ç®¡ç†'],
              risk_level: stressIndex > 70 ? 'red' : (stressIndex > 40 ? 'yellow' : 'green')
            },
            ai_reply: {
              empathy_text: 'æˆ‘èƒ½æ„Ÿå—åˆ°ä½ ç°åœ¨çš„å¿ƒæƒ…',
              cognitive_guidance: 'è®©æˆ‘ä»¬æ¢ä¸ªè§’åº¦æ¥çœ‹å¾…è¿™ä¸ªé—®é¢˜',
              practical_tips: ['æ·±å‘¼å¸ç»ƒä¹ ', 'é€‚å½“ä¼‘æ¯', 'åˆ¶å®šå°ç›®æ ‡'],
              follow_up_tasks: ['ä»Šå¤©ç»™è‡ªå·±10åˆ†é’Ÿæ”¾æ¾æ—¶é—´', 'å†™ä¸‹ä¸‰ä»¶æ„Ÿæ©çš„äº‹', 'åš5åˆ†é’Ÿå†¥æƒ³'],
              resource_links: stressIndex > 50 ? ['å¿ƒç†å¥åº·çƒ­çº¿', 'å†¥æƒ³æŒ‡å¯¼éŸ³é¢‘'] : []
            },
            ai_reply_text: `äº²çˆ±çš„æœ‹å‹ï¼Œ

æ„Ÿè°¢ä½ ä¸æˆ‘åˆ†äº«ä½ çš„æƒ³æ³•ã€‚æˆ‘èƒ½æ„Ÿå—åˆ°ä½ ç°åœ¨æ‰¿å—ç€ä¸€å®šçš„å‹åŠ›ï¼Œè¿™åœ¨è€ƒç ”è·¯ä¸Šæ˜¯å¾ˆå¸¸è§çš„ã€‚

ğŸ“Š æ ¹æ®åˆ†æï¼Œä½ å½“å‰çš„å‹åŠ›æŒ‡æ•°ä¸º ${stressIndex}ï¼Œä¸»è¦æƒ…ç»ªåŒ…æ‹¬ï¼š${selectedEmotions.join('ã€')}ã€‚

ğŸŒŸ æˆ‘æƒ³å‘Šè¯‰ä½ çš„æ˜¯ï¼š
â€¢ å‹åŠ›æ˜¯æˆé•¿çš„ä¿¡å·ï¼Œè¯´æ˜ä½ åœ¨æŒ‘æˆ˜è‡ªå·±
â€¢ æ¯ä¸ªäººçš„èŠ‚å¥éƒ½ä¸åŒï¼Œç›¸ä¿¡è‡ªå·±çš„æ­¥è°ƒ
â€¢ é€‚å½“çš„ä¼‘æ¯èƒ½è®©ä½ èµ°å¾—æ›´è¿œ

ğŸ’¡ ä»Šå¤©è¯•è¯•è¿™äº›å°æ–¹æ³•ï¼š
â€¢ æ·±å‘¼å¸5åˆ†é’Ÿï¼Œæ„Ÿå—å½“ä¸‹çš„å®é™
â€¢ ç»™è‡ªå·±å‡†å¤‡ä¸€æ¯æ¸©æ°´æˆ–èŒ¶
â€¢ å’Œä¿¡ä»»çš„äººèŠèŠä½ çš„æ„Ÿå—

è®°ä½ï¼Œæˆ‘ä¸€ç›´åœ¨è¿™é‡Œé™ªä¼´ä½ ã€‚ä½ å¹¶ä¸å­¤å•ã€‚

æ¸©æš–çš„AIä¼™ä¼´ ğŸ’–`,
            video_url: null,
            risk_level: stressIndex > 70 ? 'red' : (stressIndex > 40 ? 'yellow' : 'green'),
            crisis_resources: stressIndex > 70 ? {
              level: "high_risk",
              message: "æ£€æµ‹åˆ°æ‚¨å¯èƒ½æ­£åœ¨ç»å†å¿ƒç†å±æœºï¼Œè¯·ç«‹å³å¯»æ±‚å¸®åŠ©ï¼",
              resources: {
                hotlines: [
                  { name: "å…¨å›½å¿ƒç†å±æœºå¹²é¢„çƒ­çº¿", phone: "400-161-9995" },
                  { name: "åŒ—äº¬å±æœºå¹²é¢„çƒ­çº¿", phone: "010-82951332" }
                ]
              }
            } : null
          })
        }, 1500)
      })
    }

    // æ‰“å¼€å›ä¿¡æµ®çª—
    const openReply = () => {
      if (currentReply.value) {
        showReplyModal.value = true
        
        // åˆå§‹åŒ–è¯­éŸ³æœ—è¯»åŠŸèƒ½
        initSpeechSynthesis()
        
        // å»¶è¿Ÿç»˜åˆ¶é›·è¾¾å›¾ï¼Œç¡®ä¿DOMå·²æ¸²æŸ“
        nextTick(() => {
          if (currentReply.value?.emotionReport) {
            drawRadarChart(currentReply.value.emotionReport)
          }
          
          // ç­‰å¾…è¯­éŸ³åˆ—è¡¨åŠ è½½å®Œæˆï¼ˆæŸäº›æµè§ˆå™¨éœ€è¦æ—¶é—´ï¼‰
          setTimeout(() => {
            if (speechSynthesis && speechSynthesis.getVoices().length === 0) {
              speechSynthesis.addEventListener('voiceschanged', () => {
                console.log('è¯­éŸ³åˆ—è¡¨å·²æ›´æ–°')
              }, { once: true })
            }
          }, 100)
        })
      }
    }

    // å…³é—­å›ä¿¡æµ®çª—
    const closeReplyModal = () => {
      // åœæ­¢è¯­éŸ³æœ—è¯»
      stopSpeech()
      showReplyModal.value = false
    }

    // ç»˜åˆ¶æƒ…ç»ªé›·è¾¾å›¾
    const drawRadarChart = (emotionReport) => {
      const canvas = radarChart.value
      if (!canvas) return
      
      const ctx = canvas.getContext('2d')
      const centerX = canvas.width / 2
      const centerY = canvas.height / 2
      const radius = Math.min(centerX, centerY) - 40
      
      // æ¸…ç©ºç”»å¸ƒ
      ctx.clearRect(0, 0, canvas.width, canvas.height)
      
      // æƒ…ç»ªç»´åº¦
      const dimensions = [
        { label: 'å‹åŠ›', value: emotionReport.stress_index || 0, max: 100 },
        { label: 'ç„¦è™‘', value: emotionReport.main_emotions.includes('ç„¦è™‘') ? 80 : 20, max: 100 },
        { label: 'ç–²æƒ«', value: emotionReport.main_emotions.includes('ç–²æƒ«') ? 70 : 15, max: 100 },
        { label: 'ç§¯æ', value: emotionReport.main_emotions.includes('ç§¯æ') ? 70 : 30, max: 100 },
        { label: 'ä¸“æ³¨', value: Math.max(0, 80 - emotionReport.stress_index * 0.5), max: 100 },
        { label: 'ä¿¡å¿ƒ', value: Math.max(20, 90 - emotionReport.stress_index * 0.6), max: 100 }
      ]
      
      const angleStep = (Math.PI * 2) / dimensions.length
      
      // ç»˜åˆ¶èƒŒæ™¯ç½‘æ ¼
      ctx.strokeStyle = 'rgba(139, 111, 71, 0.2)'
      ctx.lineWidth = 1
      
      // ç»˜åˆ¶åŒå¿ƒåœ†
      for (let i = 1; i <= 5; i++) {
        ctx.beginPath()
        ctx.arc(centerX, centerY, (radius * i) / 5, 0, Math.PI * 2)
        ctx.stroke()
      }
      
      // ç»˜åˆ¶åæ ‡è½´
      dimensions.forEach((_, index) => {
        const angle = index * angleStep - Math.PI / 2
        const x = centerX + Math.cos(angle) * radius
        const y = centerY + Math.sin(angle) * radius
        
        ctx.beginPath()
        ctx.moveTo(centerX, centerY)
        ctx.lineTo(x, y)
        ctx.stroke()
      })
      
      // ç»˜åˆ¶æ•°æ®åŒºåŸŸ
      ctx.fillStyle = 'rgba(139, 111, 71, 0.2)'
      ctx.strokeStyle = 'rgba(139, 111, 71, 0.8)'
      ctx.lineWidth = 2
      
      ctx.beginPath()
      dimensions.forEach((dim, index) => {
        const angle = index * angleStep - Math.PI / 2
        const value = (dim.value / dim.max) * radius
        const x = centerX + Math.cos(angle) * value
        const y = centerY + Math.sin(angle) * value
        
        if (index === 0) {
          ctx.moveTo(x, y)
        } else {
          ctx.lineTo(x, y)
        }
      })
      ctx.closePath()
      ctx.fill()
      ctx.stroke()
      
      // ç»˜åˆ¶æ•°æ®ç‚¹
      ctx.fillStyle = 'rgba(139, 111, 71, 0.9)'
      dimensions.forEach((dim, index) => {
        const angle = index * angleStep - Math.PI / 2
        const value = (dim.value / dim.max) * radius
        const x = centerX + Math.cos(angle) * value
        const y = centerY + Math.sin(angle) * value
        
        ctx.beginPath()
        ctx.arc(x, y, 4, 0, Math.PI * 2)
        ctx.fill()
      })
      
      // ç»˜åˆ¶æ ‡ç­¾
      ctx.fillStyle = '#5d4e37'
      ctx.font = '12px PingFang SC, sans-serif'
      ctx.textAlign = 'center'
      
      dimensions.forEach((dim, index) => {
        const angle = index * angleStep - Math.PI / 2
        const labelRadius = radius + 20
        const x = centerX + Math.cos(angle) * labelRadius
        const y = centerY + Math.sin(angle) * labelRadius
        
        ctx.fillText(dim.label, x, y + 4)
      })
    }

    // å†å²æ¶ˆæ¯
    const loadMessageHistory = async () => {
      try {
        const token = localStorage.getItem('access_token')
        const response = await fetch('/api/v1/messengers/history', {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        })
        
        if (response.ok) {
          const data = await response.json()
          messageHistory.value = data.messages || []
          return
        }
      } catch (error) {
        console.error('åŠ è½½å†å²æ¶ˆæ¯å¤±è´¥:', error)
      }
      
      // å¦‚æœAPIå¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
      messageHistory.value = [
        {
          id: 1,
          text_content: "ä»Šå¤©å­¦ä¹ å‹åŠ›å¾ˆå¤§ï¼Œæ„Ÿè§‰è®°ä¸ä½çŸ¥è¯†ç‚¹...",
          created_at: new Date(Date.now() - 86400000).toISOString(),
          emotion_report: { main_emotions: ['ç„¦è™‘'], stress_index: 65 },
          risk_level: 'yellow'
        },
        {
          id: 2,
          text_content: "åˆšæ‰çš„å»ºè®®å¾ˆæœ‰ç”¨ï¼Œæ„Ÿè§‰å¥½å¤šäº†",
          created_at: new Date(Date.now() - 172800000).toISOString(),
          emotion_report: { main_emotions: ['ç§¯æ'], stress_index: 35 },
          risk_level: 'green'
        }
      ]
    }

    const viewHistoryMessage = (message) => {
      // æŸ¥çœ‹å†å²æ¶ˆæ¯è¯¦æƒ…
      console.log('æŸ¥çœ‹å†å²æ¶ˆæ¯:', message)
    }

    // å·¥å…·å‡½æ•°
    const formatDate = (dateString) => {
      const date = new Date(dateString)
      return date.toLocaleDateString('zh-CN', {
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      })
    }

    const getEmotionLabel = (emotionReport) => {
      if (!emotionReport || !emotionReport.main_emotions) return 'æ­£å¸¸'
      return emotionReport.main_emotions.join(', ')
    }

    const getWeeklyCount = () => {
      const oneWeekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)
      return messageHistory.value.filter(msg => 
        new Date(msg.created_at) > oneWeekAgo
      ).length
    }

    // è·å–å‹åŠ›ç­‰çº§
    const getStressLevel = (stressIndex) => {
      if (stressIndex <= 30) return 'low'
      if (stressIndex <= 70) return 'medium'
      return 'high'
    }

    // å®Œæˆå¾®ä»»åŠ¡
    const completeTask = (task) => {
      console.log('å®Œæˆä»»åŠ¡:', task)
      // è¿™é‡Œå¯ä»¥æ·»åŠ ä»»åŠ¡å®Œæˆçš„é€»è¾‘ï¼Œæ¯”å¦‚æ›´æ–°çŠ¶æ€ã€æ˜¾ç¤ºå¥–åŠ±ç­‰
      alert(`å¤ªæ£’äº†ï¼ä½ å®Œæˆäº†ä»»åŠ¡ï¼š"${task}"`)
    }

    // æ‰“å¼€èµ„æºé“¾æ¥
    const openResource = (resource) => {
      console.log('æ‰“å¼€èµ„æº:', resource)
      // è¿™é‡Œå¯ä»¥æ·»åŠ æ‰“å¼€å¤–éƒ¨èµ„æºçš„é€»è¾‘
      alert(`å³å°†æ‰“å¼€èµ„æºï¼š"${resource}"`)
    }

    // ç”Ÿå‘½å‘¨æœŸ
    onMounted(() => {
      // åˆå§‹åŒ–å¼•å¯¼
      setTimeout(() => {
        if (showGuidance.value) {
          guidanceText.value = guidanceTexts[Math.floor(Math.random() * guidanceTexts.length)]
        }
      }, 1000)
      
      // ç‚¹å‡»å¤–éƒ¨å…³é—­è¡¨æƒ…é¢æ¿
      document.addEventListener('click', (event) => {
        const emojiDropdown = event.target.closest('.emoji-dropdown')
        if (!emojiDropdown && showEmojiPanel.value) {
          showEmojiPanel.value = false
        }
      })
    })

    return {
      // çŠ¶æ€
      inputText,
      selectedImage,
      isRecording,
      isSending,
      anonymousMode,
      showHistory,
      showGuidance,
      showPrivacyTip,
      currentReply,
      replyOpened,
      showReplyModal,
      messageHistory,
      guidanceText,
      privacyTipText,
      canSend,
      
      // è¯­éŸ³æœ—è¯»çŠ¶æ€
      isSpeaking,
      speechPaused,
      speechButtonTitle,
      
      // å¯Œæ–‡æœ¬ç¼–è¾‘å™¨çŠ¶æ€
      showEmojiPanel,
      currentEmojiCategory,
      textLength,
      currentEmojis,
      
      // åŠ¨ç”»çŠ¶æ€
      showSendAnimation,
      animationStep,
      
      // å¼•ç”¨
      textInput,
      imageInput,
      imageCanvas,
      radarChart,
      teacherVideo,
      
      // çŠ¶æ€
      imageInfo,
      
      // æ–¹æ³•
      goBack,
      hideGuidance,
      toggleAnonymous,
      toggleHistory,
      triggerImageUpload,
      handleImageUpload,
      removeImage,
      startVoiceInput,
      stopVoiceInput,
      
      // å¯Œæ–‡æœ¬ç¼–è¾‘å™¨æ–¹æ³•
      handleRichTextInput,
      formatText,
      insertEmoji,
      toggleEmojiPanel,
      setEmojiCategory,
      
      // è§†é¢‘æ’­æ”¾æ§åˆ¶æ–¹æ³•
      onVideoLoaded,
      onVideoTimeUpdate,
      onVideoEnded,
      
      // è¯­éŸ³æœ—è¯»æ–¹æ³•
      toggleSpeech,
      stopSpeech,
      
      handlePaste,
      handleKeyDown,
      sendMessage,
      onLetterSent,
      openReply,
      closeReplyModal,
      viewHistoryMessage,
      formatDate,
      getEmotionLabel,
      getWeeklyCount,
      getStressLevel,
      completeTask,
      openResource
    }
  }
}
</script>

<style scoped>
/* åŸºç¡€å®¹å™¨å’Œè¯—æ„èƒŒæ™¯ */
.messenger-container {
  min-height: 100vh;
  font-family: 'PingFang SC', sans-serif;
  position: relative;
  overflow-x: hidden;
  background: linear-gradient(135deg, #faf8f3 0%, #f2ead8 30%, #e8dcc0 70%, #ddc9a3 100%);
}

/* è¯—æ„èƒŒæ™¯å±‚ - å¿ƒè¯­ä¿¡ä½¿ä¸»é¢˜ */
.paper-background {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: -1;
  background: 
    /* ä¸»èƒŒæ™¯æ¸å˜ - æ¸©æš–çš„ä¿¡çº¸è‰²è°ƒ */
    linear-gradient(135deg, #faf8f3 0%, #f2ead8 30%, #e8dcc0 70%, #ddc9a3 100%);
  
  /* æ·»åŠ åŠ¨æ€å…‰æ™•æ•ˆæœ */
  &::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: 
      /* æ¸©æŸ”çš„å…‰æ™• */
      radial-gradient(circle at 20% 20%, rgba(255, 245, 225, 0.4) 0%, transparent 40%),
      radial-gradient(circle at 80% 60%, rgba(255, 239, 213, 0.3) 0%, transparent 50%),
      radial-gradient(circle at 40% 80%, rgba(248, 235, 200, 0.3) 0%, transparent 45%);
    animation: gentleGlow 8s ease-in-out infinite alternate;
  }
  
  /* é£˜è½çš„èŠ±ç“£åŠ¨ç”»å±‚ - å·²ç¦ç”¨ï¼Œä½¿ç”¨å®é™…èŠ±ç“£å…ƒç´  */
  /*
  &::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-image: 
      radial-gradient(ellipse 3px 8px at center, rgba(255, 182, 193, 0.6) 0%, transparent 70%),
      radial-gradient(ellipse 2px 6px at center, rgba(255, 192, 203, 0.5) 0%, transparent 70%),
      radial-gradient(ellipse 4px 10px at center, rgba(255, 160, 180, 0.4) 0%, transparent 70%);
    background-position: 
      10% 10%, 30% 20%, 60% 15%,
      80% 30%, 20% 50%, 70% 60%,
      40% 80%, 90% 70%, 15% 85%;
    background-size: 8px 8px, 6px 6px, 10px 10px;
    animation: petalsFall 15s linear infinite;
    pointer-events: none;
  }
  */
}

/* çº¸å¼ è´¨æ„ŸåŠ¨ç”» */
@keyframes paperTexture {
  0% {
    background-position: 0% 0%, 100% 100%, 50% 50%, 0% 0%;
  }
  100% {
    background-position: 100% 100%, 0% 0%, 100% 0%, 0% 0%;
  }
}

/* æ–°çš„èƒŒæ™¯åŠ¨ç”» */
@keyframes gentleGlow {
  0% {
    opacity: 0.3;
    transform: scale(1);
  }
  100% {
    opacity: 0.6;
    transform: scale(1.1);
  }
}

/* é£˜åŠ¨çš„çœŸå®äº‘æœµæ ·å¼ */
.floating-clouds {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 5;
}

.realistic-cloud {
  position: absolute;
  opacity: 0.7;
}

.cloud-part {
  position: absolute;
  background: linear-gradient(135deg, 
    rgba(255, 255, 255, 0.95) 0%, 
    rgba(248, 252, 255, 0.9) 20%,
    rgba(240, 248, 255, 0.85) 40%,
    rgba(235, 245, 255, 0.8) 60%,
    rgba(230, 242, 255, 0.75) 80%,
    rgba(225, 240, 252, 0.7) 100%);
  border-radius: 50%;
  box-shadow: 
    0 4px 20px rgba(200, 220, 240, 0.4),
    inset 0 2px 8px rgba(180, 200, 220, 0.3),
    0 2px 6px rgba(220, 235, 250, 0.5),
    inset -2px -2px 4px rgba(210, 225, 240, 0.2);
  filter: blur(0.5px);
}

/* äº‘æœµä¸»ä½“éƒ¨åˆ† */
.cloud-main {
  width: 100px;
  height: 60px;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
}

.cloud-small-1 {
  width: 70px;
  height: 45px;
  top: 40%;
  left: 20%;
  transform: translate(-50%, -50%);
}

.cloud-small-2 {
  width: 65px;
  height: 40px;
  top: 60%;
  left: 75%;
  transform: translate(-50%, -50%);
}

.cloud-medium-1 {
  width: 80px;
  height: 50px;
  top: 35%;
  left: 65%;
  transform: translate(-50%, -50%);
}

.cloud-tiny-1 {
  width: 40px;
  height: 25px;
  top: 25%;
  left: 45%;
  transform: translate(-50%, -50%);
}

.cloud-tiny-2 {
  width: 35px;
  height: 22px;
  top: 70%;
  left: 40%;
  transform: translate(-50%, -50%);
}

.cloud-tiny-3 {
  width: 30px;
  height: 18px;
  top: 30%;
  left: 85%;
  transform: translate(-50%, -50%);
}

/* äº‘æœµé£˜åŠ¨åŠ¨ç”» */
.cloud-drift-1 {
  top: 15%;
  left: -200px;
  width: 180px;
  height: 100px;
  animation: cloudDrift1 20s linear infinite;
}

.cloud-drift-2 {
  top: 35%;
  left: -180px;
  width: 160px;
  height: 90px;
  animation: cloudDrift2 25s linear infinite 3s;
}

.cloud-drift-3 {
  top: 60%;
  left: -150px;
  width: 140px;
  height: 80px;
  animation: cloudDrift3 18s linear infinite 8s;
}

.cloud-drift-4 {
  top: 25%;
  left: -200px;
  width: 200px;
  height: 110px;
  animation: cloudDrift4 30s linear infinite 12s;
}

.cloud-drift-5 {
  top: 50%;
  left: -170px;
  width: 150px;
  height: 85px;
  animation: cloudDrift5 35s linear infinite 20s;
}

.cloud-drift-6 {
  top: 8%;
  left: -190px;
  width: 220px;
  height: 120px;
  animation: cloudDrift6 28s linear infinite 25s;
}

.cloud-drift-7 {
  top: 75%;
  left: -160px;
  width: 130px;
  height: 75px;
  animation: cloudDrift7 22s linear infinite 35s;
}

@keyframes cloudDrift1 {
  0% {
    transform: translateX(0) translateY(0);
    opacity: 0;
  }
  5% {
    opacity: 0.4;
  }
  95% {
    opacity: 0.4;
  }
  100% {
    transform: translateX(calc(100vw + 200px)) translateY(-10px);
    opacity: 0;
  }
}

@keyframes cloudDrift2 {
  0% {
    transform: translateX(0) translateY(0);
    opacity: 0;
  }
  5% {
    opacity: 0.5;
  }
  95% {
    opacity: 0.5;
  }
  100% {
    transform: translateX(calc(100vw + 180px)) translateY(15px);
    opacity: 0;
  }
}

@keyframes cloudDrift3 {
  0% {
    transform: translateX(0) translateY(0);
    opacity: 0;
  }
  5% {
    opacity: 0.3;
  }
  95% {
    opacity: 0.3;
  }
  100% {
    transform: translateX(calc(100vw + 150px)) translateY(-5px);
    opacity: 0;
  }
}

@keyframes cloudDrift4 {
  0% {
    transform: translateX(0) translateY(0);
    opacity: 0;
  }
  5% {
    opacity: 0.6;
  }
  95% {
    opacity: 0.6;
  }
  100% {
    transform: translateX(calc(100vw + 200px)) translateY(8px);
    opacity: 0;
  }
}

@keyframes cloudDrift5 {
  0% {
    transform: translateX(0) translateY(0);
    opacity: 0;
  }
  4% {
    opacity: 0.5;
  }
  96% {
    opacity: 0.5;
  }
  100% {
    transform: translateX(calc(100vw + 170px)) translateY(-12px);
    opacity: 0;
  }
}

@keyframes cloudDrift6 {
  0% {
    transform: translateX(0) translateY(0);
    opacity: 0;
  }
  6% {
    opacity: 0.7;
  }
  94% {
    opacity: 0.7;
  }
  100% {
    transform: translateX(calc(100vw + 190px)) translateY(6px);
    opacity: 0;
  }
}

@keyframes cloudDrift7 {
  0% {
    transform: translateX(0) translateY(0);
    opacity: 0;
  }
  5% {
    opacity: 0.4;
  }
  95% {
    opacity: 0.4;
  }
  100% {
    transform: translateX(calc(100vw + 160px)) translateY(-8px);
    opacity: 0;
  }
}

@keyframes petalsFall {
  0% {
    transform: translateY(-100vh) rotate(0deg);
    opacity: 0;
  }
  10% {
    opacity: 1;
  }
  90% {
    opacity: 1;
  }
  100% {
    transform: translateY(100vh) rotate(360deg);
    opacity: 0;
  }
}

/* é£˜è½èŠ±ç“£æ ·å¼ */
.floating-petals {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  overflow: hidden;
  z-index: 3;
}

/* èƒŒæ™¯è£…é¥°æ•ˆæœå±‚ */
.background-decorations {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 1;
}

.petal {
  position: absolute;
  top: -200px;
  opacity: 0;
  animation: floatDown linear infinite;
}

/* çœŸå®èŠ±ç“£å½¢çŠ¶ */
.petal-shape {
  width: 12px;
  height: 20px;
  position: relative;
}

/* æ¨±èŠ±èŠ±ç“£ */
.petal-sakura {
  background: linear-gradient(45deg, 
    rgba(255, 182, 193, 0.9) 0%,
    rgba(255, 192, 203, 0.8) 50%,
    rgba(255, 160, 180, 0.7) 100%);
  border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
  box-shadow: 
    0 2px 4px rgba(255, 160, 180, 0.3),
    inset 0 1px 2px rgba(255, 220, 225, 0.6);
  transform: rotate(-15deg);
}

.petal-sakura::before {
  content: '';
  position: absolute;
  width: 6px;
  height: 12px;
  background: linear-gradient(to bottom,
    rgba(255, 160, 180, 0.4) 0%,
    transparent 100%);
  left: 3px;
  top: 2px;
  border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
}

/* ç«ç‘°èŠ±ç“£ */
.petal-rose {
  background: linear-gradient(45deg, 
    rgba(255, 105, 135, 0.9) 0%,
    rgba(255, 20, 85, 0.8) 50%,
    rgba(220, 20, 70, 0.7) 100%);
  border-radius: 40% 60% 60% 40% / 50% 50% 50% 50%;
  box-shadow: 
    0 2px 4px rgba(220, 20, 70, 0.3),
    inset 0 1px 2px rgba(255, 180, 195, 0.6);
  transform: rotate(10deg);
}

.petal-rose::before {
  content: '';
  position: absolute;
  width: 5px;
  height: 10px;
  background: linear-gradient(to bottom,
    rgba(255, 180, 195, 0.5) 0%,
    transparent 100%);
  left: 4px;
  top: 3px;
  border-radius: 40% 60% 60% 40% / 50% 50% 50% 50%;
}

/* æ¢…èŠ±èŠ±ç“£ */
.petal-plum {
  background: linear-gradient(45deg, 
    rgba(255, 245, 250, 0.95) 0%,
    rgba(255, 228, 238, 0.9) 50%,
    rgba(255, 200, 220, 0.8) 100%);
  border-radius: 50% 50% 50% 50% / 70% 70% 30% 30%;
  box-shadow: 
    0 2px 4px rgba(255, 200, 220, 0.3),
    inset 0 1px 2px rgba(255, 245, 250, 0.8);
  transform: rotate(25deg);
}

.petal-plum::before {
  content: '';
  position: absolute;
  width: 4px;
  height: 8px;
  background: linear-gradient(to bottom,
    rgba(255, 200, 220, 0.4) 0%,
    transparent 100%);
  left: 4px;
  top: 4px;
  border-radius: 50% 50% 50% 50% / 70% 70% 30% 30%;
}

.petal-1 {
  left: 10%;
  animation-duration: 12s;
  animation-delay: 0s;
}

.petal-2 {
  left: 25%;
  animation-duration: 15s;
  animation-delay: 1s;
}

.petal-3 {
  left: 40%;
  animation-duration: 13s;
  animation-delay: 2s;
}

.petal-4 {
  left: 60%;
  animation-duration: 14s;
  animation-delay: 0.5s;
}

.petal-5 {
  left: 75%;
  animation-duration: 16s;
  animation-delay: 1.5s;
}

.petal-6 {
  left: 90%;
  animation-duration: 11s;
  animation-delay: 2.5s;
}

.petal-7 {
  left: 5%;
  animation-duration: 17s;
  animation-delay: 4s;
}

.petal-8 {
  left: 95%;
  animation-duration: 14s;
  animation-delay: 12s;
}

.petal-9 {
  left: 15%;
  animation-duration: 18s;
  animation-delay: 6s;
}

.petal-10 {
  left: 35%;
  animation-duration: 13s;
  animation-delay: 15s;
}

.petal-11 {
  left: 55%;
  animation-duration: 16s;
  animation-delay: 9s;
}

.petal-12 {
  left: 78%;
  animation-duration: 12s;
  animation-delay: 18s;
}

.petal-13 {
  left: 8%;
  animation-duration: 20s;
  animation-delay: 3s;
}

.petal-14 {
  left: 65%;
  animation-duration: 15s;
  animation-delay: 21s;
}

.petal-15 {
  left: 88%;
  animation-duration: 17s;
  animation-delay: 7s;
}

@keyframes floatDown {
  0% {
    transform: translateY(0px) rotate(0deg);
    opacity: 0;
  }
  3% {
    opacity: 0.8;
  }
  97% {
    opacity: 0.6;
  }
  100% {
    transform: translateY(calc(100vh + 300px)) rotate(360deg);
    opacity: 0;
  }
}

/* å¤é£äº‘çº¹è£…é¥° */
.cloud-patterns {
  position: absolute;
  width: 100%;
  height: 100%;
  pointer-events: none;
}

.cloud-pattern {
  position: absolute;
  background: radial-gradient(ellipse, rgba(255, 255, 255, 0.2) 0%, transparent 70%);
  border-radius: 50%;
  animation: cloudFloat 20s ease-in-out infinite;
}

.cloud-1 {
  width: 300px;
  height: 150px;
  top: 20%;
  left: 10%;
  animation-delay: 0s;
}

.cloud-2 {
  width: 250px;
  height: 120px;
  top: 60%;
  right: 15%;
  animation-delay: 5s;
}

.cloud-3 {
  width: 200px;
  height: 100px;
  bottom: 30%;
  left: 50%;
  animation-delay: 10s;
}

@keyframes cloudFloat {
  0%, 100% {
    transform: translateX(0) scale(1);
    opacity: 0.1;
  }
  50% {
    transform: translateX(20px) scale(1.1);
    opacity: 0.2;
  }
}

/* é¡µé¢å¤´éƒ¨æ ·å¼ */
.page-header {
  padding: 30px 20px;
  text-align: center;
  position: relative;
  z-index: 10;
}

.back-button {
  position: absolute;
  top: 20px;
  left: 20px;
  background: rgba(255, 255, 255, 0.6);
  backdrop-filter: blur(10px);
  border: 2px solid rgba(255, 255, 255, 0.3);
  border-radius: 50px;
  padding: 12px 20px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 600;
  color: #8b6f47;
  transition: all 0.3s ease;
  box-shadow: 0 4px 20px rgba(139, 111, 71, 0.1);
  z-index: 9999;
}

.back-button:hover {
  background: rgba(255, 255, 255, 0.8);
  transform: translateY(-2px) scale(1.05);
  box-shadow: 0 6px 25px rgba(139, 111, 71, 0.2);
}

.back-icon {
  width: 20px;
  height: 20px;
  stroke-width: 2.5px;
}

.page-title {
  font-size: 2.8em;
  font-weight: 300;
  color: #8b6f47;
  margin: 0 0 15px 0;
  text-shadow: 
    0 2px 4px rgba(139, 111, 71, 0.1),
    0 0 20px rgba(255, 248, 220, 0.3);
  letter-spacing: 3px;
  font-family: 'æ¥·ä½“', 'KaiTi', serif;
  position: relative;
  animation: titleGlow 4s ease-in-out infinite alternate;
}

.page-title::before {
  content: 'ğŸŒ¸';
  position: absolute;
  left: -50px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 0.6em;
  opacity: 0.6;
  animation: petalRotate 6s ease-in-out infinite;
}

.page-title::after {
  content: 'ğŸŒ¸';
  position: absolute;
  right: -50px;
  top: 50%;
  transform: translateY(-50%) scaleX(-1);
  font-size: 0.6em;
  opacity: 0.6;
  animation: petalRotate 6s ease-in-out infinite reverse;
}

@keyframes titleGlow {
  0% {
    text-shadow: 
      0 2px 4px rgba(139, 111, 71, 0.1),
      0 0 20px rgba(255, 248, 220, 0.2);
  }
  100% {
    text-shadow: 
      0 2px 8px rgba(139, 111, 71, 0.2),
      0 0 30px rgba(255, 248, 220, 0.4);
  }
}

@keyframes petalRotate {
  0%, 100% {
    transform: translateY(-50%) rotate(0deg);
  }
  50% {
    transform: translateY(-50%) rotate(15deg);
  }
}

.page-subtitle {
  font-size: 1.2em;
  color: #a0886b;
  margin: 0;
  font-weight: 300;
  opacity: 0.85;
  letter-spacing: 1px;
  position: relative;
  font-style: italic;
  animation: subtitleFloat 3s ease-in-out infinite alternate;
}

.page-subtitle::before {
  content: '';
  position: absolute;
  bottom: -8px;
  left: 50%;
  transform: translateX(-50%);
  width: 120px;
  height: 2px;
  background: linear-gradient(90deg, 
    transparent 0%, 
    rgba(139, 111, 71, 0.3) 20%, 
    rgba(139, 111, 71, 0.6) 50%, 
    rgba(139, 111, 71, 0.3) 80%, 
    transparent 100%);
  border-radius: 1px;
  animation: lineGlow 2s ease-in-out infinite alternate;
}

@keyframes subtitleFloat {
  0% {
    transform: translateY(0);
    opacity: 0.85;
  }
  100% {
    transform: translateY(-3px);
    opacity: 0.95;
  }
}

@keyframes lineGlow {
  0% {
    opacity: 0.3;
    width: 120px;
  }
  100% {
    opacity: 0.7;
    width: 140px;
  }
}

/* ä¸»è¦å†…å®¹åŒºåŸŸ */
.main-content {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 20px 40px;
  position: relative;
  z-index: 5;
}

/* å“åº”å¼å¸ƒå±€ */
@media (min-width: 768px) {
  .main-content {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 40px;
    align-items: start;
  }

  .page-header {
    grid-column: 1 / -1;
  }

  .input-section {
    order: 1;
  }

  .reply-area {
    order: 2;
  }

  .messages-history {
    order: 3;
    grid-column: 2;
  }
}

@media (max-width: 767px) {
  .main-content {
    display: flex;
    flex-direction: column;
    gap: 30px;
  }

  .page-title {
    font-size: 2em;
  }

  .back-button {
    position: relative;
    top: auto;
    left: auto;
    margin-bottom: 20px;
    align-self: flex-start;
  }
}

/* æ°”æ³¡æ•ˆæœæ ·å¼ */
.glass-bubble {
  background: rgba(255, 255, 255, 0.6);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 999px;
  transition: all 0.3s ease;
  box-shadow: 
    0 4px 20px rgba(139, 111, 71, 0.1),
    inset 0 1px 0 rgba(255, 255, 255, 0.5);
}

.glass-bubble:hover {
  transform: scale(1.05);
  background: rgba(255, 255, 255, 0.75);
  box-shadow: 
    0 6px 30px rgba(139, 111, 71, 0.15),
    inset 0 1px 0 rgba(255, 255, 255, 0.7);
}

/* è¾“å…¥åŒºåŸŸ - ä¿¡çº¸æ ·å¼ */
.input-section {
  position: relative;
}

.letter-paper-input {
  background: 
    /* ä¿¡çº¸çº¿æ¡ */
    repeating-linear-gradient(
      transparent,
      transparent 24px,
      rgba(139, 111, 71, 0.1) 25px,
      rgba(139, 111, 71, 0.1) 26px
    ),
    /* å·¦ä¾§çº¢çº¿ */
    linear-gradient(
      90deg,
      transparent 0px,
      transparent 45px,
      rgba(220, 53, 69, 0.3) 46px,
      rgba(220, 53, 69, 0.3) 48px,
      transparent 49px
    ),
    /* ä¿¡çº¸èƒŒæ™¯ */
    linear-gradient(135deg, #fefcf8 0%, #f8f5f0 100%);
  
  border: 2px solid rgba(139, 111, 71, 0.2);
  border-radius: 15px;
  padding: 40px 30px 30px 60px;
  box-shadow: 
    0 10px 40px rgba(139, 111, 71, 0.1),
    inset 0 1px 0 rgba(255, 255, 255, 0.8);
  position: relative;
  overflow: hidden;
}

/* è¾“å…¥åŒºåŸŸ - ä¿¡çº¸æ ·å¼ */
.input-section {
  position: relative;
}

.letter-paper-input {
  background: 
    /* ä¿¡çº¸çº¿æ¡ */
    repeating-linear-gradient(
      transparent,
      transparent 24px,
      rgba(139, 111, 71, 0.1) 25px,
      rgba(139, 111, 71, 0.1) 26px
    ),
    /* å·¦ä¾§çº¢çº¿ */
    linear-gradient(
      90deg,
      transparent 0px,
      transparent 45px,
      rgba(220, 53, 69, 0.3) 46px,
      rgba(220, 53, 69, 0.3) 48px,
      transparent 49px
    ),
    /* ä¿¡çº¸èƒŒæ™¯ */
    linear-gradient(135deg, #fefcf8 0%, #f8f5f0 100%);
  
  border: 2px solid rgba(139, 111, 71, 0.2);
  border-radius: 15px;
  padding: 40px 30px 30px 60px;
  box-shadow: 
    0 10px 40px rgba(139, 111, 71, 0.1),
    inset 0 1px 0 rgba(255, 255, 255, 0.8);
  position: relative;
  overflow: hidden;
}

.letter-paper-input::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 30px;
  background: 
    repeating-linear-gradient(
      90deg,
      transparent,
      transparent 19px,
      rgba(139, 111, 71, 0.15) 20px,
      rgba(139, 111, 71, 0.15) 21px
    );
}

/* æ–‡å­—è¾“å…¥åŒºåŸŸ */
.text-input-area {
  margin-bottom: 20px;
}

.rich-text-toolbar {
  display: flex;
  gap: 8px;
  margin-bottom: 10px;
  padding: 10px;
  background: rgba(139, 111, 71, 0.05);
  border-radius: 8px;
  border: 1px solid rgba(139, 111, 71, 0.1);
  align-items: center;
}

.format-btn {
  background: rgba(255, 255, 255, 0.8);
  border: 1px solid rgba(139, 111, 71, 0.2);
  border-radius: 6px;
  width: 32px;
  height: 32px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  font-weight: 600;
  color: #8b6f47;
  transition: all 0.2s ease;
}

.format-btn:hover {
  background: rgba(139, 111, 71, 0.1);
  transform: scale(1.05);
}

.format-btn:active {
  background: rgba(139, 111, 71, 0.2);
}

/* è¡¨æƒ…ä¸‹æ‹‰é¢æ¿ */
.emoji-dropdown {
  position: relative;
}

.emoji-panel {
  position: absolute;
  top: 100%;
  left: 0;
  background: white;
  border: 1px solid rgba(139, 111, 71, 0.2);
  border-radius: 12px;
  box-shadow: 0 8px 24px rgba(139, 111, 71, 0.15);
  z-index: 1000;
  min-width: 280px;
  max-height: 320px;
  overflow: hidden;
}

.emoji-categories {
  display: flex;
  background: rgba(139, 111, 71, 0.05);
  padding: 8px;
  border-bottom: 1px solid rgba(139, 111, 71, 0.1);
}

.emoji-cat-btn {
  background: transparent;
  border: none;
  padding: 8px 12px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 16px;
  transition: all 0.2s ease;
}

.emoji-cat-btn:hover {
  background: rgba(139, 111, 71, 0.1);
}

.emoji-cat-btn.active {
  background: rgba(139, 111, 71, 0.15);
  color: #8b6f47;
}

.emoji-grid {
  display: grid;
  grid-template-columns: repeat(8, 1fr);
  gap: 4px;
  padding: 12px;
  max-height: 240px;
  overflow-y: auto;
}

.emoji-btn {
  background: transparent;
  border: none;
  padding: 8px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 18px;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
}

.emoji-btn:hover {
  background: rgba(139, 111, 71, 0.1);
  transform: scale(1.1);
}

.text-input {
  width: 100%;
  min-height: 120px;
  max-height: 200px;
  padding: 15px 0;
  border: none;
  background: transparent;
  font-family: 'PingFang SC', sans-serif;
  font-size: 16px;
  line-height: 26px;
  color: #5d4e37;
  resize: none;
  outline: none;
}

.rich-text-input {
  border: 1px solid rgba(139, 111, 71, 0.1);
  border-radius: 8px;
  padding: 15px;
  background: rgba(255, 255, 255, 0.5);
  min-height: 120px;
  max-height: 200px;
  overflow-y: auto;
  font-family: 'PingFang SC', sans-serif;
  font-size: 16px;
  line-height: 26px;
  color: #5d4e37;
  outline: none;
  text-align: left !important;
  word-wrap: break-word;
  white-space: pre-wrap;
  direction: ltr;
}

.rich-text-input * {
  text-align: left !important;
}

.rich-text-input[contenteditable]:empty::before {
  content: attr(data-placeholder);
  color: rgba(93, 78, 55, 0.5);
  pointer-events: none;
  text-align: left;
  display: block;
}

.rich-text-input:focus {
  border-color: rgba(139, 111, 71, 0.3);
  box-shadow: 0 0 0 2px rgba(139, 111, 71, 0.1);
}

.char-count {
  text-align: right;
  font-size: 12px;
  color: #a0886b;
  margin-top: 5px;
}

.text-input::placeholder {
  color: rgba(139, 111, 71, 0.5);
  font-style: italic;
}

/* å¤šåª’ä½“è¾“å…¥åŒºåŸŸ */
.media-input-area {
  margin-bottom: 25px;
  min-height: 60px;
}

.image-preview {
  position: relative;
  display: inline-block;
  margin-bottom: 15px;
  background: rgba(255, 255, 255, 0.9);
  border-radius: 10px;
  padding: 10px;
  box-shadow: 0 4px 15px rgba(139, 111, 71, 0.2);
}

.preview-canvas {
  display: block;
  border-radius: 8px;
  margin-bottom: 8px;
}

.image-info {
  display: flex;
  gap: 10px;
  font-size: 12px;
  color: #a0886b;
}

.image-size,
.image-type {
  background: rgba(139, 111, 71, 0.1);
  padding: 2px 8px;
  border-radius: 10px;
}

.remove-media {
  position: absolute;
  top: -8px;
  right: -8px;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  border: none;
  background: rgba(220, 53, 69, 0.9);
  color: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  line-height: 1;
  transition: all 0.2s ease;
}

.remove-media:hover {
  background: rgba(220, 53, 69, 1);
  transform: scale(1.1);
}

/* è¯­éŸ³å½•åˆ¶æ ·å¼ */
.voice-recording {
  text-align: center;
  padding: 20px;
  background: rgba(139, 111, 71, 0.05);
  border-radius: 15px;
  border: 2px dashed rgba(139, 111, 71, 0.3);
}

.recording-animation {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 15px;
  margin-bottom: 10px;
}

.pulse {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  background: #dc3545;
  animation: pulse 1.5s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% {
    opacity: 1;
    transform: scale(1);
  }
  50% {
    opacity: 0.3;
    transform: scale(1.5);
  }
}

.mic-icon {
  width: 24px;
  height: 24px;
  color: #dc3545;
}

.stop-recording {
  background: #dc3545;
  color: white;
  border: none;
  border-radius: 25px;
  padding: 8px 20px;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.2s ease;
}

.stop-recording:hover {
  background: #c82333;
  transform: scale(1.05);
}

/* æ§åˆ¶æŒ‰é’®åŒºåŸŸ */
.control-buttons {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 15px;
  margin-top: 20px;
}

.input-buttons {
  display: flex;
  gap: 10px;
}

.input-btn {
  width: 45px;
  height: 45px;
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #8b6f47;
  transition: all 0.3s ease;
}

.input-btn svg {
  width: 20px;
  height: 20px;
}

.input-btn:hover {
  color: #5d4e37;
}

.input-btn.active {
  background: rgba(139, 111, 71, 0.2);
  color: #5d4e37;
}

/* å‘é€æŒ‰é’® */
.send-button {
  background: linear-gradient(135deg, #8b6f47 0%, #a0886b 100%);
  color: white;
  border: none;
  border-radius: 50px;
  padding: 12px 30px;
  cursor: pointer;
  font-size: 16px;
  font-weight: 600;
  transition: all 0.3s ease;
  box-shadow: 0 4px 20px rgba(139, 111, 71, 0.3);
  position: relative;
  overflow: hidden;
}

.send-button:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 6px 25px rgba(139, 111, 71, 0.4);
}

.send-button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.send-button.sending {
  background: linear-gradient(135deg, #6c5433 0%, #8b6f47 100%);
}

/* å‘é€åŠ¨ç”» */
.flying-pigeon {
  animation: fly 2s ease-in-out infinite;
}

@keyframes fly {
  0%, 100% {
    transform: translateX(0) translateY(0);
  }
  25% {
    transform: translateX(5px) translateY(-3px);
  }
  50% {
    transform: translateX(10px) translateY(0);
  }
  75% {
    transform: translateX(5px) translateY(3px);
  }
}

/* æ§åˆ¶æŒ‰é’®åŒºåŸŸ */
.control-buttons {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 15px;
  margin-top: 20px;
}

.input-buttons {
  display: flex;
  gap: 10px;
}

.input-btn {
  width: 45px;
  height: 45px;
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #8b6f47;
  transition: all 0.3s ease;
}

.input-btn svg {
  width: 20px;
  height: 20px;
}

.input-btn:hover {
  color: #5d4e37;
}

.input-btn.active {
  background: rgba(139, 111, 71, 0.2);
  color: #5d4e37;
}

/* å‘é€æŒ‰é’® */
.send-button {
  background: linear-gradient(135deg, #8b6f47 0%, #a0886b 100%);
  color: white;
  border: none;
  border-radius: 50px;
  padding: 12px 30px;
  cursor: pointer;
  font-size: 16px;
  font-weight: 600;
  transition: all 0.3s ease;
  box-shadow: 0 4px 20px rgba(139, 111, 71, 0.3);
  position: relative;
  overflow: hidden;
}

.send-button:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 6px 25px rgba(139, 111, 71, 0.4);
}

.send-button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.send-button.sending {
  background: linear-gradient(135deg, #6c5433 0%, #8b6f47 100%);
}

/* ä¿¡ä»¶å‘é€åŠ¨ç”» */
.letter-send-transition {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 1000;
  pointer-events: none;
}

/* ä¿¡ä»¶å‘é€åŠ¨ç”» */
.letter-send-transition {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 1000;
  pointer-events: none;
}

.envelope-animation {
  position: relative;
  width: 120px;
  height: 80px;
  transform-origin: center center;
  opacity: 0;
  will-change: transform, opacity, filter;
  backface-visibility: hidden;
  transform: translateZ(0);
}

.envelope-animation.appearing {
  animation: envelopeAppear 2s ease-out forwards;
}

.envelope-animation.flying {
  animation: envelopeFlySmooth 2.8s linear forwards;
  animation-fill-mode: both;
}

.envelope-image {
  width: 100%;
  height: 100%;
  object-fit: contain;
  filter: drop-shadow(0 5px 15px rgba(139, 111, 71, 0.3));
}

.envelope-glow {
  position: absolute;
  top: -10px;
  left: -10px;
  right: -10px;
  bottom: -10px;
  background: radial-gradient(circle, rgba(255, 248, 220, 0.6) 0%, transparent 70%);
  border-radius: 10px;
  z-index: -1;
}

.envelope-animation.appearing .envelope-glow {
  animation: glowPulse 1.5s ease-in-out infinite alternate;
}

.envelope-animation.flying .envelope-glow {
  animation: glowFadeOut 2.5s ease-out forwards;
}

/* ä¿¡å°å‡ºç°åŠ¨ç”» */
@keyframes envelopeAppear {
  0% {
    opacity: 0;
    transform: scale(0.3) rotateY(-180deg);
  }
  50% {
    opacity: 1;
    transform: scale(1.1) rotateY(0deg);
  }
  100% {
    opacity: 1;
    transform: scale(1) rotateY(0deg) translateX(0px) translateY(0px) rotateZ(0deg);
  }
}

/* è¶…çº§ä¸æ»‘çš„ä¿¡å°é£è¡ŒåŠ¨ç”» - ä»appearingçš„ç»“æŸçŠ¶æ€å¼€å§‹ */
@keyframes envelopeFlySmooth {
  0% {
    opacity: 1;
    transform: scale(1) translateX(0px) translateY(0px) rotateZ(0deg);
    filter: drop-shadow(0 5px 15px rgba(139, 111, 71, 0.3));
  }
  5% {
    opacity: 1;
    transform: scale(1.02) translateX(15px) translateY(-5px) rotateZ(1deg);
    filter: drop-shadow(0 6px 16px rgba(139, 111, 71, 0.28));
  }
  12% {
    opacity: 1;
    transform: scale(1.08) translateX(40px) translateY(-12px) rotateZ(4deg);
    filter: drop-shadow(0 7px 18px rgba(139, 111, 71, 0.25));
  }
  20% {
    opacity: 0.98;
    transform: scale(1.15) translateX(80px) translateY(-20px) rotateZ(7deg);
    filter: drop-shadow(0 8px 20px rgba(139, 111, 71, 0.22));
  }
  30% {
    opacity: 0.94;
    transform: scale(1.25) translateX(140px) translateY(-30px) rotateZ(10deg);
    filter: drop-shadow(0 10px 24px rgba(139, 111, 71, 0.18));
  }
  42% {
    opacity: 0.88;
    transform: scale(1.35) translateX(220px) translateY(-38px) rotateZ(13deg);
    filter: drop-shadow(0 12px 28px rgba(139, 111, 71, 0.15));
  }
  55% {
    opacity: 0.8;
    transform: scale(1.48) translateX(320px) translateY(-46px) rotateZ(16deg);
    filter: drop-shadow(0 14px 32px rgba(139, 111, 71, 0.12));
  }
  68% {
    opacity: 0.68;
    transform: scale(1.62) translateX(440px) translateY(-54px) rotateZ(19deg);
    filter: drop-shadow(0 16px 36px rgba(139, 111, 71, 0.09));
  }
  78% {
    opacity: 0.52;
    transform: scale(1.78) translateX(580px) translateY(-62px) rotateZ(22deg);
    filter: drop-shadow(0 18px 40px rgba(139, 111, 71, 0.06));
  }
  87% {
    opacity: 0.35;
    transform: scale(1.95) translateX(740px) translateY(-70px) rotateZ(25deg);
    filter: drop-shadow(0 20px 44px rgba(139, 111, 71, 0.04));
  }
  94% {
    opacity: 0.18;
    transform: scale(2.15) translateX(920px) translateY(-78px) rotateZ(28deg);
    filter: drop-shadow(0 22px 48px rgba(139, 111, 71, 0.02));
  }
  98% {
    opacity: 0.08;
    transform: scale(2.35) translateX(1080px) translateY(-84px) rotateZ(29deg);
    filter: drop-shadow(0 24px 52px rgba(139, 111, 71, 0.01));
  }
  100% {
    opacity: 0;
    transform: scale(2.5) translateX(1200px) translateY(-88px) rotateZ(30deg);
    filter: drop-shadow(0 25px 55px rgba(139, 111, 71, 0));
  }
}

/* å…‰æ™•è„‰å†²åŠ¨ç”» */
@keyframes glowPulse {
  0% {
    opacity: 0.3;
    transform: scale(1);
  }
  100% {
    opacity: 0.6;
    transform: scale(1.1);
  }
}

/* å…‰æ™•æ·¡å‡ºåŠ¨ç”» */
@keyframes glowFadeOut {
  0% {
    opacity: 0.6;
    transform: scale(1.1);
  }
  50% {
    opacity: 0.4;
    transform: scale(1.3);
  }
  100% {
    opacity: 0;
    transform: scale(2);
  }
}

/* ä¿¡ä»¶å†…å®¹é¢„è§ˆ */
.letter-content-preview {
  padding: 15px;
  font-size: 12px;
  color: #8b6f47;
  line-height: 1.4;
  font-family: 'PingFang SC', sans-serif;
}

/* æŠ˜å çŠ¶æ€ */
.letter-paper-flying.folding {
  animation: letterFold 1s ease-in-out forwards;
}

/* é£è¡ŒçŠ¶æ€ */
.pigeon-flying {
  animation: pigeonFly 1.5s ease-out forwards;
}

/* Vueè¿‡æ¸¡æ•ˆæœ */
.letter-send-enter-active {
  transition: all 0.3s ease;
}

.letter-send-leave-active {
  transition: all 0.3s ease;
}

.letter-send-enter-from {
  opacity: 0;
  transform: translate(-50%, -50%) scale(0.8);
}

.letter-send-leave-to {
  opacity: 0;
}

/* å›ä¿¡é£˜å…¥åŠ¨ç”» */
.letter-arrive-enter-active {
  animation: letterArrive 2s ease-in-out;
}

@keyframes letterArrive {
  0% {
    transform: translateX(100vw) scale(0.5) rotate(10deg);
    opacity: 0;
  }
  30% {
    transform: translateX(50vw) scale(0.7) rotate(5deg);
    opacity: 0.5;
  }
  60% {
    transform: translateX(20vw) scale(0.9) rotate(2deg);
    opacity: 0.8;
  }
  100% {
    transform: translateX(0) scale(1) rotate(0deg);
    opacity: 1;
  }
}

/* ä¿¡å°æ ·å¼ */
.letter-envelope {
  max-width: 400px;
  margin: 20px auto;
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
}

.letter-envelope:hover {
  transform: scale(1.02);
}

.envelope-front {
  background: linear-gradient(135deg, #f8f5f0 0%, #f0e6d2 100%);
  border: 2px solid rgba(139, 111, 71, 0.3);
  border-radius: 15px;
  padding: 25px;
  box-shadow: 0 8px 30px rgba(139, 111, 71, 0.2);
  position: relative;
  text-align: center;
}

.envelope-front::before {
  content: '';
  position: absolute;
  top: 15px;
  left: 15px;
  right: 15px;
  height: 40px;
  background: 
    linear-gradient(135deg, 
      rgba(220, 53, 69, 0.1) 0%, 
      rgba(220, 53, 69, 0.05) 50%, 
      transparent 100%);
  border-radius: 8px;
}

.envelope-seal {
  width: 40px;
  height: 40px;
  background: radial-gradient(circle, #dc3545 0%, #c82333 100%);
  border-radius: 50%;
  margin: 0 auto 15px;
  position: relative;
  box-shadow: 0 3px 10px rgba(220, 53, 69, 0.3);
}

.envelope-seal::after {
  content: 'â™¡';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: white;
  font-size: 18px;
}

.envelope-text {
  color: #8b6f47;
  font-size: 16px;
  font-weight: 500;
  margin: 0;
  font-family: 'PingFang SC', sans-serif;
}

/* ä¿¡å°æ‰“å¼€åŠ¨ç”» */
.letter-envelope.opened .envelope-front {
  animation: envelopeOpen 0.8s ease-out forwards;
}

@keyframes envelopeOpen {
  0% {
    transform: scale(1) rotateY(0deg);
  }
  50% {
    transform: scale(1.05) rotateY(-10deg);
  }
  100% {
    transform: scale(1.1) rotateY(-20deg);
    opacity: 0.8;
  }
}

/* ä¿¡çº¸å†…å®¹å±•å¼€ */
.letter-content {
  margin-top: 20px;
  animation: contentUnfold 1s ease-out forwards;
}

@keyframes contentUnfold {
  0% {
    opacity: 0;
    transform: scale(0.8) rotateX(-10deg);
    max-height: 0;
  }
  50% {
    opacity: 0.5;
    transform: scale(0.9) rotateX(-5deg);
  }
  100% {
    opacity: 1;
    transform: scale(1) rotateX(0deg);
    max-height: 1000px;
  }
}

.letter-paper {
  background: linear-gradient(135deg, #fefcf8 0%, #f8f5f0 100%);
  border: 2px solid rgba(139, 111, 71, 0.2);
  border-radius: 15px;
  padding: 30px;
  box-shadow: 
    0 10px 40px rgba(139, 111, 71, 0.15),
    inset 0 1px 0 rgba(255, 255, 255, 0.9);
  position: relative;
}

.letter-paper::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: 
    repeating-linear-gradient(
      transparent,
      transparent 22px,
      rgba(139, 111, 71, 0.1) 23px,
      rgba(139, 111, 71, 0.1) 24px
    );
  pointer-events: none;
}

.letter-text {
  font-family: 'PingFang SC', sans-serif;
  font-size: 16px;
  line-height: 1.8;
  color: #5d4e37;
  white-space: pre-line;
  position: relative;
  z-index: 1;
}

.reply-video {
  width: 100%;
  max-width: 400px;
  margin-top: 20px;
  border-radius: 10px;
  box-shadow: 0 5px 20px rgba(139, 111, 71, 0.2);
}

/* å†å²ä¿¡ä»¶åº“æ ·å¼ */
.messages-history {
  position: fixed;
  top: 0;
  right: 0;
  width: 400px;
  height: 100vh;
  z-index: 100;
  padding: 20px;
  background: rgba(0, 0, 0, 0.1);
  backdrop-filter: blur(5px);
}

.history-bubble {
  height: 100%;
  padding: 25px;
  border-radius: 20px;
  display: flex;
  flex-direction: column;
  background: rgba(255, 255, 255, 0.9);
}

.history-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.history-header h3 {
  margin: 0;
  color: #8b6f47;
  font-size: 18px;
  font-weight: 600;
}

.close-history {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: #a0886b;
  width: 30px;
  height: 30px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
}

.close-history:hover {
  background: rgba(139, 111, 71, 0.1);
  color: #8b6f47;
}

.history-stats {
  display: flex;
  gap: 20px;
  margin-bottom: 20px;
  padding: 15px;
  background: rgba(139, 111, 71, 0.05);
  border-radius: 10px;
}

.stat-item {
  display: flex;
  flex-direction: column;
  align-items: center;
}

.stat-label {
  font-size: 12px;
  color: #a0886b;
  margin-bottom: 5px;
}

.stat-value {
  font-size: 20px;
  font-weight: 600;
  color: #8b6f47;
}

.history-list {
  flex: 1;
  overflow-y: auto;
  padding-right: 10px;
}

.history-item {
  background: rgba(255, 255, 255, 0.7);
  border: 1px solid rgba(139, 111, 71, 0.2);
  border-radius: 12px;
  padding: 15px;
  margin-bottom: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
}

.history-item:hover {
  transform: translateX(-5px);
  box-shadow: 0 5px 20px rgba(139, 111, 71, 0.2);
  background: rgba(255, 255, 255, 0.9);
}

.history-item.risk-yellow {
  border-left: 4px solid #ffc107;
}

.history-item.risk-red {
  border-left: 4px solid #dc3545;
  box-shadow: 0 0 10px rgba(220, 53, 69, 0.1);
}

.history-date {
  font-size: 12px;
  color: #a0886b;
  margin-bottom: 8px;
}

.history-preview {
  font-size: 14px;
  color: #5d4e37;
  line-height: 1.4;
  margin-bottom: 10px;
}

.history-emotion {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.emotion-label {
  font-size: 12px;
  color: #8b6f47;
  font-weight: 500;
}

.risk-indicator {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  background: #28a745;
}

.risk-indicator.yellow {
  background: #ffc107;
}

.risk-indicator.red {
  background: #dc3545;
}

.history-stress {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 12px;
}

.stress-label {
  color: #a0886b;
  min-width: 30px;
}

.stress-bar {
  flex: 1;
  height: 6px;
  background: rgba(139, 111, 71, 0.1);
  border-radius: 3px;
  overflow: hidden;
}

.stress-fill {
  height: 100%;
  background: linear-gradient(90deg, #28a745 0%, #ffc107 50%, #dc3545 100%);
  border-radius: 3px;
  transition: width 0.3s ease;
}

.stress-value {
  color: #8b6f47;
  font-weight: 500;
  min-width: 25px;
}

.empty-history {
  text-align: center;
  color: #a0886b;
  margin-top: 50px;
}

.empty-history p {
  margin: 10px 0;
}

/* ç§»åŠ¨ç«¯å†å²åº“é€‚é… */
@media (max-width: 767px) {
  .messages-history {
    width: 100%;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
  }
}

/* å¼•å¯¼æç¤ºå¼¹çª—æ ·å¼ */
.guidance-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(8px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  animation: modalFadeIn 0.3s ease;
}

@keyframes modalFadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

.guidance-content {
  max-width: 400px;
  margin: 20px;
  padding: 40px 30px;
  text-align: center;
  border-radius: 20px;
  animation: modalSlideIn 0.3s ease;
}

@keyframes modalSlideIn {
  from {
    transform: translateY(-30px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

.guidance-icon {
  font-size: 48px;
  margin-bottom: 20px;
  animation: iconFloat 2s ease-in-out infinite;
}

@keyframes iconFloat {
  0%, 100% {
    transform: translateY(0);
  }
  50% {
    transform: translateY(-10px);
  }
}

.guidance-content h3 {
  color: #8b6f47;
  margin: 0 0 15px 0;
  font-size: 24px;
  font-weight: 300;
}

.guidance-main-text {
  color: #5d4e37;
  font-size: 18px;
  line-height: 1.6;
  margin: 0 0 10px 0;
  font-weight: 500;
}

.guidance-sub-text {
  color: #a0886b;
  font-size: 14px;
  margin: 0 0 30px 0;
  line-height: 1.5;
}

.guidance-close {
  background: linear-gradient(135deg, #8b6f47 0%, #a0886b 100%);
  color: white;
  border: none;
  border-radius: 50px;
  padding: 12px 30px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 20px rgba(139, 111, 71, 0.3);
}

.guidance-close:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 25px rgba(139, 111, 71, 0.4);
}

/* éšç§æç¤ºå¼¹çª—æ ·å¼ */
.privacy-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(8px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  animation: modalFadeIn 0.3s ease;
}

.privacy-content {
  max-width: 450px;
  margin: 20px;
  padding: 40px 30px;
  text-align: center;
  border-radius: 20px;
  animation: modalSlideIn 0.3s ease;
}

.privacy-icon {
  font-size: 48px;
  margin-bottom: 20px;
  animation: iconPulse 2s ease-in-out infinite;
}

@keyframes iconPulse {
  0%, 100% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.1);
  }
}

.privacy-content h3 {
  color: #8b6f47;
  margin: 0 0 15px 0;
  font-size: 24px;
  font-weight: 300;
}

.privacy-content p {
  color: #5d4e37;
  font-size: 16px;
  line-height: 1.6;
  margin: 0 0 25px 0;
}

.privacy-features {
  display: flex;
  flex-direction: column;
  gap: 15px;
  margin-bottom: 30px;
  text-align: left;
}

.feature-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  background: rgba(139, 111, 71, 0.05);
  border-radius: 10px;
  color: #5d4e37;
  font-size: 14px;
}

.feature-icon {
  font-size: 20px;
  width: 24px;
  text-align: center;
}

.privacy-close {
  background: linear-gradient(135deg, #8b6f47 0%, #a0886b 100%);
  color: white;
  border: none;
  border-radius: 50px;
  padding: 12px 30px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 20px rgba(139, 111, 71, 0.3);
}

.privacy-close:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 25px rgba(139, 111, 71, 0.4);
}

/* å±æœºå¹²é¢„è­¦å‘Šæ ·å¼ */
.crisis-intervention-warning {
  background: linear-gradient(135deg, 
    rgba(220, 53, 69, 0.1) 0%, 
    rgba(255, 193, 7, 0.05) 50%, 
    rgba(220, 53, 69, 0.1) 100%);
  border: 2px solid rgba(220, 53, 69, 0.3);
  border-radius: 15px;
  padding: 25px;
  margin: 20px 0;
  animation: urgentPulse 2s ease-in-out infinite;
}

.crisis-intervention-warning.high_risk {
  background: linear-gradient(135deg, 
    rgba(220, 53, 69, 0.15) 0%, 
    rgba(220, 53, 69, 0.1) 100%);
  border-color: rgba(220, 53, 69, 0.5);
  box-shadow: 0 0 20px rgba(220, 53, 69, 0.3);
}

@keyframes urgentPulse {
  0%, 100% {
    box-shadow: 0 0 20px rgba(220, 53, 69, 0.3);
  }
  50% {
    box-shadow: 0 0 30px rgba(220, 53, 69, 0.5);
  }
}

.crisis-header {
  display: flex;
  align-items: center;
  gap: 15px;
  margin-bottom: 20px;
}

.crisis-icon {
  font-size: 24px;
  animation: alertBounce 1s ease-in-out infinite;
}

@keyframes alertBounce {
  0%, 100% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.1);
  }
}

.crisis-header h4 {
  color: #dc3545;
  margin: 0;
  font-size: 18px;
  font-weight: 600;
}

.immediate-actions {
  background: rgba(255, 255, 255, 0.8);
  border-radius: 10px;
  padding: 15px;
  margin-bottom: 15px;
}

.immediate-actions h5 {
  color: #dc3545;
  margin: 0 0 10px 0;
  font-size: 16px;
  font-weight: 600;
}

.immediate-actions ul {
  margin: 0;
  padding-left: 20px;
}

.immediate-actions li {
  color: #5d4e37;
  margin-bottom: 8px;
  font-weight: 500;
}

.crisis-resources {
  background: rgba(255, 255, 255, 0.9);
  border-radius: 10px;
  padding: 15px;
}

.crisis-resources h5 {
  color: #dc3545;
  margin: 0 0 15px 0;
  font-size: 16px;
  font-weight: 600;
}

.hotline-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.hotline-item {
  background: rgba(40, 167, 69, 0.05);
  border: 1px solid rgba(40, 167, 69, 0.2);
  border-radius: 8px;
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.hotline-name {
  font-weight: 600;
  color: #28a745;
  font-size: 14px;
}

.hotline-phone {
  color: #dc3545;
  text-decoration: none;
  font-weight: 600;
  font-size: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.hotline-phone:hover {
  color: #c82333;
  text-decoration: underline;
}

.hotline-time {
  color: #6c757d;
  font-size: 12px;
}

.emergency-contacts {
  margin-top: 15px;
}

.emergency-contacts h6 {
  color: #dc3545;
  margin: 0 0 10px 0;
  font-size: 14px;
  font-weight: 600;
}

.emergency-item {
  margin-bottom: 8px;
}

.emergency-phone {
  color: #dc3545;
  text-decoration: none;
  font-weight: 600;
  font-size: 14px;
  display: inline-block;
  padding: 6px 12px;
  background: rgba(220, 53, 69, 0.1);
  border-radius: 20px;
  transition: all 0.2s ease;
}

.emergency-phone:hover {
  background: rgba(220, 53, 69, 0.2);
  color: #c82333;
}

/* æƒ…ç»ªæŠ¥å‘Šå¡ç‰‡æ ·å¼ */
.emotion-report-card {
  background: rgba(139, 111, 71, 0.05);
  border-radius: 15px;
  padding: 20px;
  margin: 20px 0;
  border: 1px solid rgba(139, 111, 71, 0.1);
}

.emotion-report-card h4 {
  color: #8b6f47;
  margin: 0 0 15px 0;
  font-size: 16px;
  font-weight: 600;
}

.stress-indicator-large {
  display: flex;
  align-items: center;
  gap: 15px;
  margin-bottom: 15px;
}

.stress-label {
  color: #5d4e37;
  font-weight: 500;
}

.stress-circle {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  color: white;
  position: relative;
}

.stress-circle.low {
  background: linear-gradient(135deg, #28a745, #20c997);
}

.stress-circle.medium {
  background: linear-gradient(135deg, #ffc107, #fd7e14);
}

.stress-circle.high {
  background: linear-gradient(135deg, #dc3545, #e83e8c);
}

.stress-number {
  font-size: 18px;
}

.main-emotions {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.emotion-tag {
  background: rgba(139, 111, 71, 0.1);
  color: #8b6f47;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 500;
}

/* æƒ…ç»ªé›·è¾¾å›¾æ ·å¼ */
.emotion-radar {
  margin-top: 20px;
  text-align: center;
}

.emotion-radar h5 {
  color: #8b6f47;
  margin: 0 0 15px 0;
  font-size: 14px;
  font-weight: 600;
}

.emotion-radar canvas {
  background: rgba(255, 255, 255, 0.5);
  border-radius: 10px;
  backdrop-filter: blur(5px);
}

/* å¾®ä»»åŠ¡æ ·å¼ */
.micro-tasks {
  background: rgba(40, 167, 69, 0.05);
  border-radius: 15px;
  padding: 20px;
  margin: 20px 0;
  border: 1px solid rgba(40, 167, 69, 0.1);
}

.micro-tasks h4 {
  color: #28a745;
  margin: 0 0 15px 0;
  font-size: 16px;
  font-weight: 600;
}

.task-buttons {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.task-button {
  background: rgba(40, 167, 69, 0.1);
  border: 1px solid rgba(40, 167, 69, 0.3);
  border-radius: 25px;
  padding: 12px 20px;
  color: #28a745;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 14px;
  text-align: left;
}

.task-button:hover {
  background: rgba(40, 167, 69, 0.2);
  transform: translateX(5px);
}

.task-button.completed {
  background: #28a745;
  color: white;
  border-color: #28a745;
}

/* èµ„æºé“¾æ¥æ ·å¼ */
.resource-links {
  background: rgba(0, 123, 255, 0.05);
  border-radius: 15px;
  padding: 20px;
  margin: 20px 0;
  border: 1px solid rgba(0, 123, 255, 0.1);
}

.resource-links h4 {
  color: #007bff;
  margin: 0 0 15px 0;
  font-size: 16px;
  font-weight: 600;
}

.link-buttons {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.resource-button {
  background: rgba(0, 123, 255, 0.1);
  border: 1px solid rgba(0, 123, 255, 0.3);
  border-radius: 25px;
  padding: 12px 20px;
  color: #007bff;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 14px;
  text-align: left;
}

.resource-button:hover {
  background: rgba(0, 123, 255, 0.2);
  transform: translateX(5px);
}

/* æŒ‰é’®å†…å®¹è¿‡æ¸¡ */
.button-content-enter-active,
.button-content-leave-active {
  transition: all 0.3s ease;
}

.button-content-enter-from {
  opacity: 0;
  transform: translateY(10px);
}

.button-content-leave-to {
  opacity: 0;
  transform: translateY(-10px);
}

/* å›ä¿¡æµ®çª—æ ·å¼ */
.modal-fade-enter-active, 
.modal-fade-leave-active {
  transition: opacity 0.3s ease;
}

.modal-fade-enter-from, 
.modal-fade-leave-to {
  opacity: 0;
}

.reply-modal-backdrop {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  backdrop-filter: blur(5px);
}

.reply-modal {
  width: 95%;
  max-width: 1200px;
  max-height: 85vh;
  background: linear-gradient(135deg, #fefcf8 0%, #f8f5f0 100%);
  border-radius: 20px;
  box-shadow: 
    0 15px 35px rgba(0, 0, 0, 0.1),
    0 5px 15px rgba(0, 0, 0, 0.08),
    0 20px 60px rgba(139, 111, 71, 0.3),
    inset 0 1px 0 rgba(255, 255, 255, 0.8);
  overflow: hidden;
  transform: scale(1);
  transition: transform 0.3s ease;
  position: relative;
}

.reply-modal:hover {
  transform: scale(1.02);
}

/* æ–°å¢ï¼šå·¦å³åˆ†æ å¸ƒå±€æ ·å¼ */
.modal-content-wrapper {
  display: flex;
  height: calc(100% - 80px); /* å‡å»headeré«˜åº¦ */
  max-height: 70vh;
}

.teacher-video-section {
  flex: 0 0 350px;
  background: linear-gradient(135deg, #e8f4f8 0%, #d1ecf1 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0;
  border-right: 2px solid rgba(139, 111, 71, 0.1);
  position: relative;
  overflow: hidden;
}

.teacher-video {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border: none;
  border-radius: 0;
}

.letter-content-section {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  background: linear-gradient(135deg, #fefcf8 0%, #f8f5f0 100%);
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 1024px) {
  .modal-content-wrapper {
    flex-direction: column;
    height: auto;
    max-height: 80vh;
  }
  
  .teacher-video-section {
    flex: 0 0 200px;
    border-right: none;
    border-bottom: 2px solid rgba(139, 111, 71, 0.1);
  }
  
  .letter-content-section {
    flex: 1;
    min-height: 300px;
  }
}

@media (max-width: 768px) {
  .reply-modal {
    width: 98%;
    max-height: 90vh;
  }
  
  .teacher-video-section {
    flex: 0 0 150px;
  }
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 25px;
  border-bottom: 2px solid rgba(139, 111, 71, 0.1);
  background: linear-gradient(135deg, #f8f5f0 0%, #f0e6d2 100%);
}

.modal-header h3 {
  margin: 0;
  color: #8b6f47;
  font-size: 20px;
  font-weight: 600;
  font-family: 'æ¥·ä½“', 'KaiTi', serif;
}

.modal-controls {
  display: flex;
  align-items: center;
  gap: 12px;
}

.speech-control-btn {
  background: linear-gradient(135deg, #e8dcc0 0%, #d4c3a0 100%);
  border: 2px solid rgba(139, 111, 71, 0.3);
  border-radius: 50%;
  width: 42px;
  height: 42px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 18px;
  box-shadow: 0 2px 6px rgba(139, 111, 71, 0.15);
}

.speech-control-btn:hover {
  background: linear-gradient(135deg, #d4c3a0 0%, #c2b088 100%);
  border-color: rgba(139, 111, 71, 0.5);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(139, 111, 71, 0.25);
}

.speech-control-btn.speaking {
  background: linear-gradient(135deg, #98d982 0%, #7bc96b 100%);
  border-color: rgba(67, 160, 71, 0.5);
  animation: speakingPulse 1.5s ease-in-out infinite alternate;
}

.speech-control-btn.paused {
  background: linear-gradient(135deg, #ffb74d 0%, #ff9800 100%);
  border-color: rgba(255, 152, 0, 0.5);
}

@keyframes speakingPulse {
  0% {
    box-shadow: 0 2px 6px rgba(67, 160, 71, 0.3);
  }
  100% {
    box-shadow: 0 4px 16px rgba(67, 160, 71, 0.6);
  }
}

.modal-close {
  background: none;
  border: none;
  font-size: 28px;
  color: #8b6f47;
  cursor: pointer;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
}

.modal-close:hover {
  background: rgba(139, 111, 71, 0.1);
  transform: rotate(90deg);
}

.modal-content {
  padding: 25px;
  max-height: 60vh;
  overflow-y: auto;
}

.modal-content::-webkit-scrollbar {
  width: 8px;
}

.modal-content::-webkit-scrollbar-track {
  background: rgba(139, 111, 71, 0.1);
  border-radius: 4px;
}

.modal-content::-webkit-scrollbar-thumb {
  background: rgba(139, 111, 71, 0.3);
  border-radius: 4px;
}

.modal-content::-webkit-scrollbar-thumb:hover {
  background: rgba(139, 111, 71, 0.5);
}

/* ä¿¡å°æç¤ºæ ·å¼ */
.envelope-hint {
  font-size: 12px;
  color: #8b6f47;
  opacity: 0.8;
  margin-top: 5px;
  font-style: italic;
}

.letter-envelope:hover .envelope-hint {
  opacity: 1;
  color: #d4af37;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .reply-modal {
    width: 95%;
    max-height: 85vh;
  }
  
  .modal-header {
    padding: 15px 20px;
  }
  
  .modal-header h3 {
    font-size: 18px;
  }
  
  .modal-content {
    padding: 20px;
    max-height: 65vh;
  }
}
</style>

