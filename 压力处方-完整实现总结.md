# 压力处方功能 - 完整实现总结

## ✅ 已完成的功能

### 🎯 核心功能
使用 DeepSeek AI 大模型分析用户压力来源并生成个性化的压力处方。

---

## 📁 创建/修改的文件

### 后端文件

#### 1. `backend/app/core/config.py` ✏️ 修改
- 添加 `DEEPSEEK_API_KEY` 配置
- 添加 `DEEPSEEK_BASE_URL` 配置

#### 2. `backend/app/services/stress_analysis.py` ⭐ 新建
**核心功能：**
- `analyze_stress_sources()` - 分析 4 种压力来源
- `generate_stress_prescription_stream()` - 流式生成处方

**压力来源算法：**
```python
1. DDL 任务压力（权重 40%）
   - 基于日历中的 DDL 紧张分数

2. 睡眠不足压力（权重 25%）
   - 理想睡眠 7-8 小时
   - < 6小时或 > 9小时计算压力

3. 考研倒计时焦虑（权重 20%）
   - 剩余 ≤ 30天: 90分
   - 剩余 ≤ 90天: 70分
   - 剩余 ≤ 180天: 50分
   - 剩余 > 180天: 30分

4. 心理情绪压力（权重 15%）
   - 基于最近的情绪记录
   - 压力等级 1-10 转换为 0-100
```

**主要压力源选择：**
- 按分数排序
- 选择最高的 1-2 个
- 分数必须 > 30

#### 3. `backend/app/routers/stress_prescription.py` ⭐ 新建
**API 端点：**
- `POST /api/v1/stress-prescription/generate` - 生成压力处方（流式）

**数据收集：**
1. 查询未来 DDL 的平均紧张分数
2. 获取最近的睡眠记录
3. 计算距离考研天数
4. 获取最近的情绪压力等级

**返回格式：** Server-Sent Events (SSE)
```
data: {"type":"analysis","data":{...}}
data: {"type":"prescription","content":"..."}
data: [DONE]
```

#### 4. `backend/app/main.py` ✏️ 修改
- 导入 `stress_prescription` 路由
- 注册路由：`/api/v1/stress-prescription`

#### 5. `backend/requirements.txt` ✏️ 修改
- 添加 `httpx==0.25.0` 依赖

---

### 前端文件

#### 1. `frontend/src/views/StressRadarView.vue` ✏️ 大幅修改

**模板部分（Template）：**
- 添加处方生成按钮（禁用状态支持）
- 添加压力处方显示区域
  - 压力来源分析（彩色进度条）
  - AI 生成的处方内容
  - 流式打字效果

**逻辑部分（Script）：**
- `isGenerating` - 生成状态标志
- `showPrescription` - 显示处方区域
- `prescriptionData` - 存储分析数据和处方文本
- `generatePrescription()` - 调用 API 并流式接收
- `closePrescription()` - 关闭处方显示
- `getSourceColor()` - 压力源颜色映射

**样式部分（Style）：**
- 按钮增强样式（悬停、禁用）
- 压力处方卡片样式
- 压力来源进度条样式
- AI 处方内容样式
- 打字光标动画

---

### 文档文件

#### 1. `压力处方功能说明.md` ⭐ 新建
- 功能概述
- 4 维度压力分析
- AI 分析流程
- 使用示例
- 故障排查

#### 2. `DeepSeek配置说明.md` ⭐ 新建
- API Key 获取步骤
- 配置方法
- 验证测试
- 常见问题
- 安全提示

---

## 🔄 数据流程

```
用户点击"生成压力处方"
    ↓
前端发起 POST 请求
    ↓
后端收集数据
├── 查询 DDL 紧张分数（calendar_notes）
├── 查询睡眠记录（sleep_entries）
├── 查询考研日期（users.exam_date）
└── 查询情绪记录（mood_entries）
    ↓
计算各维度压力分数
├── DDL 压力（权重 40%）
├── 睡眠压力（权重 25%）
├── 倒计时焦虑（权重 20%）
└── 情绪压力（权重 15%）
    ↓
选择主要压力源（1-2个，分数>30）
    ↓
构建 AI Prompt
    ↓
调用 DeepSeek API（流式）
    ↓
后端流式返回 SSE
├── 先发送压力分析数据
└── 逐字发送 AI 生成的处方
    ↓
前端流式接收和显示
├── 显示压力来源进度条
├── 逐字显示 AI 处方文本
└── 显示打字光标动画
```

---

## 🎨 界面展示

### 压力处方结果

```
┌──────────────────────────────────────────┐
│  📋 压力处方分析                    [×] │
├──────────────────────────────────────────┤
│                                          │
│  【压力来源分析】                         │
│  ┌────────────────────────────────────┐ │
│  │  DDL任务压力                       │ │
│  │  ████████████████░░░░ 75分        │ │
│  │                                    │ │
│  │  考研倒计时焦虑                    │ │
│  │  ████████████░░░░░░░░ 60分        │ │
│  │                                    │ │
│  │  总体压力指数: 71.5/100            │ │
│  └────────────────────────────────────┘ │
│                                          │
│  【🔮 AI 处方建议】                      │
│  ┌────────────────────────────────────┐ │
│  │ 【压力诊断】                       │ │
│  │ 您当前主要压力来自DDL任务的...     │ │
│  │                                    │ │
│  │ 【具体建议】                       │ │
│  │ 1. 优先处理红色和褐色任务...       │ │
│  │ 2. 制定每日任务清单...             │ │
│  │ 3. 合理安排休息时间...             │ │
│  │                                    │ │
│  │ 【鼓励的话】                       │ │
│  │ 您已经在正确的轨道上...      |     │ │
│  └────────────────────────────────────┘ │
└──────────────────────────────────────────┘
```

---

## 🚀 使用流程

### 1. 配置 API Key（首次）

```bash
# 1. 创建 .env 文件
cd backend
nano .env  # 或用其他编辑器

# 2. 添加配置
DEEPSEEK_API_KEY=sk-your-key-here
DEEPSEEK_BASE_URL=https://api.deepseek.com

# 3. 安装依赖
pip install httpx

# 4. 重启后端
python run_server.py
```

### 2. 准备数据

在系统中添加一些数据：
- ✅ 在日历上标注几个任务（设置进度）
- ✅ 记录睡眠时长
- ✅ 设置考研日期
- ✅ 记录情绪状态

### 3. 生成压力处方

1. 进入"压力雷达"页面
2. 浏览日历和数据
3. 点击底部的"一键生成压力处方"按钮
4. 等待 10-30 秒
5. 查看 AI 生成的分析和建议

---

## 📊 压力分析示例

### 场景 1：DDL 压力为主

**数据：**
- DDL 平均分数：78
- 睡眠：7 小时
- 考研剩余：100 天
- 情绪压力：6/10

**分析结果：**
```
主要压力源：
1. DDL任务压力: 78分 ⭐⭐
2. 考研倒计时焦虑: 50分

总体压力: 67.8/100
```

**AI 处方：**
> 您当前主要压力来自多个临近的 DDL 任务。建议：
> 1. 优先处理高紧张分数（红色、褐色）的任务
> 2. 使用番茄工作法提升专注力
> 3. 每完成一个小目标就更新进度，增加成就感
> 
> 好消息是您的睡眠状况良好，继续保持！

---

### 场景 2：睡眠不足为主

**数据：**
- DDL 平均分数：35
- 睡眠：4.5 小时
- 考研剩余：150 天
- 情绪压力：8/10

**分析结果：**
```
主要压力源：
1. 睡眠质量压力: 83分 ⭐⭐
2. 心理情绪压力: 78分

总体压力: 72.5/100
```

**AI 处方：**
> 您的主要压力来源是严重的睡眠不足。这会影响学习效率和情绪稳定。建议：
> 1. 立即调整作息，确保每晚 7-8 小时睡眠
> 2. 睡前 1 小时不看手机，可以听轻音乐放松
> 3. 学习任务要提高白天效率，不要靠熬夜
> 
> 充足的睡眠是成功的基础，先照顾好自己！

---

## 🎯 技术特点

### 1. 智能权重分配
- 不同压力源有不同权重
- DDL 任务权重最高（40%）
- 综合评估更科学

### 2. 主要压力源识别
- 自动选择最突出的 1-2 个
- 过滤低分压力源（< 30）
- AI 分析更有针对性

### 3. 流式输出
- 使用 SSE (Server-Sent Events)
- 实时显示生成过程
- 打字机效果
- 用户体验更好

### 4. 可视化展示
- 彩色进度条显示各压力源
- 清晰的分数对比
- 总体压力指数

---

## 🔧 调试指南

### 后端调试

```bash
# 查看后端日志
cd backend
python run_server.py

# 应该看到
Starting server on http://0.0.0.0:8000
```

### 前端调试

打开浏览器控制台（F12）：
```javascript
// 应该看到
生成压力处方...
接收到分析数据: {...}
接收到处方片段: "【"
接收到处方片段: "压力"
...
```

### API 测试

使用 curl 测试：
```bash
curl -X POST "http://localhost:8000/api/v1/stress-prescription/generate" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

---

## 📝 待办事项

如果要进一步优化：

- [ ] 添加处方历史记录
- [ ] 支持导出 PDF
- [ ] 添加分享功能
- [ ] 支持更多 AI 模型选择
- [ ] 添加处方执行追踪

---

## ✨ 总结

### 完成的功能

✅ **后端实现：**
- 4 维度压力分析算法
- DeepSeek API 集成
- 流式输出支持
- 完整的 API 端点

✅ **前端实现：**
- 流式接收和显示
- 美观的 UI 展示
- 打字机效果
- 压力来源可视化

✅ **配置和文档：**
- API 配置说明
- 使用指南
- 调试指南

### 使用前准备

1. ✅ 配置 DeepSeek API Key（见 `DeepSeek配置说明.md`）
2. ✅ 安装 httpx 依赖（`pip install httpx`）
3. ✅ 重启后端服务
4. ✅ 在系统中添加一些数据（任务、睡眠、情绪）

### 开始使用

进入"压力雷达"页面 → 点击"一键生成压力处方" → 查看 AI 分析 🎉

---

**功能已完全实现，可以开始测试了！** 🚀✨

