# 压力处方功能说明

## 🎯 功能概述

使用 DeepSeek AI 大模型分析用户的压力来源，并生成个性化的压力处方建议。

---

## 📊 压力来源分析（4个维度）

系统会自动分析以下 4 种压力来源，并选择最主要的 1-2 个：

### 1. DDL 任务压力（权重 40%）
- **数据来源：** 日历中未来 7 天内的 DDL 紧张分数
- **计算方法：** 平均紧张分数
- **影响因素：** 
  - 任务数量
  - 剩余时间
  - 完成进度

### 2. 睡眠不足压力（权重 25%）
- **数据来源：** 最近记录的睡眠时长
- **计算方法：**
  ```
  < 6小时：压力 = (6 - 实际睡眠) / 6 × 100
  7-8小时：压力 = 0（理想状态）
  > 9小时：压力 = (实际睡眠 - 9) / 3 × 50
  ```
- **理想睡眠：** 7-8 小时

### 3. 考研倒计时焦虑（权重 20%）
- **数据来源：** 用户设置的考研日期
- **计算方法：**
  ```
  剩余 ≤ 30天：  焦虑 90 分
  剩余 ≤ 90天：  焦虑 70 分
  剩余 ≤ 180天： 焦虑 50 分
  剩余 > 180天： 焦虑 30 分
  ```

### 4. 心理情绪压力（权重 15%）
- **数据来源：** 最近的情绪记录
- **计算方法：** (压力等级 - 1) / 9 × 100
- **范围：** 1-10 级

---

## 🔮 AI 分析流程

```
步骤 1: 收集数据
  ├── DDL 紧张分数
  ├── 睡眠时长
  ├── 考研倒计时
  └── 情绪压力等级

步骤 2: 计算各维度压力
  ├── 计算加权分数
  ├── 排序找出主要压力源
  └── 选择 1-2 个最高的（分数 > 30）

步骤 3: 调用 DeepSeek AI
  ├── 构建分析 prompt
  ├── 流式生成处方
  └── 实时显示结果

步骤 4: 生成处方
  ├── 压力诊断
  ├── 具体建议（2-3条）
  └── 鼓励的话
```

---

## 🎨 前端展示

### 压力来源分析区域
```
┌─────────────────────────────────┐
│  压力来源分析                    │
├─────────────────────────────────┤
│  DDL任务压力                     │
│  ████████████████░░░░ 75分      │
│                                  │
│  睡眠质量压力                    │
│  ████████░░░░░░░░░░░ 42分      │
│                                  │
│  总体压力指数: 62.5/100          │
└─────────────────────────────────┘
```

### AI 处方建议区域
```
┌─────────────────────────────────┐
│  🔮 AI 处方建议                  │
├─────────────────────────────────┤
│  【压力诊断】                    │
│  您当前主要压力来自DDL任务...    │
│  (流式输出，逐字显示)            │
│                                  │
│  【具体建议】                    │
│  1. ...                          │
│  2. ...                          │
│                                  │
│  【鼓励的话】                    │
│  ...                             │
└─────────────────────────────────┘
```

---

## 🔧 配置说明

### 1. 设置 DeepSeek API Key

编辑 `backend/.env` 文件（如果不存在，创建它）：

```bash
DEEPSEEK_API_KEY=sk-your-api-key-here
DEEPSEEK_BASE_URL=https://api.deepseek.com
```

### 2. 获取 API Key

1. 访问 [DeepSeek 官网](https://platform.deepseek.com/)
2. 注册/登录账号
3. 创建 API Key
4. 复制到 `.env` 文件中

### 3. 安装依赖

如果缺少 `httpx`：
```bash
cd backend
pip install httpx
```

---

## 📋 API 接口

### POST /api/v1/stress-prescription/generate

**功能：** 生成压力处方（流式输出）

**请求：**
```bash
curl -X POST "http://localhost:8000/api/v1/stress-prescription/generate" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**响应：** Server-Sent Events (SSE) 流

```
data: {"type":"analysis","data":{...}}

data: {"type":"prescription","content":"【"}

data: {"type":"prescription","content":"压力"}

data: {"type":"prescription","content":"诊断"}

...

data: [DONE]
```

---

## 💻 前端使用

### 按钮触发
```vue
<button @click="generatePrescription">
  一键生成压力处方
</button>
```

### 流式接收
```javascript
const response = await fetch('/stress-prescription/generate', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${token}`
  }
})

const reader = response.body.getReader()
const decoder = new TextDecoder()

while (true) {
  const { done, value } = await reader.read()
  if (done) break
  
  const chunk = decoder.decode(value)
  // 处理接收到的数据
}
```

---

## 🎯 压力处方示例

### 示例 1：DDL 压力为主

**输入数据：**
- DDL 平均分数：75
- 睡眠时长：7小时
- 距离考研：120天
- 情绪压力：5/10

**AI 生成处方：**
```
【压力诊断】
您当前主要压力来自多个 DDL 任务的临近，整体压力指数较高。
不过您的睡眠质量尚可，这是一个积极信号。

【具体建议】
1. 优先处理红色和褐色的紧急任务，使用番茄工作法提升效率
2. 将大任务拆分成小目标，每完成一个就更新进度，增加成就感
3. 每天制定清晰的任务清单，按优先级逐个攻破

【鼓励的话】
您已经在正确的轨道上，保持当前的睡眠习惯，继续加油！
```

### 示例 2：睡眠不足为主

**输入数据：**
- DDL 平均分数：40
- 睡眠时长：5小时
- 距离考研：150天
- 情绪压力：7/10

**AI 生成处方：**
```
【压力诊断】
您的主要压力来源是睡眠不足，这会严重影响学习效率和情绪状态。

【具体建议】
1. 调整作息时间，确保每晚至少 7 小时睡眠
2. 睡前 1 小时避免使用电子设备，可以听舒缓音乐
3. 如果学习任务多，提高白天效率而不是牺牲睡眠

【鼓励的话】
良好的睡眠是高效学习的基础，照顾好自己才能走得更远！
```

---

## 🐛 故障排查

### 问题 1：点击按钮无反应

**检查：**
1. 是否已登录？
2. 浏览器控制台是否有错误？
3. 后端服务是否正常运行？

### 问题 2：提示 API Key 未配置

**解决：**
```bash
# 编辑 backend/.env
DEEPSEEK_API_KEY=sk-your-key-here

# 重启后端
cd backend
python run_server.py
```

### 问题 3：生成速度慢

**原因：** AI 模型生成需要时间  
**正常情况：** 10-30 秒  
**优化：** 使用流式输出，可以实时看到生成过程

---

## ✨ 功能特点

- ✅ **智能分析**：4 维度综合评估
- ✅ **个性化**：根据用户实际数据生成
- ✅ **流式输出**：逐字显示，体验更好
- ✅ **实用建议**：具体可行的改进方案
- ✅ **视觉化**：彩色进度条展示压力来源

---

## 🚀 使用流程

1. 在压力雷达页面浏览数据
2. 点击"一键生成压力处方"按钮
3. 等待 AI 分析（5-15 秒）
4. 查看压力来源和 AI 建议
5. 根据建议调整学习计划

---

**注意：** 需要在 `.env` 文件中配置 DeepSeek API Key 才能使用此功能。

